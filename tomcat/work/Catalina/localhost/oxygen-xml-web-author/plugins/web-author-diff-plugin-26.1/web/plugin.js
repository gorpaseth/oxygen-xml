(()=>{sync.diff||(sync.diff={});(function(){var t={DIFF:{en_US:"Diff",fr_FR:"Comparaison",ja_JP:"\u6BD4\u8F03",zh_CN:"\u5DEE\u5F02"},CLOSE_:{en_US:"Close",de_DE:"Schlie\xDFen",fr_FR:"Fermer",ja_JP:"\u9589\u3058\u308B",nl_NL:"Sluit",zh_CN:"\u5173\u95ED"},MERGE:{en_US:"Merge",de_DE:"Zusammenf\xFChren",fr_FR:"Fusionner",ja_JP:"\u30DE\u30FC\u30B8",nl_NL:"Voeg samen",zh_CN:"\u5408\u5E76"},YOUR_VERSION_:{en_US:"Your version",de_DE:"Ihre Version",fr_FR:"Votre version",ja_JP:"\u304A\u4F7F\u3044\u306E\u30D0\u30FC\u30B8\u30E7\u30F3",nl_NL:"Uw versie",zh_CN:"\u60A8\u7684\u7248\u672C"},LATEST_VERSION_:{en_US:"Latest version",de_DE:"Letzte Version",fr_FR:"Derni\xE8re version",ja_JP:"\u6700\u65B0\u306E\u30D0\u30FC\u30B8\u30E7\u30F3",nl_NL:"Nieuwste versie",zh_CN:"\u6700\u65B0\u7248\u672C"},APPLY_PROPOSED_CHANGES:{en_US:"Apply proposed changes",de_DE:"Vorgeschlagene \xC4nderungen anwenden",fr_FR:"Appliquer les modifications propos\xE9es",ja_JP:"\u63D0\u6848\u3055\u308C\u305F\u5909\u66F4\u3092\u9069\u7528\u3059\u308B",nl_NL:"Voorgestelde wijzigingen toepassen",zh_CN:"\u5E94\u7528\u5EFA\u8BAE\u7684\u66F4\u6539"},PREVIEW:{en_US:"Preview",de_DE:"Vorschau",fr_FR:"Aper\xE7u",ja_JP:"\u30D7\u30EC\u30D3\u30E5\u30FC",nl_NL:"Voorvertoning",zh_CN:"\u9884\u89C8"},APPLY_YOUR_CHANGES:{en_US:"Apply your changes",de_DE:"Ihre \xC4nderungen anwenden",fr_FR:"Appliquer vos modifications",ja_JP:"\u3042\u306A\u305F\u306E\u5909\u66F4\u3092\u9069\u7528\u3059\u308B",nl_NL:"Pas uw wijzigingen toe",zh_CN:"\u5E94\u7528\u60A8\u7684\u66F4\u6539"},SNAPSHOT_HINT_:{en_US:"{$document} (snapshot)",de_DE:"{$document} (Momentaufnahme)",ja_JP:"{$document} (\u30B9\u30CA\u30C3\u30D7\u30B7\u30E7\u30C3\u30C8)",nl_NL:"{$document} (momentopname)",zh_CN:"{$document} (\u5FEB\u7167)"},ERROR_:{en_US:"Error",de_DE:"Fehler",fr_FR:"Erreur",ja_JP:"\u30A8\u30E9\u30FC",nl_NL:"Fout",zh_CN:"\u9519\u8BEF"},COMPARE_WITH_OTHER_FILE_:{en_US:"Compare current document with another document",de_DE:"Vergleiche aktuelles Dokument mit einem anderen Dokument",fr_FR:"Compare le document actuel avec un autre document",ja_JP:"\u73FE\u5728\u306E\u30C9\u30AD\u30E5\u30E1\u30F3\u30C8\u3068\u5225\u306A\u30D5\u30A1\u30A4\u30EB\u3092\u6BD4\u8F03\u3059\u308B",nl_NL:"Huidig document vergelijken met een ander document",zh_CN:"\u5C07\u7576\u524D\u6587\u6A94\u8207\u53E6\u4E00\u500B\u6587\u6A94\u9032\u884C\u6BD4\u8F03"},LATEST_FROM_REPOSITORY_:{en_US:"Latest version from repository",de_DE:"Letzte Version aus dem Repository",fr_FR:"Derni\xE8re version du d\xE9p\xF4t",ja_JP:"\u30EA\u30DD\u30B8\u30C8\u30EA\u304B\u3089\u306E\u6700\u65B0\u30D0\u30FC\u30B8\u30E7\u30F3",nl_NL:"Nieuwste versie uit opslagplaats",zh_CN:"\u6765\u81EA\u5B58\u50A8\u5E93\u7684\u6700\u65B0\u7248\u672C"},COPY_ALL_CHANGES_FROM_RIGHT_TO_LEFT:{en_US:"Copy All Changes from Right to Left",de_DE:"Alle \xC4nderungen von rechts nach links kopieren",fr_FR:"Copier toutes les modifications de la droite vers la gauche",ja_JP:"\u3059\u3079\u3066\u306E\u5909\u66F4\u3092\u53F3\u304B\u3089\u5DE6\u306B\u30B3\u30D4\u30FC",nl_NL:"Kopieer alle wijzigingen van rechts naar links",zh_CN:"\u4ECE\u53F3\u5411\u5DE6\u590D\u5236\u6240\u6709\u66F4\u6539"},COPY_ALL_NONCONFLICTING_CHANGES_FROM_RIGHT_TO_LEFT:{en_US:"Copy All Non-Conflicting Changes from Right to Left",de_DE:"Kopiere alle nicht konfliktbelasteten \xC4nderungen von rechts nach links",fr_FR:"Copier toutes les modifications non-conflictuelles de droite \xE0 gauche",ja_JP:"\u3059\u3079\u3066\u306E\u7AF6\u5408\u3057\u306A\u3044\u5909\u66F4\u3092\u53F3\u304B\u3089\u5DE6\u306B\u30B3\u30D4\u30FC",nl_NL:"Kopieer alle niet-conflicterende wijzigingen van rechts naar links",zh_CN:"\u4ECE\u53F3\u5411\u5DE6\u590D\u5236\u6240\u6709\u4E0D\u51B2\u7A81\u7684\u66F4\u6539"},COPY_CHANGE_FROM_RIGHT_TO_LEFT:{en_US:"Copy Change from Right to Left",de_DE:"Kopiere \xC4nderungen von rechts nach links",fr_FR:"Copier les modifications de droite \xE0 gauche",ja_JP:"\u53F3\u304B\u3089\u5DE6\u306B\u5909\u66F4\u3092\u30B3\u30D4\u30FC",nl_NL:"Kopieer wijziging van rechts naar links",zh_CN:"\u4ECE\u53F3\u5411\u5DE6\u590D\u5236\u66F4\u6539"},OTHER_FILE_:{en_US:"Another file...",de_DE:"Eine andere Datei",fr_FR:"Un autre fichier...",ja_JP:"\u5225\u306A\u30D5\u30A1\u30A4\u30EB...",nl_NL:"Ander bestand...",zh_CN:"\u53E6\u4E00\u4E2A\u6587\u4EF6..."},COMPARE_WITH_:{en_US:"Compare with",de_DE:"Vergleichen mit",fr_FR:"Comparer avec",ja_JP:"\u6B21\u3068\u6BD4\u8F03",nl_NL:"Vergelijk met",zh_CN:"\u4E0E\u4E4B\u6BD4\u8F83"},COMPARE_WITH_ANOTHER_FILE_:{en_US:"Compare with another file...",de_DE:"Vergleiche mit einer anderen Datei...",fr_FR:"Comparer avec un autre fichier...",ja_JP:"\u5225\u306E\u30D5\u30A1\u30A4\u30EB\u3068\u6BD4\u8F03\u3059\u308B...",nl_NL:"Vergelijk met een ander bestand...",zh_CN:"\u4E0E\u5176\u4ED6\u6587\u4EF6\u6BD4\u8F83..."},NEXT_BLOCK_:{en_US:"Next Block of Changes",de_DE:"N\xE4chster Block mit \xC4nderungen",fr_FR:"Bloc de modifications suivant",ja_JP:"\u5909\u66F4\u306E\u6B21\u306E\u30D6\u30ED\u30C3\u30AF",nl_NL:"Volgende blok wijzigingen",zh_CN:"\u4E0B\u4E00\u4E2A\u66F4\u6539\u5757"},PREVIOUS_BLOCK_:{en_US:"Previous Block of Changes",de_DE:"Vorheriger Block mit \xC4nderungen",fr_FR:"Bloc de modifications pr\xE9c\xE9dent",ja_JP:"\u5909\u66F4\u306E\u524D\u306E\u30D6\u30ED\u30C3\u30AF",nl_NL:"Vorige blok wijzigingen",zh_CN:"\u4E0A\u4E00\u4E2A\u66F4\u6539\u5757"},NEXT_CHANGE_:{en_US:"Next Change",de_DE:"N\xE4chste \xC4nderung",fr_FR:"Modification suivante",ja_JP:"\u6B21\u306E\u5909\u66F4",nl_NL:"Volgende wijziging",zh_CN:"\u4E0B\u4E00\u4E2A\u66F4\u6539"},PREVIOUS_CHANGE_:{en_US:"Previous Change",de_DE:"Vorherige \xC4nderung",fr_FR:"Modification pr\xE9c\xE9dente",ja_JP:"\u524D\u306E\u5909\u66F4",nl_NL:"Vorige wijziging",zh_CN:"\u4E0A\u4E00\u4E2A\u66F4\u6539"},TAGS_DISPLAY_MODE_:{en_US:"Tags display mode",de_DE:"Tags-Anzeigemodus",fr_FR:"Mode d'affichage des balises",ja_JP:"\u30BF\u30B0\u306E\u8868\u793A\u30E2\u30FC\u30C9",nl_NL:"Tags weergavemodus",zh_CN:"\u6807\u8BB0\u663E\u793A\u6A21\u5F0F"},FULL_TAGS_WITH_ATTRIBUTES_:{en_US:"Full Tags with Attributes",de_DE:"Ganze Tags mit Attributen",fr_FR:"Toutes les balises avec attributs",ja_JP:"\u5C5E\u6027\u3092\u5099\u3048\u305F\u30D5\u30EB \u30BF\u30B0",nl_NL:"Volledige tags met attributen",zh_CN:"\u5E26\u5C5E\u6027\u7684\u5B8C\u6574\u6807\u8BB0"},FULL_TAGS_:{en_US:"Full Tags",de_DE:"Ganze Tags",fr_FR:"Toutes les balises",ja_JP:"\u30D5\u30EB \u30BF\u30B0",nl_NL:"Volledige tags",zh_CN:"\u5B8C\u6574\u6807\u8BB0"},BLOCK_TAGS_:{en_US:"Block Tags",de_DE:"Block-Tags",fr_FR:"Balises en bloc",ja_JP:"\u30D6\u30ED\u30C3\u30AF \u30BF\u30B0",nl_NL:"Tags in blokken",zh_CN:"\u5757\u6807\u8BB0"},INLINE_TAGS_:{en_US:"Inline Tags",de_DE:"Inline-Tags",fr_FR:"Balises en ligne",ja_JP:"\u30A4\u30F3\u30E9\u30A4\u30F3 \u30BF\u30B0",nl_NL:"Inline tags",zh_CN:"\u5185\u8054\u6807\u8BB0"},PARTIAL_TAGS_:{en_US:"Partial Tags",de_DE:"Partielle Tags",fr_FR:"Balises partielles",ja_JP:"\u90E8\u5206\u30BF\u30B0",nl_NL:"Gedeeltelijke tags",zh_CN:"\u90E8\u5206\u6807\u8BB0"},NO_TAGS_:{en_US:"No Tags",de_DE:"Keine Tags",fr_FR:"Aucune balise",ja_JP:"\u30BF\u30B0\u306A\u3057",nl_NL:"Geen tags",zh_CN:"\u6CA1\u6709\u6807\u8BB0"},NO_DIFF_:{en_US:"No differences between the two files were detected.",de_DE:"Es wurden keine Unterschiede zwischen den beiden Dateien festgestellt.",fr_FR:"Aucune diff\xE9rence entre les deux fichiers n'a \xE9t\xE9 d\xE9tect\xE9e.",ja_JP:"2 \u3064\u306E\u30D5\u30A1\u30A4\u30EB\u306E\u9593\u306B\u5DEE\u7570\u306F\u691C\u51FA\u3055\u308C\u307E\u305B\u3093\u3067\u3057\u305F\u3002",nl_NL:"Er zijn geen verschillen gedetecteerd tussen de twee bestanden.",zh_CN:"\u672A\u68C0\u6D4B\u5230\u4E24\u4E2A\u6587\u4EF6\u4E4B\u95F4\u7684\u5DEE\u5F02\u3002"},NO_AUTHOR_DIFF_:{en_US:"No visual differences between the two files were detected.",de_DE:"Keine visuellen Unterschiede zwischen den beiden Dateien festgestellt.",fr_FR:"Aucune diff\xE9rence visuelle entre les deux fichiers n'a \xE9t\xE9 d\xE9tect\xE9e.",ja_JP:"2 \u3064\u306E\u30D5\u30A1\u30A4\u30EB\u306E\u9593\u306B\u8996\u899A\u7684\u306A\u5DEE\u7570\u306F\u691C\u51FA\u3055\u308C\u307E\u305B\u3093\u3067\u3057\u305F\u3002",nl_NL:"Er zijn geen visuele verschillen gedetecteerd tussen de twee bestanden.",zh_CN:"\u672A\u68C0\u6D4B\u5230\u4E24\u4E2A\u6587\u4EF6\u4E4B\u95F4\u7684\u89C6\u89C9\u5DEE\u5F02\u3002"},READ_MORE_:{en_US:"Read more",de_DE:"Mehr lesen",fr_FR:"En savoir plus",ja_JP:"\u8A73\u7D30",nl_NL:"Meer informatie",zh_CN:"\u9605\u8BFB\u66F4\u591A"},NO_BASE_:{en_US:"The original (base) file could not be loaded. Therefore, conflicts and incoming changes could not be highlighted.",de_DE:"Die urspr\xFCngliche (Ausgangs-)Datei konnte nicht geladen werden. Daher k\xF6nnen Konflikte und eingehende \xC4nderungen nicht hervorgehoben werden.",fr_FR:"Le fichier original (de base) n'a pas pu \xEAtre charg\xE9. Par cons\xE9quent, les conflits et les changements entrants n'ont pas pu \xEAtre mis en \xE9vidence.",ja_JP:"\u5143\u306E (\u57FA\u672C) \u30D5\u30A1\u30A4\u30EB\u3092\u8AAD\u307F\u8FBC\u3081\u307E\u305B\u3093\u3067\u3057\u305F\u3002\u3057\u305F\u304C\u3063\u3066\u3001\u7AF6\u5408\u304A\u3088\u3073\u5165\u529B\u65B9\u5411\u306E\u5909\u66F4\u3092\u5F37\u8ABF\u8868\u793A\u3067\u304D\u307E\u305B\u3093\u3067\u3057\u305F\u3002",nl_NL:"Kan het originele (basis)bestand niet laden. Conflicten en inkomende wijzigingen kunnen daarom niet worden gemarkeerd.",zh_CN:"\u65E0\u6CD5\u52A0\u8F7D\u539F\u59CB\uFF08\u57FA\u672C\uFF09\u6587\u4EF6\u3002\u56E0\u6B64\uFF0C\u65E0\u6CD5\u7A81\u51FA\u663E\u793A\u51B2\u7A81\u548C\u65E0\u6CD5\u7A81\u663E\u5F15\u5165\u3002"},OPEN_BASE_:{en_US:"Open base file for troubleshooting purposes",de_DE:"\xD6ffnen Sie die Ursprungsdatei zur Fehlersuche",fr_FR:"Ouvrir le fichier de base \xE0 des fins de d\xE9pannage",ja_JP:"\u30C8\u30E9\u30D6\u30EB\u30B7\u30E5\u30FC\u30C6\u30A3\u30F3\u30B0\u3092\u884C\u3046\u305F\u3081\u306B\u57FA\u672C\u30D5\u30A1\u30A4\u30EB\u3092\u958B",nl_NL:"Basisbestand openen om problemen op te lossen",zh_CN:"\u6253\u5F00\u57FA\u672C\u6587\u4EF6\u8FDB\u884C\u6545\u969C\u6392\u9664"},DIFFS_HIDDEN_IN_AUTHOR_:{en_US:"There are differences that cannot be displayed in the visual comparison mode.",de_DE:"Es gibt Unterschiede, die nicht in der visuellen Autorenansicht angezeigt werden k\xF6nnen.",fr_FR:"Il y a des diff\xE9rences qui ne peuvent pas \xEAtre affich\xE9es en mode comparaison visuelle.",ja_JP:"\u30D3\u30B8\u30E5\u30A2\u30EB\u4F5C\u6210\u8005\u30E2\u30FC\u30C9\u3067\u8868\u793A\u3067\u304D\u308B\u5DEE\u7570\u306F\u3042\u308A\u307E\u305B\u3093\u3002",nl_NL:"Er zijn verschillen die niet kunnen worden weergegeven in de visuele auteursmodus.",zh_CN:"\u5728\u53EF\u89C6\u5316\u6BD4\u8F83\u6A21\u5F0F\u4E0B\u65E0\u6CD5\u663E\u793A\u5B58\u5728\u5DEE\u5F02\u3002"},PERFORM_FILES_DIFFERENCING:{en_US:"Re-compute Differences",de_DE:"Unterschiede neu berechnen",fr_FR:"Recalculer les diff\xE9rences",ja_JP:"\u5DEE\u7570\u3092\u518D\u8A08\u7B97\u3059\u308B",nl_NL:"Verschillen opnieuw berekenen",zh_CN:"\u91CD\u65B0\u8BA1\u7B97\u5DEE\u5F02"}};sync.Translation.addTranslations(t)})();sync.diff.DiffTool=class extends sync.internal_api.DiffTool{constructor(t){super(t);this.containerElement_=t,this.iframe_=null}dispose(){this.iframe_&&(this.iframe_.contentWindow.workspace.state.initReload(),this.iframe_.src="about:blank",this.iframe_=null),goog.dom.removeChildren(this.containerElement_)}setEditPerformer(t){this.editPerformer_=t}showDiffEditor(t,e){return this.dispose(),this.iframe_=this.buildDiffIframe_(t,e),this.containerElement_.appendChild(goog.dom.createDom("div","diff-iframe-container",this.iframe_)),new Promise((i,n)=>{this.iframe_.addEventListener("load",()=>{try{i()}catch(o){n(o)}}),this.iframe_.addEventListener("error",n)}).then(()=>{if(this.editPerformer_)return new Promise((i,n)=>{let o=this.iframe_.contentWindow.workspace;o.listen(sync.api.Workspace.EventType.EDITOR_LOADED,i),o.listen(sync.api.Workspace.EventType.EDITOR_LOADING_FAILED,n)}).then(i=>{i.editor.getEditingSupport().setEditorsLoadInterceptors(null,o=>this.editPerformer_(o))})})}getDiffEditorState(){return this.iframe_.contentWindow.workspace.currentEditor.getEditingSupport().getDiffEditorState()}getDiffEditingSupport(){return this.iframe_.contentWindow.workspace.currentEditor.getEditingSupport()}buildDiffIframe_(t,e){let i={src:this.buildDiffUrl_(t,e),"data-content":t.content,style:sync.diff.CompareWithDialog.FULL_SIZE_STYLES+"border: 0;"};return t.diffContent&&(i["data-diffContent"]=t.diffContent),t.sourceDocId&&(i["data-sourceDocId"]=t.sourceDocId),t.diffSourceDocId&&(i["data-diffSourceDocId"]=t.diffSourceDocId),goog.dom.createDom("iframe",i)}buildDiffUrl_(t,e){var i="oxygen.html?url="+encodeURIComponent(t.leftUrl);return i+=this.createUrlPart_("diffUrl",t.rightUrl,!0),i+=this.createUrlPart_("diffBaseUrl",t.baseUrl,!0),i+=this.createUrlPart_("leftFromIframe","true"),i+=this.createUrlPart_("leftEditorLabel",t.leftEditorLabel,!0),i+=this.createUrlPart_("leftEditorTooltip",t.leftLabelTooltip,!0),i+=this.createUrlPart_("rightEditorLabel",t.rightEditorLabel,!0),i+=this.createUrlPart_("diffType",t.diffType,!1),i+=this.createUrlPart_("runDiffOnChange",t.runDiffOnChange,!0),i+=this.createUrlPart_("author",e.userName),i+=this.createUrlPart_("spell.check.language",e["spell.check.language"]),i+=this.createUrlPart_("KeyscopeStack",e.KeyscopeStack),i+=this.createUrlPart_("dita.val.url",e["dita.val.url"]),i}createUrlPart_(t,e,i){var n="";if(e){var o=i?encodeURIComponent(e):e;n="&"+t+"="+o}return n}};window.workspace.serviceLoader.registerService(sync.internal_api.DiffTool,sync.diff.DiffTool);var a=window.msgs,l=window.tr;sync.diff.DiffApi=class extends sync.internal_api.DiffApi{constructor(t){super(t);this.editor_=t,this.custom_={leftEditorLabel:null,leftLabelTooltip:null,rightEditorLabel:null,submitLabel:null}}withLeftLabel(t,e){return this.custom_.leftEditorLabel=t,this.custom_.leftLabelTooltip=e,this}withRightLabel(t){return this.custom_.rightEditorLabel=t,this}withSubmitLabel(t){return this.custom_.submitLabel=t,this}isMainEditorEditable(){return!this.editor_.getReadOnlyState().readOnly&&this.editor_.getEditingSupport().editModeModel.isEditMode()}canMerge(){return this.isMainEditorEditable()&&!this.isConcurrentEditing_()}compareWith(t,e){var i=new sync.diff.CompareWithDialog(l(a.DIFF),[{key:"ok",caption:this.custom_.submitLabel||l(a.CLOSE_)}]);return i.show(),i.showDiff(this.buildDiffParams_(sync.internal_api.DiffType.DIFF,t,e,this.editor_.docId),this.editor_.options).then(()=>this.waitForOkOrCancel_(i)).finally(()=>i.dispose())}mergeWith(t,e){if(!this.canMerge())return Promise.reject(new Error("Merge is not available"));var i=new sync.diff.CompareWithDialog(l(a.MERGE),[{key:"ok",caption:this.custom_.submitLabel||l(a.MERGE)},{key:"cancel",caption:l(a.CANCEL_)}]);return i.show(),i.showDiff(this.buildDiffParams_(sync.internal_api.DiffType.MERGE,t,e,this.editor_.docId),this.editor_.options).then(()=>this.waitForOkOrCancel_(i)).then(n=>n&&(i.showDialogSpinner(),i.getDiffEditorState().then(o=>o.isDirty?this.syncDiffContentWithEditor_(o.editorTextState):n).then(()=>n))).finally(()=>i.dispose())}previewEdit(t,e){return this.isMainEditorEditable()?this.editor_.getActionsManager().invokeOperation("ro.sync.servlet.operation.NoOperation",{},()=>this.editor_.getEditingSupport().scheduleDocumentTransaction(()=>{let i=!this.isConcurrentEditing_()&&!this.editor_.getEditingSupport().getChangeTrackingManager().isTrackingChanges();this.withLeftLabel(l(a.YOUR_VERSION_));let n=e||l(a.LATEST_VERSION_);this.withRightLabel(n);let o=[{key:"ok",caption:this.custom_.submitLabel||l(a.APPLY_PROPOSED_CHANGES)},{key:"cancel",caption:l(a.CANCEL_)}],r=new sync.diff.CompareWithDialog(l(a.PREVIEW),o);r.setEditPerformer(t),r.show();let s=i?sync.internal_api.DiffType.MERGE:sync.internal_api.DiffType.DIFF,f=!1;return r.showDiff(this.buildDiffParams_(s,this.editor_.getUrl(),null,this.editor_.docId,this.editor_.docId),this.editor_.options).then(()=>(r.getDiffEditingSupport().listen(sync.api.EditingSupport.EventType.DIRTY_STATUS_CHANGED,function(d){!f&&d.isDirty&&(f=!0,r.setButtonLabel("ok",l(a.APPLY_YOUR_CHANGES)))}.bind(this)),this.waitForOkOrCancel_(r))).then(d=>d&&(r.showDialogSpinner(),r.getDiffEditorState().then(c=>f?i?this.syncDiffContentWithEditor_(c.editorTextState):t(this.editor_.getEditingSupport()):t(this.editor_.getEditingSupport())).then(()=>d))).finally(()=>r.dispose())})):Promise.reject(new Error("Preview edit is not available"))}waitForOkOrCancel_(t){var e=sync.util.promise.createResolver();return t.onSelect((i,n)=>(n.preventDefault(),e.resolve(i==="ok"),e.promise)),e.promise}buildDiffParams_(t,e,i,n,o){var r=this.editor_.getUrl(),{leftEditorLabel:s,leftLabelTooltip:f,rightEditorLabel:d}=this.buildDefaultLabelValues_(t,r,e),c=new sync.internal_api.DiffParams(t,null,r);return c.rightUrl=e,c.baseUrl=i,c.leftEditorLabel=this.custom_.leftEditorLabel||s,c.leftLabelTooltip=this.custom_.leftLabelTooltip||f,c.rightEditorLabel=this.custom_.rightEditorLabel||d,c.sourceDocId=n,c.diffSourceDocId=o,c}buildDefaultLabelValues_(t,e,i){var n,o,r=e===i?l(a.LATEST_VERSION_):null;return this.isConcurrentEditing_()?(n=l(a.SNAPSHOT_HINT_,{$document:l(a.YOUR_VERSION_)}),o=new Date().toLocaleString()):t===sync.internal_api.DiffType.MERGE?n=l(a.YOUR_VERSION_):r=null,{leftEditorLabel:n,leftLabelTooltip:o,rightEditorLabel:r}}syncDiffContentWithEditor_(t){var e={id:this.editor_.docId,$entity:JSON.stringify({content:t.xmlContent,caret:t.caretOffset})};return sync.rest.callAsync("RESTDocumentManager.setTextState",e).then(i=>{if(i.success){var n=i.docUpdate;this.editor_.getController().applyUpdate_(n)}else throw new Error("Could not set text state.")})}isConcurrentEditing_(){var t=!1,e=this.editor_.getEditingSupport();if(e){var i=e.getConcurrentEditingManager();i&&(t=i.isInRoom())}return t}};window.workspace.serviceLoader.registerService(sync.internal_api.DiffApi,sync.diff.DiffApi);var a=window.msgs,l=window.tr;sync.diff.CompareWithDialog=function(t,e){this.buttonsConfiguration_=e,this.dialog_=this.buildDialog_(t),this.diffTool_=new sync.diff.DiffTool(this.dialog_.getElement()),this.updateDialogLayout_()};sync.diff.CompareWithDialog.FULL_SIZE_STYLES="width: 100%; height: 100%; box-sizing: border-box; display: block;";sync.diff.CompareWithDialog.prototype.buildDialog_=function(t){var e=window.workspace.createDialog("diff");return e.setTitle(t),this.rotateKey_=goog.events.listen(window,goog.events.EventType.ORIENTATIONCHANGE,goog.bind(this.onOrientationChange,this)),e};sync.diff.CompareWithDialog.prototype.createUrlPart_=function(t,e,i){var n="";if(e){var o=i?encodeURIComponent(e):e;n="&"+t+"="+o}return n};sync.diff.CompareWithDialog.prototype.show=function(){this.showDialogSpinner(),this.dialog_.show()};sync.diff.CompareWithDialog.prototype.showDialogSpinner=function(){this.spinner_=new sync.view.Spinner(this.dialog_.getElement(),1),this.spinner_.show(),this.dialog_.setButtonDisabledState("ok",!0)};sync.diff.CompareWithDialog.prototype.hideDialogSpinner=function(){this.spinner_&&this.spinner_.hide(),this.dialog_.setButtonDisabledState("ok",!1)};sync.diff.CompareWithDialog.prototype.onSelect=function(t){this.dialog_.onSelect(goog.bind(function(e,i){t(e,i)},this))};sync.diff.CompareWithDialog.prototype.setEditPerformer=function(t){this.diffTool_.setEditPerformer(t)};sync.diff.CompareWithDialog.prototype.showDiff=function(t,e){return this.diffTool_.showDiffEditor(t,e).then(()=>this.hideDialogSpinner())};sync.diff.CompareWithDialog.prototype.showError=function(){this.dialog_.getElement().textContent=l(a.ERROR_),this.hideDialogSpinner()};sync.diff.CompareWithDialog.prototype.getDiffEditorState=function(){return this.diffTool_.getDiffEditorState()};sync.diff.CompareWithDialog.prototype.getDiffEditingSupport=function(){return this.diffTool_.getDiffEditingSupport()};sync.diff.CompareWithDialog.prototype.updateDialogLayout_=function(){var t=this.isMobileViewport_();this.dialog_.setButtonConfiguration(this.buttonsConfiguration_),t?this.dialog_.setResizable(!1):this.dialog_.setResizable(!0),this.dialog_.setPreferredSize(Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER)};sync.diff.CompareWithDialog.prototype.setButtonLabel=function(t,e){this.dialog_.setButtonLabel(t,e)};sync.diff.CompareWithDialog.prototype.isMobileViewport_=function(){var t=goog.dom.getViewportSize();return t.height<500};sync.diff.CompareWithDialog.prototype.onOrientationChange=function(){goog.events.listenOnce(window,goog.events.EventType.RESIZE,goog.bind(this.updateDialogLayout_,this))};sync.diff.CompareWithDialog.prototype.dispose=function(){goog.events.unlistenByKey(this.rotateKey_),goog.dispose(this.diffTool_),goog.dispose(this.dialog_)};var a=window.msgs,l=window.tr;sync.diff.CompareWithOtherAction=function(t,e){sync.actions.Action.call(this,{}),this.editor_=t,this.dialog_=null,this.displayName_=e,this.callsCallback=!0};goog.inherits(sync.diff.CompareWithOtherAction,sync.actions.Action);sync.diff.CompareWithOtherAction.prototype.actionPerformed=function(t){var e=t||goog.nullFunction;this.chooserContext_==null&&(this.chooserContext_=new sync.api.UrlChooser.Context(sync.api.UrlChooser.Type.GENERIC)),workspace.getUrlChooser().chooseUrl(this.chooserContext_,goog.bind(function(i){i?this.showDiffDialog_(i,e):e()},this),sync.api.UrlChooser.Purpose.CHOOSE)};sync.diff.CompareWithOtherAction.prototype.showDiffDialog_=function(t,e){let i=new sync.diff.DiffApi(this.editor_),n=new URL(this.editor_.getUrl()).pathname,o=n.substring(n.lastIndexOf("/")+1);i.withLeftLabel(l(a.YOUR_VERSION_)+" ("+o+")"),i.canMerge()?i.mergeWith(t).finally(e):i.compareWith(t).finally(e)};sync.diff.CompareWithOtherAction.prototype.getDisplayName=function(){return this.displayName_};sync.diff.CompareWithOtherAction.prototype.getDescription=function(){return l(a.COMPARE_WITH_OTHER_FILE_)};sync.diff.CompareWithOtherAction.prototype.isEnabled=function(){let t=workspace.getUrlChooser();return t&&t.supportsOperation(sync.api.UrlChooser.Purpose.CHOOSE)};sync.diff.CompareWithOtherAction.prototype.dispose=function(){goog.dispose(this.dialog_)};var a=window.msgs,l=window.tr;sync.diff.CompareWithRepoVersionAction=function(t){sync.actions.Action.call(this,{}),this.editor_=t,this.baseUrl_="",this.callsCallback=!0};goog.inherits(sync.diff.CompareWithRepoVersionAction,sync.actions.Action);sync.diff.CompareWithRepoVersionAction.prototype.actionPerformed=function(t){var e=t||goog.nullFunction;this.showDiffDialog_(e)};sync.diff.CompareWithRepoVersionAction.prototype.showDiffDialog_=function(t){var e=new sync.diff.DiffApi(this.editor_),i;e.canMerge()?i=e.mergeWith(this.editor_.getUrl(),this.baseUrl_):i=e.compareWith(this.editor_.getUrl(),this.baseUrl_),i.then(t).catch(n=>{t(n),window.workspace.getNotificationManager().showError("Cannot commit merge changes. "+JSON.stringify(n))})};sync.diff.CompareWithRepoVersionAction.prototype.setBaseUrl=function(t){this.baseUrl_=t};sync.diff.CompareWithRepoVersionAction.prototype.getDisplayName=function(){return l(a.LATEST_FROM_REPOSITORY_)};var a=window.msgs,l=window.tr;sync.diff.CopyAllDiffsAction=function(t,e,i,n){sync.actions.Action.call(this,{}),this.actionsManager_=t,this.diffPerformer_=e,this.diffSelectionModel_=i,this.diffsModelPair_=n,n.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,()=>t.refreshActionsStatus(sync.diff.CopyAllDiffsAction.ACTION_ID))};goog.inherits(sync.diff.CopyAllDiffsAction,sync.actions.Action);sync.diff.CopyAllDiffsAction.ACTION_ID="Diff/CopyAllDiffsAction";sync.diff.CopyAllDiffsAction.prototype.getDescription=function(){return l(a.COPY_ALL_CHANGES_FROM_RIGHT_TO_LEFT)};sync.diff.CopyAllDiffsAction.prototype.getLargeIcon=function(){return sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/DiffCopyAllRightToLeft24.png")};sync.diff.CopyAllDiffsAction.prototype.isEnabled=function(){return this.diffsModelPair_.getModel(!0).getParentDiffs().length!==0};sync.diff.CopyAllDiffsAction.prototype.actionPerformed=function(t){this.actionsManager_.invokeOperation("com.oxygenxml.webapp.diff.operations.copy.CopyAllDiffsOperation",{}).then(e=>this.diffPerformer_.showDiffResultWithoutScheduler(e)).thenAlways(t)};var a=window.msgs,l=window.tr;sync.diff.CopyAllNonConflictingDiffsAction=function(t,e,i,n){sync.actions.Action.call(this,{}),this.actionsManager_=t,this.diffPerformer_=e,this.diffSelectionModel_=i,this.diffsModelPair_=n,n.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,()=>t.refreshActionsStatus(sync.diff.CopyAllNonConflictingDiffsAction.ACTION_ID))};goog.inherits(sync.diff.CopyAllNonConflictingDiffsAction,sync.actions.Action);sync.diff.CopyAllNonConflictingDiffsAction.ACTION_ID="Diff/CopyAllNonConflictingDiffsAction";sync.diff.CopyAllNonConflictingDiffsAction.prototype.getDescription=function(){return l(a.COPY_ALL_NONCONFLICTING_CHANGES_FROM_RIGHT_TO_LEFT)};sync.diff.CopyAllNonConflictingDiffsAction.prototype.getLargeIcon=function(){return sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/DiffCopyAllRightToLeft24.png")};sync.diff.CopyAllNonConflictingDiffsAction.prototype.isEnabled=function(){return this.diffsModelPair_.getModel(!0).getParentDiffs().length!==0};sync.diff.CopyAllNonConflictingDiffsAction.prototype.actionPerformed=function(t){this.actionsManager_.invokeOperation("com.oxygenxml.webapp.diff.operations.copy.CopyAllNonConflictingDiffsOperation",{}).then(e=>this.diffPerformer_.showDiffResultWithoutScheduler(e)).thenAlways(t)};var a=window.msgs,l=window.tr;sync.diff.CopyDiffAction=function(t,e,i,n,o){sync.actions.Action.call(this,{}),this.actionsManager_=t,this.secondaryActionsManager_=e,this.diffSelectionModel_=i,this.diffsModelPair_=n,this.diffToSelection_=o,i.listen(sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,()=>t.refreshActionsStatus(sync.diff.CopyDiffAction.ACTION_ID))};goog.inherits(sync.diff.CopyDiffAction,sync.actions.Action);sync.diff.CopyDiffAction.ACTION_ID="Diff/CopyDiff";sync.diff.CopyDiffAction.prototype.getDescription=function(){return l(a.COPY_CHANGE_FROM_RIGHT_TO_LEFT)};sync.diff.CopyDiffAction.prototype.getLargeIcon=function(){return sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/DiffCopyRightToLeft24.png")};sync.diff.CopyDiffAction.prototype.isEnabled=function(){return!!this.diffSelectionModel_.getSelectedDiff()};sync.diff.CopyDiffAction.prototype.actionPerformed=function(t){var e=this.diffSelectionModel_.getSelectedDiff();this.actionsManager_.invokeOperation("com.oxygenxml.webapp.diff.operations.copy.CopyDiffOperation",{diffId:e.diffId},null,this.diffToSelection_.getSelectionFor(e)).then(i=>this.updateDiffModel(i)).thenAlways(t)};sync.diff.CopyDiffAction.prototype.updateDiffModel=function(t){var e=JSON.parse(t);return this.removeHighlights_(e.rightHighlightIdsToRemove).then(()=>{this.updateSelection_(),this.diffsModelPair_.setDiffs(e.leftDiffsDescriptors,e.rightDiffsDescriptors)}).thenCatch(console.warn)};sync.diff.CopyDiffAction.prototype.updateSelection_=function(){var t=this.diffSelectionModel_.getSelectedDiff();if(t){var e=sync.diff.DiffsModel.getDiffType(t.diffId),i=this.diffSelectionModel_.getNextDiffOfType(e,!1);i&&i.diffId!==t.diffId?this.diffSelectionModel_.setSelection(i,!1):this.diffSelectionModel_.setSelection(null)}};sync.diff.CopyDiffAction.prototype.removeHighlights_=function(t){return this.secondaryActionsManager_.invokeOperation("ro.sync.servlet.operation.RemoveHighlightsOperation",{ids:t},goog.nullFunction,null,!0)};sync.diff.DiffActionNextChange=function(t,e,i,n,o){sync.actions.Action.call(this,{}),this.backwards_=n,this.diffSelectionModel_=o,this.type_=t,this.iconName_=i,this.description_=e};goog.inherits(sync.diff.DiffActionNextChange,sync.actions.Action);sync.diff.DiffActionNextChange.prototype.getDescription=function(){return this.description_};sync.diff.DiffActionNextChange.prototype.getLargeIcon=function(){return sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/"+this.iconName_)};sync.diff.DiffActionNextChange.prototype.getNextDiff_=function(){return this.diffSelectionModel_.getNextDiffOfType(this.type_,this.backwards_)};sync.diff.DiffActionNextChange.prototype.isEnabled=function(){return!!this.getNextDiff_()};sync.diff.DiffActionNextChange.prototype.actionPerformed=function(t){var e=this.diffSelectionModel_;if(e){var i=this.getNextDiff_();i&&e.setSelection(i,!0)}else console.error("Could not get next diff.");t&&t()};sync.diff.DiffActionTagsMode=function(t,e,i,n){sync.actions.Action.call(this,{}),this.mode_=t,this.displayName_=e,this.iconName_=i,this.tagsModeManager_=n};goog.inherits(sync.diff.DiffActionTagsMode,sync.actions.Action);sync.diff.DiffActionTagsMode.prototype.actionPerformed=function(t){this.tagsModeManager_.switchTo(this.mode_),t()};sync.diff.DiffActionTagsMode.prototype.isEnabled=function(){return this.tagsModeManager_.isInitialized()};sync.diff.DiffActionTagsMode.prototype.renderSmallIcon=function(){return sync.util.renderSmallIcon(sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/"+this.iconName_+"16.png"))};sync.diff.DiffActionTagsMode.prototype.getDisplayName=function(){return this.displayName_};sync.diff.DiffDom=function(){};sync.diff.DiffDom.getDocumentNode=function(t){return sync.model.XmlDom.getDocumentNode(t)};sync.diff.DiffDom.getDiffId=function(t){return goog.dom.isElement(t)?t.getAttribute("data-diff-id"):null};sync.diff.DiffEditingSupport=function(t,e){this.layoutManager_=t,this.editor_=e,this.secondaryEditingSupport_=null,this.primaryEditingSupport_=e.createBasicEditingSupport(),this.primaryEditingSupport_.listen(sync.api.EditingSupport.EventType.DIRTY_STATUS_CHANGED,i=>this.dispatchEvent(i)),this.actionsManager_=e.getActionsManager(),goog.events.listen(e,sync.api.Editor.EventTypes.LINK_OPENED,function(i){delete i.params.diffUrl,delete i.params.diffBaseUrl,delete i.params.leftFromIframe,delete i.params.leftEditorLabel,delete i.params.leftEditorTooltip,delete i.params.rightEditorLabel,delete i.params.diffType,delete i.params.runDiffOnChange,delete i.params.saveMergedDocument}),this.diffsModelPair_=new sync.diff.DiffsModelPair(new sync.diff.DiffsModel,new sync.diff.DiffsModel,this.primaryEditingSupport_),this.diffSelectionModel_=new sync.diff.DiffSelectionModel(this.diffsModelPair_),this.leftEditorLoadInterceptor_=null,this.rightEditorLoadInterceptor_=null,sync.api.WrapperAuthorEditingSupport.call(this,this.primaryEditingSupport_)};goog.inherits(sync.diff.DiffEditingSupport,sync.api.WrapperAuthorEditingSupport);sync.diff.DiffEditingSupport.DIFF_EDITORS_LOAD_INTERCEPTOR="DIFF_EDITORS_LOAD_INTERCEPTOR";sync.diff.DiffEditingSupport.prototype.setEditorsLoadInterceptors=function(t,e){this.leftEditorLoadInterceptor_=t,this.rightEditorLoadInterceptor_=e};sync.diff.DiffEditingSupport.prototype.load=function(t,e,i){this.autoDiff_=this.determineIfAutoDiffMustBePerformed_(t);let n=async()=>{if(!!this.leftEditorLoadInterceptor_||!!this.rightEditorLoadInterceptor_){let r=new sync.view.Spinner(this.layoutManager_.getDiffLinksContainer(),0);r.show();try{if(this.leftEditorLoadInterceptor_){let s=this.primaryEditingSupport_.getReadOnlyStatus().getReadOnlyState();await o(this.leftEditorLoadInterceptor_,this.primaryEditingSupport_,s)}if(this.rightEditorLoadInterceptor_){let s=this.secondaryEditingSupport_.getReadOnlyStatus().getReadOnlyState();await o(this.rightEditorLoadInterceptor_,this.secondaryEditingSupport_,s)}}finally{r.hide()}}},o=async(r,s,f)=>{try{f.readOnly&&await sync.util.promise.nativePromise(s.getActionsManager().invokeOperation("ro.sync.ecss.extensions.commons.operations.SetReadOnlyStatusOperation",{"read-only":"false"})),await r(s)}finally{f.readOnly&&await sync.util.promise.nativePromise(s.getActionsManager().invokeOperation("ro.sync.ecss.extensions.commons.operations.SetReadOnlyStatusOperation",{"read-only":"true","reason-code":f.code,reason:f.message}))}};return this.primaryEditingSupport_.load(t,e,i).then(r=>(this.isMerge_(this.options)&&(r.editModeModel.setEditMode(),r.getReadOnlyStatus().setReadOnlyState({readOnly:!1})),r.enableContextMenu(!0),r.installExtensionActions(),this.isSaveMergedDocumentEnabled_(this.options)&&r.installSaveActions(this.editor_),new sync.diff.HorizontalScrollFixer(e,this.primaryEditingSupport_).attach(),this)).then(()=>sync.diff.DiffEditingSupport.loadSecondaryEditingSupport(this.editor_,this.layoutManager_).then(r=>(this.secondaryEditingSupport_=r,this.secondaryEditingSupport_.enableContextMenu(!0),this.secondaryEditingSupport_.enableKeyboardShortcuts(),this.initDiffUi_(r,this.diffsModelPair_,this.diffSelectionModel_),this.secondaryEditingSupport_.getActionsManager().invokeOperation("com.oxygenxml.webapp.diff.operations.SetRightDocContextOperation",{},goog.nullFunction,null,!0).then(()=>{var s=this.primaryEditingSupport_.options.diffBaseUrl;return s?this.primaryEditingSupport_.getActionsManager().invokeOperation("com.oxygenxml.webapp.diff.operations.SetBaseDocOperation",{diffBaseUrl:s},goog.nullFunction,null,!0):Promise.resolve()}).then(()=>n()).then(()=>{var s=this.editor_.getActionsManager().getActionById(sync.diff.PerformDiffAction.ACTION_ID);this.primaryEditingSupport_.getActionsExecutor().executeUpdate(s)}),this)).thenCatch(()=>this))};sync.diff.DiffEditingSupport.AutoDiffDocLengthLimit=1e4;sync.diff.DiffEditingSupport.prototype.determineIfAutoDiffMustBePerformed_=function(t){var e=!1;if(this.isMerge_(this.editor_.options)){var i=this.editor_.options.runDiffOnChange;if(i==="false"||i===!1)e=!1;else if(i==="true"||i===!0)e=!0;else{var n=t.documentLength;e=n?n<sync.diff.DiffEditingSupport.AutoDiffDocLengthLimit:!1}}return e};sync.diff.DiffEditingSupport.prototype.getActionsManager=function(){return this.actionsManager_};sync.diff.DiffEditingSupport.prototype.isAutoDiffEnabled=function(){return this.autoDiff_};sync.diff.DiffEditingSupport.prototype.syncToAuthorMode=function(){return goog.Promise.resolve(!0)};sync.diff.DiffEditingSupport.loadSecondaryEditingSupport=function(t,e){var i=e.getSecondDocumentContainer(),n=t.options,o={url:n.diffUrl,content:n.diffContent,sourceDocId:n.diffSourceDocId,elementNameEnhancer:n.elementNameEnhancer,"tags-mode":n[sync.diff.DiffTagsModeManager.TAGS_MODE_EDITOR_OPTION],ditamap:n.diffDitamap||n.ditamap||n.guessedDitamap,"dita.val.url":n["diff.dita.val.url"]||n["dita.val.url"]};return t.loadPreview(i,o)};sync.diff.DiffEditingSupport.prototype.isMerge_=function(t){return t.diffType===sync.internal_api.DiffType.MERGE};sync.diff.DiffEditingSupport.prototype.isSaveMergedDocumentEnabled_=function(t){var e=t.saveMergedDocument;return e==="true"||e===!0};sync.diff.DiffEditingSupport.prototype.initDiffUi_=function(t,e,i){var n=this.layoutManager_.getDocumentContainer(),o=this.layoutManager_.getSecondDocumentContainer(),r=new sync.diff.DiffsHighlightsManager(this.primaryEditingSupport_.getHighlightsManager(),i,e.getModel(!0),this.primaryEditingSupport_.getLayoutChangeTracker());r.attach();var s=new sync.diff.DiffsHighlightsManager(t.getHighlightsManager(),i,e.getModel(!1),t.getLayoutChangeTracker());s.attach(),this.diffToSelection_=new sync.diff.DiffToSelection(r,this.primaryEditingSupport_.getSelectionManager(),this.primaryEditingSupport_.getDocument());var f=this.primaryEditingSupport_.getLayoutChangeTracker(),d=new sync.diff.EditorIntervals(this.layoutManager_.getEditorsContainer(),n,e.getModel(!0),r,f),c=t.getLayoutChangeTracker(),p=new sync.diff.EditorIntervals(this.layoutManager_.getEditorsContainer(),o,e.getModel(!1),s,c),h=new sync.diff.EditorIntervalsPair(e,d,p);h.attach(),i.attach();var _=new sync.diff.DiffSelectionManager(i,h,this.primaryEditingSupport_.getSelectionManager(),t.getSelectionManager(),this.diffsModelPair_);_.attach();var g=new sync.diff.DiffLinksPresenter(this.layoutManager_.getDiffLinksContainer(),i,h,f,c);g.attach();var u=new sync.diff.ScrollSynchronizer(h,i);u.attach();var D=new sync.diff.RangeRuler(i,this.layoutManager_.getRangeRulerContainer(),h,e.getModel(!1));D.attach();var y=new sync.diff.NoticeStripe(this.layoutManager_),S=new sync.diff.NoticeStripeManager(y,h,e,this.getActionsManager(),window.location.toString());if(S.attach(),this.diffPerformer_=new sync.diff.DiffPerformer(S,this.layoutManager_,this.primaryEditingSupport_,t,e),this.installPerformDiffAction_(this.diffPerformer_),this.autoDiff_){var E=new sync.diff.DiffsAutoUpdater(this.diffPerformer_);E.attach(this.diffsModelPair_)}};sync.diff.DiffEditingSupport.prototype.getFirstToolbar=function(){var t=[],e=this.editor_.getActionsManager(),i=this.isMerge_(this.editor_.options),n=this.isSaveMergedDocumentEnabled_(this.editor_.options),o=this.secondaryEditingSupport_?this.secondaryEditingSupport_.getActionsExecutor():null;this.registerDisposable(r);var r=new sync.view.ExtensionToolbar(this.actionsManager_,o);if(n){var s="Author/Save";t.push({id:s,type:"action"}),t.push({type:"sep"}),goog.events.listen(this.editor_,sync.api.Editor.EventTypes.DIRTY_STATUS_CHANGED,g=>r.refreshActionsStatus([s]))}var f=new sync.diff.DiffTagsModeManager(this.editor_.options);if(f.shouldShowTagsModeDropdown()){var d=f.installActions(e,this.primaryEditingSupport_,this.secondaryEditingSupport_);t.push(d),t.push({type:"sep"})}i&&!this.autoDiff_&&(t.push({id:sync.diff.PerformDiffAction.ACTION_ID,type:"action"}),t.push({type:"sep"}));var c=new sync.diff.DiffNavigationManager(e),p=c.installActions(e,this.getSelectionManager(),this.diffsModelPair_,this.diffSelectionModel_);if(p.forEach(g=>t.push({id:g,type:"action"})),i){var h=this.installCopyDiffsActions_();t.push({type:"sep"}),h.forEach(g=>t.push({id:g,type:"action"}))}var _=[{type:"list",name:"Diff",children:t}];return r.config=new sync.actions.ActionsConfig({toolbars:_}),r};sync.diff.DiffEditingSupport.prototype.installCopyDiffsActions_=function(){var t=[],e=this.editor_.getActionsManager();e.registerAction(sync.diff.CopyDiffAction.ACTION_ID,new sync.diff.CopyDiffAction(e,this.secondaryEditingSupport_.getActionsManager(),this.diffSelectionModel_,this.diffsModelPair_,this.diffToSelection_)),t.push(sync.diff.CopyDiffAction.ACTION_ID);var i=!!this.editor_.options.diffBaseUrl;return i?(e.registerAction(sync.diff.CopyAllNonConflictingDiffsAction.ACTION_ID,new sync.diff.CopyAllNonConflictingDiffsAction(e,this.diffPerformer_,this.diffSelectionModel_,this.diffsModelPair_)),t.push(sync.diff.CopyAllNonConflictingDiffsAction.ACTION_ID)):(e.registerAction(sync.diff.CopyAllDiffsAction.ACTION_ID,new sync.diff.CopyAllDiffsAction(e,this.diffPerformer_,this.diffSelectionModel_,this.diffsModelPair_)),t.push(sync.diff.CopyAllDiffsAction.ACTION_ID)),t};sync.diff.DiffEditingSupport.prototype.installPerformDiffAction_=function(t){var e=this.editor_.getActionsManager(),i=new sync.diff.PerformDiffAction(t,this.diffsModelPair_,e);e.registerAction(sync.diff.PerformDiffAction.ACTION_ID,i)};sync.diff.DiffEditingSupport.prototype.getType=function(){return sync.api.Editor.EditorTypes.DIFF};sync.diff.DiffEditingSupport.prototype.getDiffEditorState=function(){return new Promise((t,e)=>{this.primaryEditingSupport_.scheduleDocumentTransaction(()=>this.getEditorTextState_().then(i=>{t({editorTextState:i,isDirty:this.editor_.isDirty()})}).catch(i=>{console.log("error",i),e(i)}))})};sync.diff.DiffEditingSupport.prototype.getEditorTextState_=function(){var t={id:this.editor_.docId},e=this.editor_.getSelectionManager().getSelection();e.extend(t);var i=sync.rest.callAsync("RESTDocumentManager.getTextState",t);return sync.util.promise.nativePromise(i)};sync.diff.DiffEditingSupport.prototype.setDocumentsLabels=function(t,e){let i=this.layoutManager_;i&&i.setDocumentsLabels(t,e)};var a=window.msgs,l=window.tr;sync.diff.DiffInitializer=function(t){this.layoutManager_=t};sync.diff.DiffInitializer.prototype.attach=function(t){t.getEditingSupportManager().registerEditingSupportProvider({getEditingSupport:function(e,i){return this.isDiffMode(i.options)?new sync.diff.DiffEditingSupport(this.layoutManager_,i):null}.bind(this)}),t.listen(sync.api.Workspace.EventType.BEFORE_EDITOR_LOADED,e=>{this.isDiffMode(e.options)&&(this.enforceOptions_(e),this.loadCustomCss_(),this.layoutManager_.create(),this.setDocumentsLabels_(e.options),this.onEditorLoadingFailure_(e.editor,this.handleLoadFailure_.bind(this,e.editor)),this.preserveIframeStyle_(e.options))}),t.listen(sync.api.Workspace.EventType.EDITOR_LOADED,e=>{this.isDiffMode(e.editor.options)||this.addCompareActions_(e)})};sync.diff.DiffInitializer.prototype.loadCustomCss_=function(){var t=goog.dom.createDom("link");t.rel="stylesheet",t.type="text/css",t.href="../plugin-resources/web-author-diff-plugin/diff.css",goog.dom.appendChild(document.head,t)};sync.diff.DiffInitializer.prototype.enforceOptions_=function(t){t.options.previewMode="true",t.options.compactTagsMode="false",t.options.trackChanges=sync.api.change_tracking.ChangeTrackingInitialState.FORCED_OFF,t.options[sync.diff.DiffTagsModeManager.TAGS_MODE_EDITOR_OPTION]=sync.diff.DiffTagsModeManager.getTagsModeOption(t.options)};sync.diff.DiffInitializer.prototype.handleLoadFailure_=function(t,e){e===401?goog.dom.removeChildren(this.layoutManager_.getSecondDocumentContainer()):sync.diff.DiffEditingSupport.loadSecondaryEditingSupport(t,this.layoutManager_)};sync.diff.DiffInitializer.prototype.preserveIframeStyle_=function(t){t.leftFromIframe==="true"&&(t.content=window.frameElement.getAttribute("data-content"),window.frameElement.removeAttribute("data-content"),t.diffContent=window.frameElement.getAttribute("data-diffContent"),window.frameElement.removeAttribute("data-diffContent"),t.sourceDocId=window.frameElement.getAttribute("data-sourceDocId"),window.frameElement.removeAttribute("data-sourceDocId"),t.diffSourceDocId=window.frameElement.getAttribute("data-diffSourceDocId"),window.frameElement.removeAttribute("data-diffSourceDocId"),window.workspace.getViewManager().hideAppBar())};sync.diff.DiffInitializer.prototype.addCompareActions_=function(t){if(t.editor.getEditorType()===sync.api.Editor.EditorTypes.AUTHOR){var e=t.editor.getActionsManager(),i={type:"action",id:"Author/CompareWithOther"},n,o;t.editor.isAutoSaveEnabled()?(n=i,o=l(a.COMPARE_WITH_ANOTHER_FILE_)):(o=l(a.OTHER_FILE_),e.registerAction("Author/CompareWithRepoVersion",new sync.diff.CompareWithRepoVersionAction(t.editor)),n={type:"list",name:"diff",displayName:l(a.COMPARE_WITH_),children:[{type:"action",id:"Author/CompareWithRepoVersion"},i]}),e.registerAction("Author/CompareWithOther",new sync.diff.CompareWithOtherAction(t.editor,o)),t.editor.listen(sync.api.Editor.EventTypes.ACTIONS_LOADED,function(r){this.addActionToOverflowMenu_(r.actionsConfiguration,n)}.bind(this))}};sync.diff.DiffInitializer.prototype.onEditorLoadingFailure_=function(t,e){var i=new goog.events.EventHandler(this);i.listen(t,sync.api.Editor.EventTypes.CUSTOM_MESSAGE_RECEIVED,function(){e(401),i.dispose()}.bind(this)),i.listen(workspace,sync.api.Workspace.EventType.EDITOR_LOADING_FAILED,function(n){n.editor===t&&(e(0),i.dispose())}.bind(this)),i.listen(workspace,sync.api.Workspace.EventType.EDITOR_LOADED,function(n){n.editor===t&&i.dispose()}.bind(this))};sync.diff.DiffInitializer.prototype.isDiffMode=function(t){return t.diffUrl!=null};sync.diff.DiffInitializer.prototype.addActionToOverflowMenu_=function(t,e){var i=t.toolbars||[],n=i.find(function(r){return r.name==="Builtin"}),o=null;n&&(o=n.children.find(function(r){return r.name==="More..."})),o&&o.children.splice(2,0,e)};sync.diff.DiffInitializer.prototype.setTabTitle_=function(t,e){var i="[Diff]";if(t&&e){var n="";t!==e&&(n=" - "+e),i+=" "+t+n}workspace.listen(sync.api.Workspace.EventType.EDITOR_LOADED,function(){workspace.setTitle("",i)}.bind(this))};sync.diff.DiffInitializer.prototype.setDocumentsLabels_=function(t){var e=t.leftEditorLabel||null,i=t.leftEditorTooltip||"",n=t.rightEditorLabel||null,o=sync.util.getFileFromUrl(t.url),r=sync.util.getFileFromUrl(t.diffUrl);this.setTabTitle_(o,r),e||(e=o),n||(n=r),this.layoutManager_.setDocumentsLabels(e,n,i)};sync.diff.DiffLinksPresenter=function(t,e,i,n,o){this.container_=t,this.diffSelectionModel_=e,this.diffsModel_=i.getIntervals(!0).getDiffsModel(),this.intervalsPair_=i,this.primaryViewport_=i.getIntervals(!0).getViewport(),this.secondaryViewport_=i.getIntervals(!1).getViewport(),this.primaryLayoutChangeTracker_=n,this.secondaryLayoutChangeTracker_=o,this.selectedDiffLinkLeft_=null,this.selectedDiffLinkRight_=null,this.selectedDiffLinkMiddle_=null,this.leftContainer_=goog.dom.createDom("div","diff-links inner");var r=sync.diff.DiffDom.getDocumentNode(this.primaryViewport_).parentElement;r.appendChild(this.leftContainer_),this.rightContainer_=goog.dom.createDom("div","diff-links inner"),r=sync.diff.DiffDom.getDocumentNode(this.secondaryViewport_).parentElement,r.appendChild(this.rightContainer_),this.pendingRaf_=null};sync.diff.DiffLinksPresenter.prototype.attach=function(){goog.events.listen(this.diffSelectionModel_,sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,goog.bind(this.onDiffSelectionChanges_,this)),this.intervalsPair_.listen(sync.diff.EditorIntervalsPair.EventType.INTERVALS_UPDATED,this.onIntervalsUpdated_,!0,this),goog.events.listen(this.primaryViewport_,goog.events.EventType.SCROLL,goog.bind(this.updateLinks_,this,!1)),goog.events.listen(this.secondaryViewport_,goog.events.EventType.SCROLL,goog.bind(this.updateLinks_,this,!1)),goog.events.listen(this.container_,goog.events.EventType.CLICK,goog.bind(this.onLinkClick_,this)),goog.events.listen(this.leftContainer_,goog.events.EventType.CLICK,goog.bind(this.onLinkClick_,this)),goog.events.listen(this.rightContainer_,goog.events.EventType.CLICK,goog.bind(this.onLinkClick_,this))};sync.diff.DiffLinksPresenter.prototype.onIntervalsUpdated_=function(){this.updateLinks_(!0)};sync.diff.DiffLinksPresenter.prototype.updateLinks_=function(t){this.pendingRaf_||(this.pendingRaf_=!0,requestAnimationFrame(goog.bind(this.updateLinksRaf_,this,t)))};sync.diff.DiffLinksPresenter.prototype.updateLinksRaf_=function(t){this.pendingRaf_=!1;var e=[],i=[],n=[],o=this.intervalsPair_.getIntervals(!0),r=this.intervalsPair_.getIntervals(!1),s=o.getIntervals();if(r.getIntervals().length!==0)for(var f=0;f<s.length;f++){var d=s[f];if(!!d.diff){var c=r.getIntervalOfDiff(d.diff);if(!!c){var p=o.isVisible(d)||r.isVisible(c);if(p&&!d.isRectUncertain&&!c.isRectUncertain){var h=2,_={x:-2,y:d.rect.top-this.primaryViewport_.scrollTop-h},g={x:-2,y:d.rect.top+d.rect.height-this.primaryViewport_.scrollTop+h},u={x:102,y:c.rect.top-this.secondaryViewport_.scrollTop-h},D={x:102,y:c.rect.top+c.rect.height-this.secondaryViewport_.scrollTop+h},y=this.createDiffLink_(_,g,u,D);y.setAttribute("data-diff-id",d.diff.diffId),y.setAttribute("data-diff-type",d.diff.diffType),e.push(y)}t&&(!d.isRectUncertain&&i.push(this.createInsideDiffLink_(d)),!c.isRectUncertain&&n.push(this.createInsideDiffLink_(c)))}}}for(goog.dom.removeChildren(this.container_),f=0;f<e.length;f++)this.container_.appendChild(e[f]);if(t){for(goog.dom.removeChildren(this.leftContainer_),goog.dom.removeChildren(this.rightContainer_),f=0;f<i.length;f++)this.leftContainer_.appendChild(i[f]);for(f=0;f<n.length;f++)this.rightContainer_.appendChild(n[f])}this.selectDiffLink_(this.diffSelectionModel_.getSelectedDiff())};sync.diff.DiffLinksPresenter.prototype.createInsideDiffLink_=function(t){var e=goog.dom.createDom("div");e.setAttribute("data-diff-id",t.diff.diffId),e.setAttribute("data-diff-type",t.diff.diffType),goog.dom.classlist.set(e,"diff-link");var i=-2.5,n=3,o="calc(100% - 1px)",r="0px",s=t.rect.top+i,f=t.rect.height+n;return goog.style.setStyle(e,{top:s+"px",left:r,height:f+"px",width:o}),e};sync.diff.DiffLinksPresenter.prototype.createDiffLink_=function(t,e,i,n){var o=40,r=t.x+","+t.y,s=t.x+o+","+t.y,f=i.x-o+","+i.y,d=i.x+","+i.y,c=n.x+","+n.y,p=n.x-o+","+n.y,h=e.x+o+","+e.y,_=e.x+","+e.y,g=document.createElementNS("http://www.w3.org/2000/svg","path");g.setAttribute("d","M"+r+" C"+s+" "+f+" "+d+" L"+c+" C"+p+" "+h+" "+_+" Z");var u=document.createElementNS("http://www.w3.org/2000/svg","svg");return u.appendChild(g),u};sync.diff.DiffLinksPresenter.prototype.onLinkClick_=function(t){var e=t.target.localName==="path"?t.target.parentElement:t.target,i=e.getAttribute("data-diff-id");if(i!==null){var n=this.diffsModel_.getDiff(i);this.diffSelectionModel_.setSelection(n,!1)}else this.diffSelectionModel_.setSelection(null)};sync.diff.DiffLinksPresenter.prototype.onDiffSelectionChanges_=function(t){this.selectDiffLink_(t.diff)};sync.diff.DiffLinksPresenter.prototype.selectDiffLink_=function(t){t instanceof sync.diff.Diff&&(t=t.parentDiff),this.selectedDiffLinkMiddle_=this.selectDiffLinkPiece_(this.selectedDiffLinkMiddle_,t,this.container_),this.selectedDiffLinkLeft_=this.selectDiffLinkPiece_(this.selectedDiffLinkLeft_,t,this.leftContainer_),this.selectedDiffLinkRight_=this.selectDiffLinkPiece_(this.selectedDiffLinkRight_,t,this.rightContainer_)};sync.diff.DiffLinksPresenter.prototype.selectDiffLinkPiece_=function(t,e,i){this.primaryLayoutChangeTracker_.beginMutationWithoutLayoutEffects(),this.secondaryLayoutChangeTracker_.beginMutationWithoutLayoutEffects();try{t&&goog.dom.classlist.remove(t,"selected-diff"),e?(t=i.querySelector("[data-diff-id='"+e.diffId+"']"),t&&goog.dom.classlist.add(t,"selected-diff")):t=null}finally{this.primaryLayoutChangeTracker_.endMutationWithoutLayoutEffects(),this.secondaryLayoutChangeTracker_.endMutationWithoutLayoutEffects()}return t};sync.diff.DiffsModel=function(){this.diffIdToDiff={},this.parentDiffs=[],this.secondLevelDiffs=[]};sync.diff.DiffsModel.prototype.setDiffs=function(t){var e=t.parentDiffs,i=t.secondLevelDiffIds;this.parentDiffs=[],this.diffIdToDiff={},this.secondLevelDiffs=[];for(var n,o=0;o<e.length;o++)n=new sync.diff.ParentDiff(e[o]),this.parentDiffs.push(n),this.diffIdToDiff[n.diffId]=n;for(o=0;o<i.length;o++){var r=i[o],s=sync.diff.DiffsModel.getParentDiffId(r);n=this.diffIdToDiff[s];var f=new sync.diff.Diff(r,n);n.secondLevelDiffs.push(f),this.secondLevelDiffs.push(f),this.diffIdToDiff[r]=f}};sync.diff.DiffsModel.prototype.getParentDiffs=function(){return this.parentDiffs};sync.diff.DiffsModel.prototype.getSecondLevelDiffs=function(){return this.secondLevelDiffs};sync.diff.DiffsModel.prototype.getDiff=function(t){return this.diffIdToDiff[t]};sync.diff.DiffsModel.isParentDiffId=function(t){return t.indexOf(".")===-1};sync.diff.DiffsModel.getDiffType=function(t){return t.indexOf(".")===-1?sync.diff.DiffTypes.PARENT_DIFF:sync.diff.DiffTypes.SECOND_LEVEL_DIFF};sync.diff.DiffsModel.prototype.containsDiffId=function(t){if(sync.diff.DiffsModel.isParentDiffId(t)){var e=this.getParentDiffs();return e.findIndex(n=>n.diffId===t)!==-1}else{var i=this.getSecondLevelDiffs();return i.findIndex(n=>n.diffId===t)!==-1}};sync.diff.DiffsModel.getParentDiffId=function(t){return t.substring(0,t.indexOf("."))};sync.diff.ParentDiff=function(t){this.diffId=t.diffId,this.diffType=t.diffType,this.description=t.description,this.nodesIds=t.nodesIds!==void 0?t.nodesIds.map(function(e){return e.toString()}):null,this.nodeId=t.nodeId!==void 0?t.nodeId.toString():null,this.anchorNodeId=t.anchorNodeId!==void 0?t.anchorNodeId.toString():null,this.anchorDistance=t.anchorDistance,this.anchorSentinelType=t.anchorSentinelType,this.secondLevelDiffs=[]};sync.diff.DiffTypes={PARENT_DIFF:"parentDiff",SECOND_LEVEL_DIFF:"secondLevelDiff"};sync.diff.Diff=function(t,e){this.diffId=t,this.parentDiff=e};sync.diff.Diff.prototype.getParentDiffId=function(){return sync.diff.DiffsModel.getParentDiffId(this.diffId)};sync.diff.DiffsModelPair=function(t,e,i){goog.events.EventTarget.call(this),this.leftModel_=t,this.rightModel_=e,this.isOutOfDate_=!0,i.listen(sync.api.AuthorEditingSupport.EventType.MODEL_CHANGED,n=>{this.isOutOfDate_=!0,setTimeout(()=>{this.dispatchEvent(new goog.events.Event(sync.diff.DiffsModelPair.EventType.OUT_OF_DATE))},0)})};goog.inherits(sync.diff.DiffsModelPair,goog.events.EventTarget);sync.diff.DiffsModelPair.EventType={MODEL_CHANGED:"model-changed",OUT_OF_DATE:"model-out-of-date"};sync.diff.DiffsModelPair.ModelChangedEvent=function(){this.type=sync.diff.DiffsModelPair.EventType.MODEL_CHANGED};sync.diff.DiffsModelPair.prototype.getModel=function(t){return t?this.leftModel_:this.rightModel_};sync.diff.DiffsModelPair.prototype.isOutOfDate=function(){return this.isOutOfDate_};sync.diff.DiffsModelPair.prototype.setDiffs=function(t,e){this.leftModel_.setDiffs(t),this.rightModel_.setDiffs(e),this.isOutOfDate_=!1,this.dispatchEvent(new sync.diff.DiffsModelPair.ModelChangedEvent)};var a=window.msgs,l=window.tr;sync.diff.DiffNavigationManager=function(){};sync.diff.DiffNavigationManager.prototype.installActions=function(t,e,i,n){var o=this.registerActions_(t,i,n);return this.attachRefreshListeners_(t,o,e,n,i),o};sync.diff.DiffNavigationManager.prototype.registerActions_=function(t,e,i){var n=function(d,c,p,h){return new sync.diff.DiffActionNextChange(d,c,p,h,i)},o=sync.diff.DiffTypes.PARENT_DIFF,r=sync.diff.DiffTypes.SECOND_LEVEL_DIFF,s={"Diff/NextBlock":n(o,l(a.NEXT_BLOCK_),"DiffNextBlock24.png"),"Diff/PreviousBlock":n(o,l(a.PREVIOUS_BLOCK_),"DiffPreviousBlock24.png",!0),"Diff/Next":n(r,l(a.NEXT_CHANGE_),"DiffNext24.png"),"Diff/Previous":n(r,l(a.PREVIOUS_CHANGE_),"DiffPrevious24.png",!0)};for(var f in s)s.hasOwnProperty(f)&&t.registerAction(f,s[f]);return Object.keys(s)};sync.diff.DiffNavigationManager.prototype.attachRefreshListeners_=function(t,e,i,n,o){var r=goog.bind(function(){t.refreshActionsStatus.apply(t,e)},this);i.listen(sync.api.SelectionModel.EventType.SELECTION_CHANGED,r),n.listen(sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,r),o.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,r)};sync.diff.DiffPerformer=function(t,e,i,n,o){this.primaryEditor_=i,this.secondaryEditor_=n,this.diffsModelPair_=o,this.noticeStripeManager_=t,this.spinner_=new sync.view.Spinner(e.getDiffLinksContainer(),0),this.inProgress_=!1,this.initialDiffPerformed_=!1};sync.diff.DiffPerformer.STATUS={FAIL_TO_LOAD_BASE:"fail-load-base",NO_DIFF:"no-diff",NO_AUTHOR_DIFF:"no-author-diff"};var v=class extends Error{constructor(){super()}};sync.diff.DiffPerformer.COMPUTE_DIFFS_OPERATION="com.oxygenxml.webapp.diff.operations.ComputeDiffsOperation";sync.diff.DiffPerformer.SHOW_DIFFS_OPERATION="com.oxygenxml.webapp.diff.operations.ShowDiffsOperation";sync.diff.DiffPerformer.prototype.performDiff=function(){return this.spinner_.show(),this.inProgress_=!0,this.invokeOperationInBackground_(this.primaryEditor_,sync.diff.DiffPerformer.COMPUTE_DIFFS_OPERATION).then(t=>JSON.parse(t)).then(t=>this.throwIfFailed_(t)).then(t=>this.showDiffResultWithoutScheduler(t)).then(t=>this.diffsModelPair_.setDiffs(t.leftDiffsDescriptors,t.rightDiffsDescriptors)).finally(()=>{this.initialDiffPerformed_=!0,this.inProgress_=!1,this.spinner_.hide()})};sync.diff.DiffPerformer.prototype.performDiffWithoutLocking=function(){return this.initialDiffPerformed_?(this.spinner_.show(),this.inProgress_=!0,this.computeDiffsWithoutLocking_().then(t=>this.throwIfFailed_(t)).then(t=>this.showDiffResult_(t)).then(t=>this.diffsModelPair_.setDiffs(t.leftDiffsDescriptors,t.rightDiffsDescriptors)).finally(()=>{this.inProgress_=!1,this.spinner_.hide()})):Promise.resolve()};sync.diff.DiffPerformer.prototype.computeDiffsWithoutLocking_=function(){var t="../plugins-dispatcher/compute-diffs?docId="+this.primaryEditor_.docId;return fetch(t).then(e=>{if(e.status!==200)throw new Error("status "+e.status);return e.json()})};sync.diff.DiffPerformer.prototype.throwIfFailed_=function(t){if(t.success)return t;if(t.staleDoc)throw new v;var e=t.message?t.message:"Unable to perform diff.";throw window.workspace.getNotificationManager().showError(e),new Error(e)};sync.diff.DiffPerformer.prototype.showDiffResult_=function(t){return Promise.all([this.invokeShowDiffsOperationWithinScheduler_(this.primaryEditor_),this.invokeShowDiffsOperationWithinScheduler_(this.secondaryEditor_)]).then(e=>(this.throwIfFailed_(JSON.parse(e[0])),this.throwIfFailed_(JSON.parse(e[1])),this.noticeStripeManager_.setStatus(t.status),t))};sync.diff.DiffPerformer.prototype.showDiffResultWithoutScheduler=function(t){return Promise.all([this.invokeShowDiffsOperation_(this.primaryEditor_),this.invokeShowDiffsOperation_(this.secondaryEditor_)]).then(()=>(this.noticeStripeManager_.setStatus(t.status),t)).catch(e=>{throw workspace.getNotificationManager().showError("Unable to perform diff."),e})};sync.diff.DiffPerformer.prototype.createSelectionRestorer_=function(t){return t===this.primaryEditor_?new sync.diff.DiffPerformerSelectionRestorer(this.primaryEditor_):null};sync.diff.DiffPerformer.prototype.invokeShowDiffsOperation_=function(t){var e=this.createSelectionRestorer_(t);return e&&e.diffsWillBeUpdated(),this.invokeOperationInBackground_(t,sync.diff.DiffPerformer.SHOW_DIFFS_OPERATION).finally(i=>(e&&e.diffsUpdated(),i))};sync.diff.DiffPerformer.prototype.invokeOperationInBackground_=function(t,e){return sync.util.promise.nativePromise(t.getActionsManager().invokeOperation(e,{},null,null,!0))};sync.diff.DiffPerformer.prototype.invokeShowDiffsOperationWithinScheduler_=function(t){return new Promise((e,i)=>{t.getActionsExecutor().executeUpdate(new sync.actions.Action({execute:()=>this.invokeShowDiffsOperation_(t).then(e,i)}))})};sync.diff.DiffPerformer.prototype.isInProgress=function(){return this.inProgress_};sync.diff.DiffPerformerSelectionRestorer=function(t){this.editingSupport_=t,this.saveCurrentSelectionFn_=this.saveCurrentSelection_.bind(this),this.restoreLastSavedSelectionFn_=this.restoreLastSavedSelection_.bind(this)};sync.diff.DiffPerformerSelectionRestorer.prototype.saveCurrentSelection_=function(){this.lastSelectionBeforeModelChanged_=this.editingSupport_.getSelectionManager().getSelection().save()};sync.diff.DiffPerformerSelectionRestorer.prototype.restoreLastSavedSelection_=function(){this.lastSelectionBeforeModelChanged_&&(this.editingSupport_.getSelectionManager().setSelection(this.lastSelectionBeforeModelChanged_.restore()),this.lastSelectionBeforeModelChanged_=null)};sync.diff.DiffPerformerSelectionRestorer.prototype.diffsWillBeUpdated=function(){var t=this.editingSupport_.getController();t.listen(sync.ctrl.Controller.EventType.BEFORE_MODEL_CHANGED,this.saveCurrentSelectionFn_),t.listen(sync.ctrl.Controller.EventType.MODEL_CHANGED,this.restoreLastSavedSelectionFn_)};sync.diff.DiffPerformerSelectionRestorer.prototype.diffsUpdated=function(){var t=this.editingSupport_.getController();t.unlisten(sync.ctrl.Controller.EventType.BEFORE_MODEL_CHANGED,this.saveCurrentSelectionFn_),t.unlisten(sync.ctrl.Controller.EventType.MODEL_CHANGED,this.restoreLastSavedSelectionFn_)};sync.diff.DiffSelectionManager=function(t,e,i,n,o){this.diffSelectionModel_=t,this.intervalsPair_=e,this.primarySelectionManager_=i,this.secondarySelectionManager_=n,this.diffsModelPair_=o};sync.diff.DiffSelectionManager.prototype.attach=function(){var t=this.intervalsPair_.getIntervals(!0),e=this.intervalsPair_.getIntervals(!1),i=t.getViewport().parentElement;goog.events.listen(i,goog.events.EventType.CLICK,goog.bind(this.onDocumentRootClick_,this,t.getViewport(),t),!0);var n=e.getViewport().parentElement;goog.events.listen(n,goog.events.EventType.CLICK,goog.bind(this.onDocumentRootClick_,this,e.getViewport(),e),!0),goog.events.listen(this.primarySelectionManager_,sync.api.SelectionModel.EventType.SELECTION_CHANGED,goog.bind(this.onSelectionChanged_,this)),goog.events.listen(this.secondarySelectionManager_,sync.api.SelectionModel.EventType.SELECTION_CHANGED,goog.bind(this.onSelectionChanged_,this)),this.diffsModelPair_.listen(sync.diff.DiffsModelPair.EventType.OUT_OF_DATE,o=>this.diffSelectionModel_.setSelection(null))};sync.diff.DiffSelectionManager.prototype.onSelectionChanged_=function(t){t.target.getSelection().isEmpty()||this.diffSelectionModel_.setSelection(null)};sync.diff.DiffSelectionManager.prototype.onDocumentRootClick_=function(t,e,i){if(!this.primarySelectionManager_.getSelection().isEmpty()||!this.secondarySelectionManager_.getSelection().isEmpty()){this.diffSelectionModel_.setSelection(null);return}var n=goog.dom.getAncestor(i.target,function(f){return sync.diff.DiffDom.getDiffId(f)!==null},!0);if(n){var o=e.getDiffsModel(),r=sync.diff.DiffDom.getDiffId(n),s=o.getDiff(r);this.diffSelectionModel_.setSelection(s,!1)}else this.selectParentDiff_(t,e,i)};sync.diff.DiffSelectionManager.prototype.selectParentDiff_=function(t,e,i){var n=i.clientY+t.scrollTop;n-=this.intervalsPair_.getIntervals(!0).getEditorsContainerBounds().top;var o=e.getIntervalAt(n);o?o.diff?this.diffSelectionModel_.setSelection(o.diff,!1):this.diffSelectionModel_.setSelection(null):console.warn("Fail to detect interval at click. ",i,n,e)};sync.diff.DiffSelectionModel=function(t){goog.events.EventTarget.call(this),this.selectedDiff_=null,this.lastSelectedDiff_=null,this.diffsModelPair_=t};goog.inherits(sync.diff.DiffSelectionModel,goog.events.EventTarget);sync.diff.DiffSelectionModel.EventType={DIFF_SELECTION_CHANGED:"selection_changed"};sync.diff.DiffSelectionModel.DiffSelectionEvent=function(t,e){this.diff=t,this.type=sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,this.shouldScrollToFullyVisible=e};sync.diff.DiffSelectionModel.prototype.getSelectedDiff=function(){return this.selectedDiff_};sync.diff.DiffSelectionModel.prototype.attach=function(){this.diffsModelPair_.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,function(){var t=this.diffsModelPair_.getModel(!0),e;this.lastSelectedDiff_&&(e=t.containsDiffId(this.lastSelectedDiff_.diffId),e||(this.lastSelectedDiff_=null)),this.selectedDiff_&&(e=t.containsDiffId(this.selectedDiff_.diffId),e||this.setSelection(null))}.bind(this)),this.diffsModelPair_.listenOnce(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,function(){var t=this.diffsModelPair_.getModel(!0).getParentDiffs();if(t.length!==0){var e=t[0];this.setSelection(e,!1)}}.bind(this))};sync.diff.DiffSelectionModel.prototype.setSelection=function(t,e){var i=this.getSelectedDiff();i&&t&&i.diffId===t.diffId||t===null&&i===null||t instanceof sync.diff.ParentDiff&&i instanceof sync.diff.Diff&&i.getParentDiffId()===t.diffId||(this.selectedDiff_=t,t&&(this.lastSelectedDiff_=t),e!==!0&&e!==!1&&(e=!1),this.dispatchEvent(new sync.diff.DiffSelectionModel.DiffSelectionEvent(t,e)))};sync.diff.DiffSelectionModel.prototype.getNextElementFromArray_=function(t,e,i){for(var n=null,o=0;o<t.length;o++)if(e(t[o])){i?o>0&&(n=t[o-1]):o<t.length-1&&(n=t[o+1]);break}return n};sync.diff.DiffSelectionModel.prototype.getNextDiffOfType=function(t,e){var i,n=this.selectedDiff_;return n?t===sync.diff.DiffTypes.PARENT_DIFF?i=this.getNextParentDiff_(n,e):i=this.getNextSecondLevelDiff_(n,e):this.lastSelectedDiff_?i=this.getLastSelectedDiffOfType_(t):i=this.getFirstDiffOfType_(t),i};sync.diff.DiffSelectionModel.prototype.getNextParentDiff_=function(t,e){var i,n;sync.diff.DiffsModel.isParentDiffId(t.diffId)?n=t.diffId:n=t.parentDiff.diffId;var o=this.diffsModelPair_.getModel(!0).getParentDiffs();return i=this.getNextElementFromArray_(o,function(r){return r.diffId===n},e),i};sync.diff.DiffSelectionModel.prototype.getNextSecondLevelDiff_=function(t,e){var i;if(sync.diff.DiffsModel.isParentDiffId(t.diffId))if(e){var n=this.getNextParentDiff_(t,e);n&&(i=n.secondLevelDiffs[n.secondLevelDiffs.length-1])}else i=t.secondLevelDiffs[0];else{var o=this.diffsModelPair_.getModel(!0).getSecondLevelDiffs();return this.getNextElementFromArray_(o,function(r){return r.diffId===t.diffId},e)}return i};sync.diff.DiffSelectionModel.prototype.getFirstDiffOfType_=function(t){var e,i;return t===sync.diff.DiffTypes.PARENT_DIFF?i=this.diffsModelPair_.getModel(!0).getParentDiffs():i=this.diffsModelPair_.getModel(!0).getSecondLevelDiffs(),i.length&&(e=i[0]),e};sync.diff.DiffSelectionModel.prototype.getLastSelectedDiffOfType_=function(t){var e=this.lastSelectedDiff_;return sync.diff.DiffsModel.getDiffType(e.diffId)!==t&&(t===sync.diff.DiffTypes.PARENT_DIFF?e=e.parentDiff:e=e.secondLevelDiffs[0]),e};var a=window.msgs,l=window.tr;sync.diff.DiffTagsModeManager=function(t){this.currentMode_=null,this.tagsModeEnforced_=t[sync.diff.DiffTagsModeManager.TAGS_MODE_ENFORCED],this.dropdownIcon_=goog.dom.createDom("div",{className:"ui-action-large-icon"}),this.updateToolbarIcon(sync.diff.DiffTagsModeManager.getTagsModeOption(t))};sync.diff.DiffTagsModeManager.TAGS_MODE_EDITOR_OPTION="tags-mode";sync.diff.DiffTagsModeManager.DIFF_TAGS_MODE_OPTION="diffTagsMode";sync.diff.DiffTagsModeManager.TAGS_MODE_ENFORCED="tagsModeEnforced";sync.diff.DiffTagsModeManager.tagModeInfo={FULL_TAGS_WITH_ATTRIBUTES:{id:"full-tags-with-attributes",iconName:"FullTagsWithAttrs"},FULL_TAGS:{id:"full-tags",iconName:"FullTags"},BLOCK_TAGS:{id:"block-tags",iconName:"BlockTags"},INLINE_TAGS:{id:"inline-tags",iconName:"InlineTags"},PARTIAL_TAGS:{id:"partial-tags",iconName:"PartialTags"},NO_TAGS:{id:"no-tags",iconName:"NoTags"}};sync.diff.DiffTagsModeManager.getTagsModeOption=function(t){var e=t[sync.diff.DiffTagsModeManager.TAGS_MODE_EDITOR_OPTION];if(e)!t[sync.diff.DiffTagsModeManager.TAGS_MODE_ENFORCED]&&sync.diff.DiffTagsModeManager.getTagModeInfo(e)&&(t[sync.diff.DiffTagsModeManager.TAGS_MODE_ENFORCED]=e);else{try{e=localStorage.getItem(sync.diff.DiffTagsModeManager.DIFF_TAGS_MODE_OPTION)}catch{}e||(e=sync.diff.DiffTagsModeManager.tagModeInfo.FULL_TAGS_WITH_ATTRIBUTES.id)}return e};sync.diff.DiffTagsModeManager.prototype.updateToolbarIcon=function(t){var e=this.dropdownIcon_;t||(t=sync.diff.DiffTagsModeManager.tagModeInfo.FULL_TAGS_WITH_ATTRIBUTES.id);var i=sync.diff.DiffTagsModeManager.getTagModeInfo(t);if(i){e.title=this.getTagsDisplayModeDescription_(i.id);var n=sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/"+i.iconName+"24.png");e.style.backgroundImage="url("+n+")"}};sync.diff.DiffTagsModeManager.prototype.getTagsDisplayModeDropdown_=function(){var t=[],e=sync.diff.DiffTagsModeManager.tagModeInfo;for(var i in e)e.hasOwnProperty(i)&&t.push({type:"action",id:e[i].id});return{type:"list",name:"diff_tags_display_mode",displayName:l(a.TAGS_DISPLAY_MODE_),iconDom:this.dropdownIcon_,children:t}};sync.diff.DiffTagsModeManager.prototype.getTagsDisplayModeDescription_=function(t){switch(t){case"full-tags-with-attributes":return l(a.FULL_TAGS_WITH_ATTRIBUTES_);case"full-tags":return l(a.FULL_TAGS_);case"block-tags":return l(a.BLOCK_TAGS_);case"inline-tags":return l(a.INLINE_TAGS_);case"partial-tags":return l(a.PARTIAL_TAGS_);case"no-tags":return l(a.NO_TAGS_);default:return"undefined"}};sync.diff.DiffTagsModeManager.prototype.installActions=function(t,e,i){this.primaryEditingSupport_=e,this.secondaryEditingSupport_=i;var n=sync.diff.DiffTagsModeManager.tagModeInfo;for(var o in n)if(n.hasOwnProperty(o)){var r=n[o];t.registerAction(r.id,new sync.diff.DiffActionTagsMode(r.id,this.getTagsDisplayModeDescription_(r.id),r.iconName,this))}return this.getTagsDisplayModeDropdown_()};sync.diff.DiffTagsModeManager.prototype.isInitialized=function(){return this.primaryEditingSupport_&&this.secondaryEditingSupport_};sync.diff.DiffTagsModeManager.prototype.shouldShowTagsModeDropdown=function(){return!this.tagsModeEnforced_};sync.diff.DiffTagsModeManager.prototype.switchTo=function(t){if(this.currentMode_!==t){try{localStorage.setItem(sync.diff.DiffTagsModeManager.DIFF_TAGS_MODE_OPTION,t)}catch{}this.primaryEditingSupport_&&this.primaryEditingSupport_.setTagsDisplayMode(t),this.secondaryEditingSupport_&&this.secondaryEditingSupport_.setTagsDisplayMode(t),this.currentMode_=t,this.updateToolbarIcon(t)}};sync.diff.DiffTagsModeManager.getTagModeInfo=function(t){var e,i=goog.object.findValue(sync.diff.DiffTagsModeManager.tagModeInfo,function(n){return n.id===t});return i&&(e=i),e};sync.diff.DiffToSelection=function(t,e,i){this.diffsHighlightsManager_=t,this.selectionManager_=e,this.document_=i};sync.diff.DiffToSelection.prototype.getSelectionFor=function(t){var e;if(t instanceof sync.diff.ParentDiff)if(t.secondLevelDiffs&&t.secondLevelDiffs.length!==0){var i=t.secondLevelDiffs[0];e=this.diffsHighlightsManager_.getHighlightSelection(i.diffId)}else{var n=this.document_.createApiNodeOrParent(t.anchorNodeId),o=t.anchorSentinelType===1;e=this.selectionManager_.createEmptySelectionRelativeToNode(n,t.anchorDistance,o)}else e=this.diffsHighlightsManager_.getHighlightSelection(t.diffId);return e};sync.diff.DiffsAutoUpdater=function(t){this.diffPerformer_=t,this.recomputeDiffsDelay_=new goog.async.Delay(this.recomputeDiffs.bind(this),500)};sync.diff.DiffsAutoUpdater.prototype.attach=function(t){t.listen(sync.diff.DiffsModelPair.EventType.OUT_OF_DATE,()=>this.recomputeDiffsAfterDelay())};sync.diff.DiffsAutoUpdater.prototype.recomputeDiffs=function(){if(!this.diffPerformer_.isInProgress())return this.diffPerformer_.performDiffWithoutLocking().catch(t=>{t instanceof v?this.recomputeDiffsAfterDelay():(console.warn(t),window.workspace.getNotificationManager().showError("Unable to perform diff."))})};sync.diff.DiffsAutoUpdater.prototype.recomputeDiffsAfterDelay=function(){this.recomputeDiffsDelay_.start()};sync.diff.DiffsHighlightsManager=function(t,e,i,n){this.highlightsManager_=t,this.diffSelectionModel_=e,this.diffsModel_=i,this.layoutChangeTracker_=n,this.highlightIdToDiffIdMap_=new sync.diff.HighlightsIdsToDiffIdsMap};sync.diff.DiffsHighlightsManager.prototype.attach=function(){goog.events.listen(this.diffSelectionModel_,sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,goog.bind(this.onDiffSelectionChanges_,this)),goog.events.listen(this.highlightsManager_,sync.api.HighlightUpdateEvent.EventType.HIGHLIGHT_ADDED,goog.bind(function(t){var e=t.id;if(e){var i=this.highlightsManager_.getHighlightAttributes(e),n=i.get("diff-id");n&&this.highlightIdToDiffIdMap_.set(e,n)}},this)),goog.events.listen(this.highlightsManager_,sync.api.HighlightUpdateEvent.EventType.HIGHLIGHT_REMOVED,goog.bind(function(t){var e=t.id;e&&this.highlightIdToDiffIdMap_.remove(e)},this))};sync.diff.DiffsHighlightsManager.prototype.onDiffSelectionChanges_=function(t){if(this.unselectLastSelectedHighlight_(),t.diff){var e=t.diff.diffId;this.selectDiffs_([e])}};sync.diff.DiffsHighlightsManager.prototype.selectDiffs_=function(t){t&&t.forEach(goog.bind(function(e){var i=this.highlightIdToDiffIdMap_.getHighlightId(e);this.setSelected_(i,!0)},this))};sync.diff.DiffsHighlightsManager.prototype.getHighlightSelection=function(t){var e=this.highlightIdToDiffIdMap_.getHighlightId(t);return this.highlightsManager_.getHighlightSelection(e)};sync.diff.DiffsHighlightsManager.prototype.setSelected_=function(t,e){if(t){this.lastSelectedHighlightId_=e?t:null,this.layoutChangeTracker_.beginMutationWithoutLayoutEffects();try{this.highlightsManager_.updateHighlight(t,e?"diff selected-diff":"diff")}finally{this.layoutChangeTracker_.endMutationWithoutLayoutEffects()}}};sync.diff.DiffsHighlightsManager.prototype.unselectLastSelectedHighlight_=function(){if(this.lastSelectedHighlightId_){var t=this.highlightsManager_.getHighlightAttributes(this.lastSelectedHighlightId_).size!==0;t&&this.setSelected_(this.lastSelectedHighlightId_,!1)}};sync.diff.EditorInterval=function(t,e,i){this.rect=t,this.diff=e,i!==!0&&i!==!1?this.isRectUncertain=!1:this.isRectUncertain=i};sync.diff.EditorIntervals=function(t,e,i,n,o){this.editorsContainer_=t,this.viewport_=e,this.diffsModel_=i,this.diffHighlightsManager_=n,this.layoutChangeDispatcher_=o,this.intervals_=[],this.diffIdToInterval_={},this.secondDiffIdToInterval_={},this.diffIntervals_={},this.editorsContainerBounds_={},this.uncertainParentDiffIntervals=[]};sync.diff.EditorIntervals.prototype.updateIntervals=function(t){this.layoutChangeDispatcher_.beginMutationWithoutLayoutEffects();try{this.computeParentDiffAndEqualZonesIntervals_(),t&&this.computeSecondLevelDiffIntervals_()}finally{this.layoutChangeDispatcher_.endMutationWithoutLayoutEffects()}};sync.diff.EditorIntervals.prototype.isVisible=function(t,e,i){var n=t.rect;if(n===null)return!1;i==null&&(i=0);var o=this.viewport_.scrollTop+i,r=this.viewport_.scrollTop+this.editorsContainerBounds_.height-i;return e?n.top>=o&&n.top+n.height<=r:n.top+n.height>=o&&n.top<=r};sync.diff.EditorIntervals.prototype.getIntervalOfDiff=function(t){return t instanceof sync.diff.ParentDiff?this.diffIdToInterval_[t.diffId]:this.secondDiffIdToInterval_[t.diffId]};sync.diff.EditorIntervals.prototype.computeParentDiffAndEqualZonesIntervals_=function(){this.updateEditorsContainerBounds(),this.intervals_=[];for(var t=this.getParentDiffIntervals_(),e=0,i=0;i<t.length;i++){this.diffIdToInterval_[t[i].diff.diffId]=t[i];var n;if(t[i].rect!==null){var o=e,r=Math.max(0,t[i].rect.top-e);n=new goog.math.Rect(null,o,null,r);var s=new sync.diff.EditorInterval(n,null);this.intervals_.push(s),e=t[i].rect.top+t[i].rect.height}this.intervals_.push(t[i])}n=new goog.math.Rect(0,e,0,this.viewport_.scrollHeight-e),this.intervals_.push(new sync.diff.EditorInterval(n,null))};sync.diff.EditorIntervals.prototype.getEditorsContainerBounds=function(){return this.editorsContainerBounds_};sync.diff.EditorIntervals.prototype.computeEditorsContainerBounds=function(){return goog.style.getBounds(this.editorsContainer_)};sync.diff.EditorIntervals.prototype.updateEditorsContainerBounds=function(){this.editorsContainerBounds_=this.computeEditorsContainerBounds()};sync.diff.EditorIntervals.prototype.getParentDiffIntervals_=function(){var t=[],e=this.diffsModel_.parentDiffs;this.uncertainParentDiffIntervals=[];for(var i=0;i<e.length;i++){var n=e[i],o=this.getParentDiffBounds_(n),r;if(o!==null)o.top-=this.editorsContainerBounds_.top,o.top+=this.viewport_.scrollTop,o.left+=this.viewport_.scrollLeft,r=new sync.diff.EditorInterval(o,n);else{if(this.hiddenDiffsDetected_=!0,console.warn("no rect for parent diff interval ",n),t.length!==0){var s=t[t.length-1].rect;o=new goog.math.Rect(0,s.top+s.height,0,10)}else o=new goog.math.Rect(0,0,0,10);r=new sync.diff.EditorInterval(o,n,!0),this.uncertainParentDiffIntervals.push(r)}t.push(r)}return t.sort(function(f,d){return f.rect.top-d.rect.top}),t};sync.diff.EditorIntervals.prototype.getParentDiffBounds_=function(t){var e=null;try{switch(t.description){case"BLOCK":e=this.getBlockParentDiffBounds_(t);break;case"START_ADDED":case"START_CHANGE":e=this.getSentinelParentDiffBounds_(t,!0);break;case"END_ADDED":case"END_CHANGE":e=this.getSentinelParentDiffBounds_(t,!1);break;case"UNKNOWN":case"INLINES":e=this.getParentDiffBoundsBasedOnSecondLevel_(t);break;case"EMPTY":e=this.getEmptyParentDiffBounds_(t);break}}catch(i){if(i instanceof sync.dom.StaleNodeError)e=this.getParentDiffBoundsBasedOnSecondLevel_(t);else throw i}return e};sync.diff.EditorIntervals.prototype.getSentinelParentDiffBounds_=function(t,e){return sync.caret.ContentIterator.createSelectionAroundSentinel(t.nodeId,e).getBoundingClientRect()};sync.diff.EditorIntervals.prototype.getEmptyParentDiffBounds_=function(t){var e=this.getParentDiffBoundsBasedOnSecondLevel_(t);if(!e){var i=sync.api.dom.createApiNode(t.anchorNodeId),n=t.anchorSentinelType===1,o=sync.api.Selection.createEmptySelectionRelativeToNode(i,t.anchorDistance,n);e=o.getBoundingClientRect(),e.top+=e.height-1,e.height=1}return e};sync.diff.EditorIntervals.prototype.getParentDiffBoundsBasedOnSecondLevel_=function(t){var e=null;return t.secondLevelDiffs.forEach(i=>{var n=this.getSecondLevelHighlightBounds_(i);n&&(e=this.getBoundsThatCover_(e,n))}),e};sync.diff.EditorIntervals.prototype.getSecondLevelHighlightBounds_=function(t){var e=t.diffId,i=this.diffHighlightsManager_.getHighlightSelection(e);return i?i.getBoundingClientRect():null};sync.diff.EditorIntervals.prototype.getBlockParentDiffBounds_=function(t){var e=null,i=t.nodesIds;if(i)for(var n=0;n<i.length;n++){var o=i[n];if(o){var r=sync.api.dom.createApiNode(o),s=r.getBoundingClientRect();e=this.getBoundsThatCover_(e,s)}}return e};sync.diff.EditorIntervals.prototype.computeSecondLevelDiffIntervals_=function(){this.secondDiffIdToInterval_={},this.diffIntervals_=[];for(var t=this.editorsContainerBounds_.top,e=0;e<this.diffsModel_.parentDiffs.length;e++)for(var i=this.diffsModel_.parentDiffs[e],n=i.secondLevelDiffs,o=0;o<n.length;o++){var r=n[o],s=this.getSecondLevelDiffDiffBounds_(i,r),f;if(s!==null)s.top-=t,s.top+=this.viewport_.scrollTop,s.left+=this.viewport_.scrollLeft,f=new sync.diff.EditorInterval(s,r),this.ensureParentIntervalsCoversSecondLevel_(this.diffIdToInterval_[i.diffId],f);else{var d=this.diffIdToInterval_[i.diffId];if(d.isRectUncertain)if(this.diffIntervals_.length!==0){var c=this.diffIntervals_[this.diffIntervals_.length-1].rect;s=new goog.math.Rect(0,c.top+c.height,0,10)}else s=new goog.math.Rect(0,0,0,10);else{var p=d.rect.top,h=Math.min(10,d.rect.height);s=new goog.math.Rect(0,p,0,h)}f=new sync.diff.EditorInterval(s,r,!0),console.warn("no rect for diff interval ",r)}this.secondDiffIdToInterval_[r.diffId]=f,this.diffIntervals_.push(f)}};sync.diff.EditorIntervals.prototype.getSecondLevelDiffDiffBounds_=function(t,e){var i=null;switch(t.description){case"START_ADDED":case"START_CHANGE":i=sync.caret.ContentIterator.createSelectionAroundSentinel(t.nodeId,!0).getBoundingClientRect();break;case"END_ADDED":case"END_CHANGE":i=sync.caret.ContentIterator.createSelectionAroundSentinel(t.nodeId,!1).getBoundingClientRect();break;case"BLOCK":case"UNKNOWN":case"INLINES":case"EMPTY":var n=this.diffHighlightsManager_.getHighlightSelection(e.diffId);n&&(i=n.getBoundingClientRect());break}return i};sync.diff.EditorIntervals.prototype.ensureParentIntervalsCoversSecondLevel_=function(t,e){var i=e.rect,n=t.rect;n.top>i.top&&(n.top=i.top),n.top+n.height<i.top+i.height&&(n.height=i.top+i.height-n.top),t.isRectUncertain&&(t.isRectUncertain=!1,t.rect=e.rect,this.uncertainParentDiffIntervals.splice(this.uncertainParentDiffIntervals.indexOf(t),1))};sync.diff.EditorIntervals.prototype.getIntervalAt=function(t){var e=goog.array.binarySelect(this.intervals_,function(i){return i.rect===null?1:i.rect.top<=t&&t<=i.rect.top+i.rect.height?0:t-i.rect.top});return e>=0?this.intervals_[e]:null};sync.diff.EditorIntervals.prototype.getBoundsThatCover_=function(t,e){if(t){if(!e)return t}else return e;var i=t,n=e;return n.top===0&&n.height===0||(n.top<i.top&&(i.top=n.top),n.top+n.height>i.top+i.height&&(i.height=n.top+n.height-i.top)),i};sync.diff.EditorIntervals.prototype.getViewport=function(){return this.viewport_};sync.diff.EditorIntervals.prototype.getDiffsModel=function(){return this.diffsModel_};sync.diff.EditorIntervals.prototype.getViewportHeight=function(){return this.viewport_.scrollHeight};sync.diff.EditorIntervals.prototype.getIntervals=function(){return this.intervals_};sync.diff.EditorIntervals.prototype.getDiffIntervals=function(){return this.diffIntervals_};sync.diff.EditorIntervals.prototype.isHiddenDiffsDetected=function(){return this.uncertainParentDiffIntervals.length!==0};sync.diff.EditorIntervalsPair=function(t,e,i){goog.events.EventTarget.call(this),this.diffsModelPair_=t,this.leftIntervals_=e,this.rightIntervals_=i};goog.inherits(sync.diff.EditorIntervalsPair,goog.events.EventTarget);sync.diff.EditorIntervalsPair.EventType={INTERVALS_UPDATED:"intervals_updated"};sync.diff.EditorIntervalsPair.IntervalsUpdatedEvent=function(){this.type=sync.diff.EditorIntervalsPair.EventType.INTERVALS_UPDATED,this.diffModelWasChanged=!1};sync.diff.EditorIntervalsPair.IntervalsUpdatedEvent.prototype.setDiffModelWasChanged=function(t){this.diffModelWasChanged=t};sync.diff.EditorIntervalsPair.prototype.attach=function(){this.diffsModelPair_.listenOnce(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,goog.bind(function(){this.attachLayoutChangeListener_(this.leftIntervals_),this.attachLayoutChangeListener_(this.rightIntervals_)},this)),this.diffsModelPair_.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,goog.bind(function(){this.leftIntervals_.updateIntervals(!0),this.rightIntervals_.updateIntervals(!0);var t=new sync.diff.EditorIntervalsPair.IntervalsUpdatedEvent;t.setDiffModelWasChanged(!0),this.dispatchEvent(t)},this))};sync.diff.EditorIntervalsPair.prototype.attachLayoutChangeListener_=function(t){var e=goog.functions.debounce(goog.bind(function(){t.updateIntervals(!0),this.dispatchEvent(new sync.diff.EditorIntervalsPair.IntervalsUpdatedEvent)},this),250);goog.events.listen(t.layoutChangeDispatcher_,sync.view.LayoutChangeEvent.EVENT_TYPE,e,!0)};sync.diff.EditorIntervalsPair.prototype.getIntervals=function(t){return t?this.leftIntervals_:this.rightIntervals_};sync.diff.EditorIntervalsPair.prototype.updateEditorsContainerBounds=function(){this.leftIntervals_.updateEditorsContainerBounds(),this.rightIntervals_.updateEditorsContainerBounds()};sync.diff.HighlightsIdsToDiffIdsMap=function(){this.highlightIdToDiffIdMap_=new Map,this.diffIdToHighlightIdMap_=new Map};sync.diff.HighlightsIdsToDiffIdsMap.prototype.set=function(t,e){this.highlightIdToDiffIdMap_.set(t,e),this.diffIdToHighlightIdMap_.set(e,t)};sync.diff.HighlightsIdsToDiffIdsMap.prototype.remove=function(t){var e=this.highlightIdToDiffIdMap_.get(t);this.highlightIdToDiffIdMap_.delete(t),this.diffIdToHighlightIdMap_.delete(e)};sync.diff.HighlightsIdsToDiffIdsMap.prototype.getHighlightId=function(t){return this.diffIdToHighlightIdMap_.get(t)};sync.diff.HighlightsIdsToDiffIdsMap.prototype.getDiffId=function(t){return this.highlightIdToDiffIdMap_.get(t)};sync.diff.HorizontalScrollDetector=function(t,e){goog.events.EventTarget.call(this),this.scrollable_=t,this.editingSupport_=e,this.hasScroll_=this.haveScroll_()};goog.inherits(sync.diff.HorizontalScrollDetector,goog.events.EventTarget);sync.diff.HorizontalScrollDetector.EventType={HORIZ_SCROLLBAR_APPEARED:"hor_scroll_app"};sync.diff.HorizontalScrollDetector.prototype.attach=function(){var t=document.createElement("iframe");t.style.cssText="height:0;background-color:transparent;margin:0;padding:0;overflow:hidden;border-width:0;position:absolute;width:100%;",t.onload=()=>{t.contentWindow.addEventListener("resize",()=>this.dispatchIfScrollbarAppeared_())},this.scrollable_.firstChild.appendChild(t)};sync.diff.HorizontalScrollDetector.prototype.dispatchIfScrollbarAppeared_=function(){var t=this.haveScroll_();!this.hasScroll_&&t&&this.dispatchEvent(new goog.events.Event(sync.diff.HorizontalScrollDetector.EventType.HORIZ_SCROLLBAR_APPEARED)),this.hasScroll_=t};sync.diff.HorizontalScrollDetector.prototype.haveScroll_=function(){return this.scrollable_.scrollWidth>this.scrollable_.clientWidth};sync.diff.HorizontalScrollFixer=function(t,e){this.scrollable_=t,this.horizontalScrollDetector_=new sync.diff.HorizontalScrollDetector(t,e)};sync.diff.HorizontalScrollFixer.prototype.attach=function(){this.horizontalScrollDetector_.attach(),this.horizontalScrollDetector_.listen(sync.diff.HorizontalScrollDetector.EventType.HORIZ_SCROLLBAR_APPEARED,this.moveScrollOnLeft_.bind(this)),window.workspace.listen(sync.api.Workspace.EventType.EDITOR_LOADED,()=>{this.moveScrollOnLeft_()})};sync.diff.HorizontalScrollFixer.prototype.moveScrollOnLeft_=function(){this.scrollable_.scrollLeft=-999999,this.scrollable_.scrollLeft=1,this.scrollable_.scrollLeft=-999999};sync.diff.LayoutManager=function(t){this.editorFrameWrapper_=t,this.documentContainer_=t.firstElementChild,this.diffLinksContainer_=null,this.rangeRullerContainer_=null,this.secondDocumentContainer_=null,this.diffNoticeStripeContainer_=null,this.diffEditorStripesContainer_=null};sync.diff.LayoutManager.prototype.getEditorsContainer=function(){return this.diffFrame_};sync.diff.LayoutManager.prototype.create=function(){var t=this.editorFrameWrapper_.parentElement;for(this.diffFrame_=goog.dom.createDom("div",{id:"diff-editors-frame"});t.childNodes.length!==0;)goog.dom.appendChild(this.diffFrame_,t.childNodes[0]);this.diffNoticeStripeContainer_=goog.dom.createDom("div","diff-stripe"),this.diffEditorStripesContainer_=goog.dom.createDom("div",{id:"diff-stripes"}),workspace.setStripesContainer(this.diffEditorStripesContainer_),goog.dom.appendChild(t,this.diffNoticeStripeContainer_),goog.dom.appendChild(t,this.diffEditorStripesContainer_),goog.dom.appendChild(t,this.diffFrame_);var e=goog.dom.createDom("div","diff-links middle");goog.dom.insertSiblingAfter(e,this.editorFrameWrapper_);var i=goog.dom.createDom("form",{id:"second-editor-frame"});i.setAttribute("spellcheck","false"),new sync.view.LoadingIndicator(i).setVisible(!0),goog.events.listen(i,goog.events.EventType.SUBMIT,function(r){r.preventDefault(),r.stopPropagation()});var o=goog.dom.createDom("div",{id:"second-editor-frame-wrapper"},i);goog.dom.insertSiblingAfter(o,e),this.rangeRullerContainer_=goog.dom.createDom("div","range-ruler-container"),goog.dom.insertSiblingAfter(this.rangeRullerContainer_,o),goog.dom.classlist.add(this.documentContainer_,"scroll-on-left"),goog.dom.classlist.add(o,"diff-document-wrapper"),goog.dom.classlist.add(this.editorFrameWrapper_,"diff-document-wrapper"),this.secondDocumentContainer_=i,this.diffLinksContainer_=e};sync.diff.LayoutManager.prototype.setDocumentsLabels=function(t,e,i){this.labelsAreInitiated_||this.createDocumentLabels_(),this.renderMainLabel_(t,i),this.previewLabel_.textContent=e||""};sync.diff.LayoutManager.prototype.renderMainLabel_=function(t,e){t&&(this.mainLabel_.textContent=t,e&&this.mainLabel_.setAttribute("title",e))};sync.diff.LayoutManager.prototype.createDocumentLabels_=function(){this.labelsAreInitiated_=!0;var t=goog.dom.createDom("div","diff-labels");this.mainLabel_=goog.dom.createDom("div","diff-main-label"),this.previewLabel_=goog.dom.createDom("div","diff-preview-label"),goog.dom.append(t,this.mainLabel_,goog.dom.createDom("div","diff-middle-label"),this.previewLabel_),goog.dom.insertChildAt(this.diffNoticeStripeContainer_.parentElement,t,0),goog.dom.classlist.add(document.getElementById("header"),"diff-has-labels")};sync.diff.LayoutManager.prototype.getRangeRulerContainer=function(){return this.rangeRullerContainer_};sync.diff.LayoutManager.prototype.getSecondDocumentContainer=function(){return this.secondDocumentContainer_};sync.diff.LayoutManager.prototype.getDocumentContainer=function(){return this.documentContainer_};sync.diff.LayoutManager.prototype.getDiffLinksContainer=function(){return this.diffLinksContainer_};sync.diff.LayoutManager.prototype.getDiffNoticeStripeContainer=function(){return this.diffNoticeStripeContainer_};sync.diff.NoticeStripe=function(t){this.stripeContainer_=t.getDiffNoticeStripeContainer(),this.textContainer_=goog.dom.createDom("div"),this.stripeContainer_.appendChild(this.textContainer_),this.msg_=goog.dom.createDom("div"),this.textContainer_.appendChild(this.msg_),this.link_=goog.dom.createDom("a","link"),this.link_.setAttribute("target","blank"),this.textContainer_.appendChild(this.link_),this.shown_=!1};sync.diff.NoticeStripe.MessageType={INFO:"info",SUCCESS:"success",WARNING:"warning",ERROR:"error"};sync.diff.NoticeStripe.prototype.show=function(t,e,i,n,o){goog.dom.classlist.add(this.stripeContainer_,"show");var r=e||sync.diff.NoticeStripe.MessageType.INFO;goog.dom.classlist.set(this.textContainer_,r),goog.dom.setTextContent(this.msg_,t),i&&n?(this.link_.setAttribute("href",i),goog.dom.setTextContent(this.link_,n)):goog.dom.setTextContent(this.link_,""),o?(this.linkClickKey_&&goog.events.unlistenByKey(this.linkClickKey_),this.linkClickKey_=goog.events.listen(this.link_,goog.events.EventType.CLICK,o)):(this.linkClickKey_&&goog.events.unlistenByKey(this.linkClickKey_),this.linkClickKey_=null),this.shown_=!0};sync.diff.NoticeStripe.prototype.hide=function(){goog.dom.classlist.remove(this.stripeContainer_,"show"),this.shown_=!1};sync.diff.NoticeStripe.prototype.isShown=function(){return this.shown_};var a=window.msgs,l=window.tr;sync.diff.NoticeStripeManager=function(t,e,i,n,o){this.stripe_=t,this.intervalsPair_=e,this.diffsModelPair_=i,this.actionsManager_=n,this.diffUrl_=o};sync.diff.NoticeStripeManager.prototype.attach=function(){goog.events.listen(this.intervalsPair_,sync.diff.EditorIntervalsPair.EventType.INTERVALS_UPDATED,goog.bind(this.updateStripe_,this)),this.diffsModelPair_.listen(sync.diff.DiffsModelPair.EventType.OUT_OF_DATE,this.updateStripe_.bind(this))};sync.diff.NoticeStripeManager.prototype.setStatus=function(t){this.diffOperationStatus_=t,this.updateStripe_()};sync.diff.NoticeStripeManager.prototype.updateStripe_=function(){if(this.diffsModelPair_.isOutOfDate()&&this.diffOperationStatus_!==sync.diff.DiffPerformer.STATUS.FAIL_TO_LOAD_BASE)this.stripe_.hide();else if(this.diffOperationStatus_===sync.diff.DiffPerformer.STATUS.NO_DIFF)this.stripe_.show(l(a.NO_DIFF_),sync.diff.NoticeStripe.MessageType.SUCCESS);else if(this.diffOperationStatus_===sync.diff.DiffPerformer.STATUS.NO_AUTHOR_DIFF)this.stripe_.show(l(a.NO_AUTHOR_DIFF_),sync.diff.NoticeStripe.MessageType.INFO,sync.util.help.getDocumentationUrl(sync.util.help.Id.NO_VISUAL_DIFF),l(a.READ_MORE_));else if(this.diffOperationStatus_===sync.diff.DiffPerformer.STATUS.FAIL_TO_LOAD_BASE){let t=new URL(this.diffUrl_),e=t.searchParams.get("diffBaseUrl"),n=t.toString().split("?")[0]+"?url="+encodeURIComponent(e);this.stripe_.show(l(a.NO_BASE_),sync.diff.NoticeStripe.MessageType.ERROR,n,l(a.OPEN_BASE_))}else this.intervalsPair_.getIntervals(!0).isHiddenDiffsDetected()||this.intervalsPair_.getIntervals(!1).isHiddenDiffsDetected()?this.stripe_.show(l(a.DIFFS_HIDDEN_IN_AUTHOR_),sync.diff.NoticeStripe.MessageType.WARNING,sync.util.help.getDocumentationUrl(sync.util.help.Id.NO_VISUAL_DIFF),l(a.READ_MORE_)):this.stripe_.hide();this.intervalsPair_.updateEditorsContainerBounds()};var a=window.msgs,l=window.tr;sync.diff.PerformDiffAction=function(t,e,i){sync.actions.Action.call(this,{description:l(a.PERFORM_FILES_DIFFERENCING)}),this.diffPerformer_=t,this.diffModelPair_=e,this.actionsManager_=i,this.isPerforming_=!1,this.refreshActivationStatus_=this.refreshActivationStatus_.bind(this),this.diffModelPair_.listen(sync.diff.DiffsModelPair.EventType.OUT_OF_DATE,this.refreshActivationStatus_),this.diffModelPair_.listen(sync.diff.DiffsModelPair.EventType.MODEL_CHANGED,this.refreshActivationStatus_)};goog.inherits(sync.diff.PerformDiffAction,sync.actions.Action);sync.diff.PerformDiffAction.ACTION_ID="Diff/PerformDiff";sync.diff.PerformDiffAction.prototype.refreshActivationStatus_=function(){this.actionsManager_.refreshActionsStatus(sync.diff.PerformDiffAction.ACTION_ID)};sync.diff.PerformDiffAction.prototype.getLargeIcon=function(){return sync.util.computeHdpiIcon("../plugin-resources/web-author-diff-plugin/icons/DiffPerform24.png")};sync.diff.PerformDiffAction.prototype.actionPerformed=function(t){this.isPerforming_=!0,this.refreshActivationStatus_(),this.diffPerformer_.performDiff().finally(()=>{this.isPerforming_=!1,this.refreshActivationStatus_(),t()})};sync.diff.PerformDiffAction.prototype.isEnabled=function(){return this.diffModelPair_.isOutOfDate()&&!this.isPerforming_};sync.diff.RangeRuler=function(t,e,i,n){goog.events.EventTarget.call(this),this.diffSelectionModel_=t,this.intervals_=i.getIntervals(!1),this.intervalsPair_=i,this.diffsModel_=n,this.containerWrapper_=e,this.container_=goog.dom.createDom("div","range-ruler"),this.containerWrapper_.appendChild(this.container_),this.selectedRange_=null};sync.diff.RangeRuler.prototype.attach=function(){goog.events.listen(this.diffSelectionModel_,sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,goog.bind(this.onDiffSelectionChanges_,this)),goog.events.listen(this.container_,goog.events.EventType.CLICK,goog.bind(this.onRangeClick_,this)),goog.events.listen(this.intervalsPair_,sync.diff.EditorIntervalsPair.EventType.INTERVALS_UPDATED,goog.bind(this.onIntervalsUpdated_,this))};sync.diff.RangeRuler.prototype.onIntervalsUpdated_=function(t){this.pendingRaf_||(this.pendingRaf_=!0,requestAnimationFrame(goog.bind(this.update_,this)))};sync.diff.RangeRuler.prototype.update_=function(){this.pendingRaf_=!1;var t=this.getRangesDescriptors_();this.renderRanges_(t,this.intervals_.getViewportHeight())};sync.diff.RangeRuler.prototype.getRangesDescriptors_=function(){for(var t=[],e=this.intervals_.getDiffIntervals(),i=0;i<e.length;i++){var n=e[i];n.rect!==null&&t.push({top:n.rect.top,bottom:n.rect.top+n.rect.height,diffId:n.diff.diffId,parentDiffId:n.diff.getParentDiffId(),diffType:n.diff.parentDiff.diffType})}return t};sync.diff.RangeRuler.prototype.renderRanges_=function(t,e){this.updateWrapperPadding_(),goog.dom.removeChildren(this.container_),t=JSON.parse(JSON.stringify(t));for(var i=this.fixOverlaps_(t),n=i+e,o=0;o<t.length;o++){var r=t[o],s=goog.dom.createDom("div","range");s.setAttribute("data-diff-id",r.diffId),s.setAttribute("data-diff-parent",r.parentDiffId),s.setAttribute("data-diff-type",r.diffType),s.style.top=r.top/n*100+"%",s.style.height=(r.bottom-r.top)/n*100+"%",this.container_.appendChild(s)}this.select_(this.diffSelectionModel_.getSelectedDiff())};sync.diff.RangeRuler.prototype.updateWrapperPadding_=function(){var t=this.intervals_.getViewport(),e=t.scrollHeight>t.clientHeight,i=t.scrollWidth>t.clientWidth,n=e?20:0,o=e?20:0;i&&(o+=20),this.containerWrapper_.style.paddingTop=n+"px",this.containerWrapper_.style.paddingBottom=o+"px"};sync.diff.RangeRuler.prototype.fixOverlaps_=function(t){for(var e=0,i=1;i<t.length;i++){var n=t[i-1],o=t[i];if(o.top+=e,o.bottom+=e,o.top>=n.top&&o.top<=n.bottom){var r=Math.min(o.bottom,n.bottom)-Math.max(o.top,n.top);e+=r;var s=n.bottom-o.top;o.top+=s,o.bottom+=s}else if(o.bottom>=n.top&&o.bottom<=n.bottom){var f=o.bottom-o.top;e+=f,s=n.bottom-o.top,o.top+=s,o.bottom+=s}}return e};sync.diff.RangeRuler.prototype.onRangeClick_=function(t){var e=t.target.getAttribute("data-diff-id");if(e!==null){var i=this.diffsModel_.getDiff(e);this.diffSelectionModel_.setSelection(i,!0)}};sync.diff.RangeRuler.prototype.onDiffSelectionChanges_=function(t){this.select_(t.diff)};sync.diff.RangeRuler.prototype.select_=function(t){t instanceof sync.diff.ParentDiff&&(t=null),this.selectedRange_&&goog.dom.classlist.remove(this.selectedRange_,"selected-diff"),t?(this.selectedRange_=this.container_.querySelector("[data-diff-id='"+t.diffId+"']"),this.selectedRange_&&goog.dom.classlist.add(this.selectedRange_,"selected-diff")):this.selectedRange_=null};sync.diff.ScrollSynchronizer=function(t,e){this.intervalsPair_=t,this.primaryIntervals_=t.getIntervals(!0),this.primaryViewport_=this.primaryIntervals_.getViewport(),this.secondaryIntervals_=t.getIntervals(!1),this.secondaryViewport_=this.secondaryIntervals_.getViewport(),this.diffSelectionModel_=e,this.lastPrimaryScrollTop_=0,this.lastSecondaryScrollTop_=0,this.userInteractionDetected_=!1,this.lastSyncedIntervalIndex_=null,this.lastSyncedIntervalDiff_=null,this.ignorePrimary_=null,this.ignoreSecondary_=null,this.syncLine_=null};sync.diff.ScrollSynchronizer.PADDING=20;sync.diff.ScrollSynchronizer.prototype.attach=function(){goog.events.listen(this.intervalsPair_,sync.diff.EditorIntervalsPair.EventType.INTERVALS_UPDATED,t=>this.updateScrollOnIntervalsChanged_(t.diffModelWasChanged)),goog.events.listen(this.primaryViewport_,goog.events.EventType.SCROLL,()=>this.updateScrollOnScroll_(!0)),goog.events.listen(this.secondaryViewport_,goog.events.EventType.SCROLL,()=>this.updateScrollOnScroll_(!1)),goog.events.listen(this.diffSelectionModel_,sync.diff.DiffSelectionModel.EventType.DIFF_SELECTION_CHANGED,goog.bind(this.scrollToSelectedDiff_,this)),["mousedown","keydown","wheel","touchstart"].forEach(t=>{goog.events.listenOnce(document,t,()=>this.userInteractionDetected_=!0)})};sync.diff.ScrollSynchronizer.prototype.scrollSelectedDiffAtSyncLine_=function(){let t=this.diffSelectionModel_.getSelectedDiff();if(t){let e=this.primaryIntervals_.getIntervalOfDiff(t),i=this.secondaryIntervals_.getIntervalOfDiff(t);if(!e||!i)return;this.scrollIntervalsAtSyncLine_(e,i)}};sync.diff.ScrollSynchronizer.prototype.scrollToSelectedDiff_=function(t){var e=this.diffSelectionModel_.getSelectedDiff();e&&this.scrollToDiff_(e,t.shouldScrollToFullyVisible)};sync.diff.ScrollSynchronizer.prototype.scrollToDiff_=function(t,e){this.lastSyncedIntervalDiff_=t;var i=this.primaryIntervals_.getIntervalOfDiff(t),n=this.secondaryIntervals_.getIntervalOfDiff(t);!i||!n||this.scrollIntervalsIntoView_(e,i,n)};sync.diff.ScrollSynchronizer.prototype.scrollLastSyncedIntervalsIntoView_=function(t){if(t)this.resetLastSynchronizedDiff_();else{this.computeSyncLink_();var e=this.getLastSyncedIntervals_(),i=e[0],n=e[1];i&&n&&this.scrollIntervalsIntoView_(!1,i,n)}};sync.diff.ScrollSynchronizer.prototype.computeSyncLink_=function(){let t=this.primaryIntervals_.getEditorsContainerBounds();this.syncLine_=t.height/3};sync.diff.ScrollSynchronizer.prototype.getLastSyncedIntervals_=function(){var t,e;return this.lastSyncedIntervalDiff_!==null?(t=this.primaryIntervals_.getIntervalOfDiff(this.lastSyncedIntervalDiff_),e=this.secondaryIntervals_.getIntervalOfDiff(this.lastSyncedIntervalDiff_)):this.lastSyncedIntervalIndex_!==null&&this.lastSyncedIntervalIndex_>=0&&this.lastSyncedIntervalIndex_<this.primaryIntervals_.getIntervals().length&&(t=this.primaryIntervals_.getIntervals()[this.lastSyncedIntervalIndex_],e=this.secondaryIntervals_.getIntervals()[this.lastSyncedIntervalIndex_]),[t,e]};sync.diff.ScrollSynchronizer.prototype.resetLastSynchronizedDiff_=function(){this.lastSyncedIntervalDiff_=null,this.lastSyncedIntervalIndex_=null};sync.diff.ScrollSynchronizer.prototype.storeSyncedIntervalInfo_=function(t,e,i){if(t&&e){var n=i?this.secondaryIntervals_:this.primaryIntervals_;this.lastSyncedIntervalIndex_=n.getIntervals().indexOf(t),this.lastSyncedIntervalDiff_=t.diff}else this.lastSyncedIntervalIndex_=null,this.lastSyncedIntervalDiff_=null};sync.diff.ScrollSynchronizer.prototype.updateScrollOnIntervalsChanged_=function(t){this.userInteractionDetected_?this.scrollLastSyncedIntervalsIntoView_(t):this.scrollSelectedDiffAtSyncLine_()};sync.diff.ScrollSynchronizer.prototype.updateScrollOnScroll_=function(t){let e;this.isVerticalScrollChanged_(t)?(this.recordVerticalScrollPosition_(t),e=this.isVerticalScrollIgnored_(t)):e=!0,e||(this.userInteractionDetected_?this.syncPairScrollBar_(!t):this.scrollSelectedDiffAtSyncLine_())};sync.diff.ScrollSynchronizer.prototype.isVerticalScrollIgnored_=function(t){var e=!1;return this.ignorePrimary_&&t&&(this.ignorePrimary_=!1,e=!0),this.ignoreSecondary_&&!t&&(this.ignoreSecondary_=!1,e=!0),e};sync.diff.ScrollSynchronizer.prototype.isVerticalScrollChanged_=function(t){var e=!1;return t?this.primaryViewport_.scrollTop!==this.lastPrimaryScrollTop_&&(e=!0):this.secondaryViewport_.scrollTop!==this.lastSecondaryScrollTop_&&(e=!0),e};sync.diff.ScrollSynchronizer.prototype.recordVerticalScrollPosition_=function(t){t?this.lastPrimaryScrollTop_=this.primaryViewport_.scrollTop:this.lastSecondaryScrollTop_=this.secondaryViewport_.scrollTop};sync.diff.ScrollSynchronizer.prototype.syncPairScrollBar_=function(t){var e,i,n;t?(n=this.secondaryIntervals_.getViewport().scrollTop+this.syncLine_,i=this.getIntervalAt_(this.secondaryIntervals_,n),e=this.getPairInterval_(i,this.secondaryIntervals_,this.primaryIntervals_)):(n=this.primaryIntervals_.getViewport().scrollTop+this.syncLine_,e=this.getIntervalAt_(this.primaryIntervals_,n),i=this.getPairInterval_(e,this.primaryIntervals_,this.secondaryIntervals_)),this.syncIntervals_(e,i,t)};sync.diff.ScrollSynchronizer.prototype.syncIntervals_=function(t,e,i){var n,o,r;i?(n=this.secondaryViewport_,o=e,r=t):(n=this.primaryViewport_,o=t,r=e),this.storeSyncedIntervalInfo_(o,r,i);var s,f,d;!t||!e?s=n.scrollTop:r.rect.top===0?(f=n.scrollTop+this.syncLine_,d=this.getRatio_(o.rect.top+this.syncLine_,o.rect.top+o.rect.height,f),s=r.rect.top+(r.rect.height-this.syncLine_)*d/100):(f=n.scrollTop+this.syncLine_,d=this.getRatio_(o.rect.top,o.rect.top+o.rect.height,f),s=r.rect.top+r.rect.height*d/100-this.syncLine_),this.setScroll_(i,s)};sync.diff.ScrollSynchronizer.prototype.scrollIntervalsIntoView_=function(t,e,i){if(!(!e||!i)){var n=this.primaryIntervals_,o=this.secondaryIntervals_,r,s=n.isVisible(e,t,sync.diff.ScrollSynchronizer.PADDING),f=o.isVisible(i,t,sync.diff.ScrollSynchronizer.PADDING);!s&&!f?this.scrollIntervalsAtSyncLine_(e,i):s&&!f?(r=e.rect.top-n.getViewport().scrollTop,this.setScroll_(!1,i.rect.top-r)):!s&&f&&(r=i.rect.top-o.getViewport().scrollTop,this.setScroll_(!0,e.rect.top-r))}};sync.diff.ScrollSynchronizer.prototype.scrollIntervalsAtSyncLine_=function(t,e){this.computeSyncLink_(),this.storeSyncedIntervalInfo_(t,e,!0),this.setScroll_(!0,t.rect.top-this.syncLine_/2-sync.diff.ScrollSynchronizer.PADDING),this.setScroll_(!1,e.rect.top-this.syncLine_/2-sync.diff.ScrollSynchronizer.PADDING)};sync.diff.ScrollSynchronizer.prototype.getIntervalAt_=function(t,e){var i=t.getIntervals();if(this.lastSyncedIntervalIndex_!==null&&this.lastSyncedIntervalIndex_>=0&&this.lastSyncedIntervalIndex_<i.length){var n=i[this.lastSyncedIntervalIndex_];if(n.rect!==null&&n.rect.top<=e&&n.rect.top+n.rect.height>=e)return n}return t.getIntervalAt(e)};sync.diff.ScrollSynchronizer.prototype.getRatio_=function(t,e,i){var n=e-t,o=i-t;return n!==0?o/n*100:0};sync.diff.ScrollSynchronizer.prototype.getPairInterval_=function(t,e,i){if(t&&t.diff)return i.getIntervalOfDiff(t.diff);var n=e.getIntervals().indexOf(t);return i.getIntervals()[n]};sync.diff.ScrollSynchronizer.prototype.setScroll_=function(t,e){setTimeout(()=>{t?this.primaryViewport_.scrollTop!==e&&(this.ignorePrimary_=!0,this.lastPrimaryScrollTop_=e,this.primaryViewport_.scrollTop=e):this.secondaryViewport_.scrollTop!==e&&(this.ignoreSecondary_=!0,this.lastSecondaryScrollTop_=e,this.secondaryViewport_.scrollTop=e)})};(function(){var t=document.getElementById("editor-frame-wrapper"),e=t.firstElementChild,i=new sync.diff.LayoutManager(t,e),n=new sync.diff.DiffInitializer(i);n.attach(window.workspace)})();})();
