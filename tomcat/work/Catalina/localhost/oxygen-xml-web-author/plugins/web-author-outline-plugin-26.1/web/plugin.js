(()=>{goog.provide("sync.outline.actions.SwitchToContentsModeAction");sync.outline.actions.SwitchToContentsModeAction=function(e){sync.actions.ToggleAction.call(this),this.modeHandler=e};goog.inherits(sync.outline.actions.SwitchToContentsModeAction,sync.actions.ToggleAction);sync.outline.actions.SwitchToContentsModeAction.prototype.actionPerformed=function(e){this.modeHandler.setMode(sync.view.OutlinePanel.Modes.CONTENTS),e&&e()};sync.outline.actions.SwitchToContentsModeAction.prototype.getDisplayName=function(){return tr(msgs.CONTENTS_)};sync.outline.actions.SwitchToContentsModeAction.prototype.isSelected=function(){return this.modeHandler.getMode()===sync.view.OutlinePanel.Modes.CONTENTS};goog.provide("sync.outline.actions.SwitchToStructureModeAction");sync.outline.actions.SwitchToStructureModeAction=function(e){sync.actions.ToggleAction.call(this),this.modeHandler=e};goog.inherits(sync.outline.actions.SwitchToStructureModeAction,sync.actions.ToggleAction);sync.outline.actions.SwitchToStructureModeAction.prototype.actionPerformed=function(e){this.modeHandler.setMode(sync.view.OutlinePanel.Modes.STRUCTURE),e&&e()};sync.outline.actions.SwitchToStructureModeAction.prototype.getDisplayName=function(){return tr(msgs.STRUCTURE_)};sync.outline.actions.SwitchToStructureModeAction.prototype.isSelected=function(){return this.modeHandler.getMode()===sync.view.OutlinePanel.Modes.STRUCTURE};sync.outline.ToolbarManager=function(){goog.Disposable.call(this)};goog.inherits(sync.outline.ToolbarManager,goog.Disposable);sync.outline.ToolbarManager.prototype.renderToolbar=function(e,t){this.removeToolbar();var n=goog.dom.createDom("div","outline-toolbar");goog.dom.insertChildAt(t,n,0);var i=new sync.view.ToolbarSelect(null,tr(msgs.DISPLAY_MODE_),!0),o=e.getActionById("Outline/SwitchToContentsMode");i.addItem(new sync.view.MenuItem(o,"Outline/SwitchToContentsMode"));var r=e.getActionById("Outline/SwitchToStructureMode");i.addItem(new sync.view.MenuItem(r,"Outline/SwitchToStructureMode"));var s=new sync.view.Toolbar;s.addChild(i,!0),s.render(n),this.toolbarContainer_=n,this.toolbar_=s};sync.outline.ToolbarManager.prototype.removeToolbar=function(){this.toolbar_&&this.toolbar_.dispose(),goog.dom.removeNode(this.toolbarContainer_),this.toolbar_=null,this.toolbarContainer_=null};sync.outline.ToolbarManager.prototype.disposeInternal=function(){sync.outline.ToolbarManager.superClass_.disposeInternal.call(this),this.removeToolbar()};(function(){var e={CONTENTS_:{en_US:"Contents",de_DE:"Inhalte",fr_FR:"Sommaire",ja_JP:"\u30B3\u30F3\u30C6\u30F3\u30C4",nl_NL:"Inhoud",zh_CN:"\u76EE\u5F55"},STRUCTURE_:{en_US:"Structure",de_DE:"Struktur",ja_JP:"\u69CB\u9020",nl_NL:"Structuur",zh_CN:"\u7ED3\u6784"},DISPLAY_MODE_:{en_US:"Display Mode",de_DE:"Anzeigemodus",fr_FR:"Mode d'affichage",ja_JP:"\u8868\u793A\u30E2\u30FC\u30C9",nl_NL:"Weergavemodus",zh_CN:"\u663E\u793A\u6A21\u5F0F"},COLLAPSE_ALL_:{en_US:"Collapse All",de_DE:"Alle Elemente schlie\xDFen",fr_FR:"Tout r\xE9duire",ja_JP:"\u3059\u3079\u3066\u7573\u3080",nl_NL:"Vouw alles dicht",zh_CN:"\u5168\u90E8\u6298\u53E0"},EXPAND_ALL_:{en_US:"Expand All",de_DE:"Alle erweitern",fr_FR:"Tout d\xE9velopper",ja_JP:"\u3059\u3079\u3066\u5C55\u958B",nl_NL:"Vouw alles open",zh_CN:"\u5168\u90E8\u5C55\u5F00"},OUTLINE_:{en_US:"Outline",de_DE:"Gliederung",fr_FR:"Sommaire",ja_JP:"\u30A2\u30A6\u30C8\u30E9\u30A4\u30F3",nl_NL:"Structuuroverzicht",zh_CN:"\u5927\u7EB2"},LOADING_:{en_US:"Loading",de_DE:"Lade",fr_FR:"Chargement",ja_JP:"\u8AAD\u307F\u8FBC\u307F\u4E2D",nl_NL:"Laden",zh_CN:"\u52A0\u8F7D"}};sync.Translation.addTranslations(e)})();goog.provide("sync.outline.ActionsManager");sync.outline.ActionsManager=function(){this.actions_={}};sync.outline.ActionsManager.COPY_ACTION_ID="Author/CopySpecial";sync.outline.ActionsManager.prototype.setWrappedActionsManager=function(e){this.wrappedActionsManager_=e};sync.outline.ActionsManager.prototype.registerAction=function(e,t){this.actions_[e]=t};sync.outline.ActionsManager.prototype.executeActionInContext=function(e,t,n){e instanceof sync.actions.ActionWithContext?e.isEnabledFor(t)&&e.actionPerformedFor(n,t):e.isEnabled()&&e.actionPerformed(n)};sync.outline.ActionsManager.prototype.getActionByShortcut=function(e){var t=this.wrappedActionsManager_.getActionByShortcut(e),n=null;return e.key==="Delete"||e.key==="Backspace"?n=this.getActionById("Author/DeleteElement"):t&&(e.ctrlKey||e.metaKey)&&(this.hasId(t,"Author/Copy")?n=this.getActionById(sync.outline.ActionsManager.COPY_ACTION_ID):this.hasId(t,"Author/Cut")?n=this.getActionById("Author/CutSpecial"):(this.hasId(t,"Author/Undo")||this.hasId(t,"Author/Redo"))&&(n=t)),n};sync.outline.ActionsManager.prototype.isSaveShortcut_=function(e){return(e.ctrlKey||e.metaKey)&&!e.altKey&&!e.shiftKey&&e.key==="s"};sync.outline.ActionsManager.prototype.hasId=function(e,t){return e===this.getActionById(t)};sync.outline.ActionsManager.prototype.getActionById=function(e){var t=this.actions_[e];return t||(t=this.wrappedActionsManager_.getActionById(e)),t};sync.outline.ActionsManager.prototype.getActionShortcutForDisplay=function(e){return null};sync.outline.ActionsManager.prototype.getEventSource=function(){return this.wrappedActionsManager_.getEventSource()};goog.provide("sync.outline.ChildRetriever");sync.outline.ChildRetriever=function(e,t,n,i){var o;n?o="[data-oxy]":o=i.map(goog.bind(this.getElementSelector_,this)).join(",");var r=t.querySelectorAll(o),s=this.getRootId_(n,i,t);this.xmlModel_=e,this.childrenCache_=this.fillChildrenCache_(s,r)};sync.outline.ChildRetriever.prototype.DOC_ID="doc";sync.outline.ChildRetriever.prototype.getRootId_=function(e,t,n){var i=!1;if(sync.model.XmlDom.isXmlNode(n))if(e)i=!sync.model.XmlDom.isDocument(n);else{var o=sync.model.XmlDom.getTagName(n);i=t.indexOf(o)!==-1}return i?sync.model.XmlModel.getIdOfXmlNode(n):this.DOC_ID};sync.outline.ChildRetriever.prototype.getElementSelector_=function(e){return'[data-name^="'+e+'!"]'};sync.outline.ChildRetriever.prototype.fillChildrenCache_=function(e,t){var n=new Map,i=new Set;n.set(e,[]),i.add(e);for(var o=0;o<t.length;o++){var r=t[o],s=sync.model.XmlModel.getIdOfXmlNode(r);n.set(s,[]),i.add(s);var l=this.getIncludedAncestorId_(r,i);n.get(l).push(s)}return n};sync.outline.ChildRetriever.prototype.getIncludedAncestorId_=function(e,t){var n=this.DOC_ID,i=e.parentElement;if(i){var o=sync.model.XmlModel.getIdOfXmlNode(i);t.has(o)?n=o:n=this.getIncludedAncestorId_(i,t)}return n};sync.outline.ChildRetriever.prototype.getChildrenInOutline=function(e){return this.childrenCache_.get(e)||[]};sync.outline.ChildRetriever.prototype.getSubtreeData=function(e){var t={};t.nodeId=e,t.isFilteredOut=this.isFilteredOut_(e);var n=this.getChildrenInOutline(e);return t.children=n.map(this.getSubtreeData,this),t};sync.outline.ChildRetriever.prototype.isFilteredOut_=function(e){var t=this.xmlModel_.getXmlNodeById(e);return goog.dom.classlist.contains(t,"oxy-filtered")};sync.outline.ChildRetriever.prototype.isIgnoredPi_=function(e){var t=!1,n=this.xmlModel_.getXmlNodeById(e);if(sync.model.XmlDom.isPi(n)){var i=sync.model.XmlDom.getAttributes(n);(i["xml-model"]||i["xml-stylesheet"])&&(t=!0)}return t};sync.outline.ChildRetriever.prototype.getRootElementIds=function(){var e=this.childrenCache_.get(this.DOC_ID);return e.length>1&&(e=e.filter(function(t){return!this.isIgnoredPi_(t)},this)),e};goog.provide("sync.outline.actions.CollapseAllAction");sync.outline.actions.CollapseAllAction=function(e){sync.actions.ActionWithContext.call(this),this.treeProvider_=e};goog.inherits(sync.outline.actions.CollapseAllAction,sync.actions.ActionWithContext);sync.outline.actions.CollapseAllAction.prototype.actionPerformed=function(e){var t=this.treeProvider_.getTree().getSelectedItem();t.collapseAll(),e&&e()};sync.outline.actions.CollapseAllAction.prototype.actionPerformedFor=function(e){this.actionPerformed(e)};sync.outline.actions.CollapseAllAction.prototype.getDisplayName=function(){return tr(msgs.COLLAPSE_ALL_)};sync.outline.actions.CollapseAllAction.prototype.getSmallIcon=function(e){return sync.util.computeHdpiIcon("../plugin-resources/web-author-outline-plugin/CollapseAll16.png")};sync.outline.actions.CollapseAllAction.prototype.isEnabledFor=function(e){var t=this.treeProvider_.getTree().getSelectedItem();return t.hasChildren()&&t.getExpanded()};sync.outline.OutlineContextMenuItem=function(e,t,n){sync.view.MenuItem.call(this,e,t,null,n)};goog.inherits(sync.outline.OutlineContextMenuItem,sync.view.MenuItem);sync.outline.OutlineContextMenuItem.prototype.isEnabled=function(){var e;return this.context&&!this.context.computeSelection()?e=!1:e=sync.outline.OutlineContextMenuItem.superClass_.isEnabled.call(this),e};goog.provide("sync.outline.DomUtil");sync.outline.DomUtil=function(e){this.xmlModel_=e};sync.outline.DomUtil.getOxyLabel=function(e){var t=sync.caret.ContentIterator.getStaticContent(e);for(var n of t){var i=n.querySelector(".oxy-label");if(i)return i.textContent}return""};sync.outline.DomUtil.prototype.isInline=function(e){var t=this.xmlModel_.getEndSentinelOfXmlElem(e);return t.classList&&t.classList.contains("tag-inline")};sync.outline.DomUtil.prototype.getFirstNonIncludedLeaf=function(e,t){var n=goog.array.find(e.childNodes,function(o){var r=o.nodeType;return r===goog.dom.NodeType.ELEMENT||r===goog.dom.NodeType.TEXT||r===goog.dom.NodeType.ENTITY_REFERENCE}),i=e;return n&&n.nodeType===goog.dom.NodeType.ELEMENT&&!t(this.xmlModel_.getXmlNodeById(n.id))&&(i=this.getFirstNonIncludedLeaf(n,t)),i};sync.outline.DomUtil.prototype.evaluateSimpleXPath=function(e,t){for(var n=t.split(","),i=null,o=0;o<n.length&&i===null;o++){var r=n[o].trim();i=this.evaluateAtomicXPath(e,r)}return i};sync.outline.DomUtil.prototype.evaluateAtomicXPath=function(e,t){var n=null;if(t.indexOf("before(")===0){let r=t.substring("before(".length,t.length-1);n=this.getPseudoElement_(e,!0,r)}else if(t.indexOf("@")===0){var i=t.substring(1);n=e.attributes.getNamedItem(i)}else if(t.indexOf(".//")===0){var o=t.substring(3);n=this.findDescendent_(e.firstChild,o)}else n=this.findNodeAtEndOfMatch_(e,t.split("/"));return n};sync.outline.DomUtil.prototype.findNodeAtEndOfMatch_=function(e,t){let n=null,i=t[0];for(let o of e.getChildNodes())if(o.nodeType===goog.dom.NodeType.ELEMENT&&o.localName===i){if(t.length===1){n=o;break}let r=[...t];if(r.shift(),this.findNodeAtEndOfMatch_(o,r)!==null){n=o;break}}return n};sync.outline.DomUtil.prototype.getPseudoElement_=function(e,t,n){var i=e.getHtmlNode(),o=sync.caret.ContentIterator.getPseudoElements(i);for(var r of o)if(t&&sync.caret.ContentIterator.isStaticContentBefore(r)){var s=goog.dom.dataset.get(r,"role").substring("BEFORE_".length);if(s===n)return r}return null};sync.outline.DomUtil.prototype.findDescendent_=function(e,t){var n=goog.dom.findNode(e,i=>i.getType()===goog.dom.NodeType.ELEMENT&&i.getLocalName()===t);return n===void 0&&(n=null),n};sync.outline.DragHandler=function(e,t,n,i,o){this.editor_=e,this.xmlModel_=i,this.treeStruct_=t,this.treeUpdater_=o,this.treeContainer_=n,this.dragDropGroup_=new sync.outline.DragDropGroup,this.dragDisabledClass_="outline-dragging-disabled",this.nodesAdded_=[],this.expandIconsAdded_=[],this.draggingThrottle_=null,this.invalidDropTargets_=[],this.dragSourceNextSiblingId_=null,this.dragSourcePreviousSiblingId_=null,this.containerRect_=null,this.eventHandler_=new goog.events.EventHandler(this),this.lastDraggedOverElement_=null,this.lastDraggedOverPosition_=null,this.lastDraggedOverElementId_=null;var r=750;this.draggedOverElementDelay_=new goog.async.Delay(goog.bind(this.expandAfterLingering_,this),r),this.update(n),this.addListeners()};sync.outline.DragHandler.POSITIONS={BEFORE:"Before",AFTER:"After",INSIDE_FIRST:"Inside as first child"};sync.outline.DragHandler.prototype.moveElement_=function(e,t,n){this.editor_.getActionsManager().invokeOperation("com.oxygenxml.outline.OutlineMoveNodeOperation",{sourceNodeId:e,targetNodeId:t,position:n},goog.bind(this.selectMovedElement_,this),null,!1)};sync.outline.DragHandler.prototype.selectMovedElement_=function(){this.treeUpdater_.sync(),this.treeStruct_.focus()};sync.outline.DragHandler.prototype.attachExpandButtons=function(){for(var e=this.treeContainer_.getElementsByClassName("goog-tree-expand-icon-plus"),t=0;t<e.length;t++){var n=e[t];if(n&&this.expandIconsAdded_.indexOf(n)===-1){var i=goog.dom.getAncestorByClass(n,"goog-tree-row"),o=i.querySelector(".outline-text"),r=goog.dom.dataset.get(o,"oxyOutlineId");this.dragDropGroup_.addItem(n,{expandIcon:"true",nodeId:r}),this.expandIconsAdded_.push(n)}}};sync.outline.DragHandler.prototype.updateWithTarget_=function(e){var t=e.target.getElement();t&&this.update(t)};sync.outline.DragHandler.prototype.update=function(e){var t,n,i=e.getElementsByClassName("goog-tree-item-label");for(t=0;t<i.length;t++){n=i[t];var o=n.querySelector(".outline-text");o&&this.nodesAdded_.indexOf(n)===-1&&(this.dragDropGroup_.addItem(n,{nodeId:goog.dom.dataset.get(o,"oxyOutlineId")}),this.nodesAdded_.push(n))}this.attachExpandButtons()};sync.outline.DragHandler.prototype.addListeners=function(){this.dragDropGroup_.addTarget(this.dragDropGroup_),workspace.getOption("exposeOutlineDragEventTarget")&&(window.dragEventTarget=this.dragDropGroup_),this.dragDropGroup_.init();var e=this.treeContainer_;this.dragDropGroup_.addScrollableContainer(e),this.dragDropGroup_.setScrollTarget(e);var t=120;this.draggingThrottle_=new goog.async.Throttle(this.drag_,t,this),this.eventHandler_.listen(this.dragDropGroup_,"drop",goog.bind(this.drop_,this)).listen(this.dragDropGroup_,"drag",goog.bind(function(n){this.draggingThrottle_.fire(n)},this)).listen(this.dragDropGroup_,"dragstart",goog.bind(this.dragStart_,this)).listen(this.dragDropGroup_,"dragend",goog.bind(this.dragEnd_,this)),this.eventHandler_.listen(this.treeStruct_,goog.ui.tree.BaseNode.EventType.EXPAND,this.updateWithTarget_),this.eventHandler_.listen(this.treeStruct_,sync.view.OutlineTreeStructure.EventType.NODE_CREATED,this.updateWithTarget_)};sync.outline.DragHandler.prototype.dispose=function(){this.eventHandler_.removeAll(),this.eventHandler_.dispose(),this.dragDropGroup_.dispose(),this.draggingThrottle_.dispose()};sync.outline.DragHandler.prototype.dragEnd_=function(){this.draggingThrottle_.stop(),this.stopScrolling_(),this.cleanupIndicators_(),this.invalidDropTargets_=[],this.dragSourcePreviousSiblingId_=null,this.dragSourceNextSiblingId_=null,this.lastDraggedOverPosition_=null};sync.outline.DragHandler.prototype.dragStart_=function(e){var t=e.dragSourceItem.data.nodeId,n=this.treeStruct_.getNodeById(t);n&&(n.collapse(),this.invalidDropTargets_.push(t),this.addDescendantNodeIds_(n,this.invalidDropTargets_));var i=n.getPreviousSibling();i&&(this.dragSourcePreviousSiblingId_=i.getModel().nodeId);var o=n.getNextSibling();o&&(this.dragSourceNextSiblingId_=o.getModel().nodeId),this.containerRect_=this.treeContainer_.getBoundingClientRect()};sync.outline.DragHandler.prototype.addDescendantNodeIds_=function(e,t){for(var n=e.getChildren(),i=0;i<n.length;i++)t.push(n[i].getModel().nodeId),n[i].getChildren().length&&this.addDescendantNodeIds_(n[i],t)};sync.outline.DragHandler.prototype.cleanupIndicators_=function(){this.lastDraggedOverElement_&&(goog.dom.classlist.removeAll(this.lastDraggedOverElement_,["custom-drag-inserting-top","custom-drag-inserting-bottom","custom-drag-inserting-middle"]),this.lastDraggedOverElement_=null)};sync.outline.DragHandler.prototype.checkContainerScroll_=function(e){var t=this.containerRect_,n=10,i=15,o=25;e<t.top+i&&e>t.top?this.startScrolling_(-n):e>t.bottom-o&&e<t.bottom?this.startScrolling_(n):this.stopScrolling_()};sync.outline.DragHandler.prototype.startScrolling_=function(e){var t=20;if(!this.scrollInterval){var n=this;this.scrollInterval=setInterval(function(){n.treeContainer_.scrollTop+=e},t)}};sync.outline.DragHandler.prototype.stopScrolling_=function(){this.scrollInterval&&(clearInterval(this.scrollInterval),this.scrollInterval=null)};sync.outline.DragHandler.prototype.drag_=function(e){if(this.cleanupIndicators_(),this.checkContainerScroll_(e.clientY),!this.handledDragIrrelevant_(e)){var t=e.dropTargetElement,n=goog.style.getBounds(t),i=n.height,o=n.top+i/3,r=n.top+i*2/3+1;this.handledDragForbidden_(e,o,r)||(this.lastDraggedOverElement_=t,!this.handledDragOverIcon_(e)&&this.handleDragOverOutlineItem_(e,o,r))}};sync.outline.DragHandler.prototype.handledDragIrrelevant_=function(e){var t=this.dragDropGroup_.getDragElement();if(!t)return!0;var n=e.dropTargetElement;if(!n)return this.lastDraggedOverElementId_=null,this.draggedOverElementDelay_.stop(),goog.dom.classlist.remove(t,this.dragDisabledClass_),!0;var i=this.containerRect_;return e.clientX<i.x||e.clientX>i.x+i.width?(goog.dom.classlist.remove(t,this.dragDisabledClass_),!0):!1};sync.outline.DragHandler.prototype.handleDragOverOutlineItem_=function(e,t,n){var i=e.dropTargetElement,o=e.dropTargetItem.data.nodeId,r=e.clientY;if(r<t)this.lastDraggedOverPosition_=sync.outline.DragHandler.POSITIONS.BEFORE,goog.dom.classlist.add(i,"custom-drag-inserting-top"),this.stopLingeringDelay_();else if(r>n)this.lastDraggedOverPosition_=sync.outline.DragHandler.POSITIONS.AFTER,goog.dom.classlist.add(i,"custom-drag-inserting-bottom"),this.stopLingeringDelay_();else{this.lastDraggedOverPosition_=sync.outline.DragHandler.POSITIONS.INSIDE_FIRST,goog.dom.classlist.add(i,"custom-drag-inserting-middle");var s=this.treeStruct_.getNodeById(o);this.lastDraggedOverElementId_!==o&&(this.lastDraggedOverElementId_=o,this.draggedOverElementDelay_.start())}};sync.outline.DragHandler.prototype.handledDragForbidden_=function(e,t,n){var i=!1,o=e.dropTargetItem.data.nodeId,r=e.clientY,s=this.dragDropGroup_.getDragElement();if(o){goog.style.setStyle(s,{visibility:"visible"});var l=this.invalidDropTargets_.indexOf(o)!==-1,a=r<t&&o===this.dragSourceNextSiblingId_,u=r>n&&o===this.dragSourcePreviousSiblingId_;l||a||u?(goog.dom.classlist.add(s,this.dragDisabledClass_),i=!0):goog.dom.classlist.remove(s,this.dragDisabledClass_)}return i};sync.outline.DragHandler.prototype.handledDragOverIcon_=function(e){var t=!1,n=e.dropTargetElement,i=e.dropTargetItem.data.nodeId;if(n.classList.contains("goog-tree-icon")){this.lastDraggedOverElementId_=i,this.lastDraggedOverPosition_=sync.outline.DragHandler.POSITIONS.INSIDE_FIRST;var o=this.treeStruct_.getNodeById(this.lastDraggedOverElementId_),r=o.getElement().querySelector(".goog-tree-item-label");goog.dom.classlist.add(r,"custom-drag-inserting-middle"),this.lastDraggedOverElement_=r,t=!0,this.draggedOverElementDelay_.start()}return t};sync.outline.DragHandler.prototype.stopLingeringDelay_=function(){this.lastDraggedOverElementId_=null,this.draggedOverElementDelay_.stop()};sync.outline.DragHandler.prototype.expandAfterLingering_=function(){var e=this.treeStruct_.getNodeById(this.lastDraggedOverElementId_);e.getExpanded()||(e.expand(),this.dragDropGroup_.recalculateDragTargets(),this.dragDropGroup_.recalculateScrollableContainers())};sync.outline.DragHandler.prototype.drop_=function(e){var t=e.lastDraggedOverPosition||this.lastDraggedOverPosition_;this.cleanupIndicators_();var n=e.dragSourceItem.data.nodeId,i=e.dropTargetItem.data.nodeId;!t||n===i||this.moveElement_(n,i,t)};goog.provide("sync.outline.actions.ExpandAllAction");sync.outline.actions.ExpandAllAction=function(e){sync.actions.ActionWithContext.call(this),this.treeProvider_=e};goog.inherits(sync.outline.actions.ExpandAllAction,sync.actions.ActionWithContext);sync.outline.actions.ExpandAllAction.prototype.actionPerformed=function(e){var t=this.treeProvider_.getTree().getSelectedItem();t.expandAll(),e&&e()};sync.outline.actions.ExpandAllAction.prototype.actionPerformedFor=function(e){this.actionPerformed(e)};sync.outline.actions.ExpandAllAction.prototype.getDisplayName=function(){return tr(msgs.EXPAND_ALL_)};sync.outline.actions.ExpandAllAction.prototype.getSmallIcon=function(e){return sync.util.computeHdpiIcon("../plugin-resources/web-author-outline-plugin/ExpandAll16.png")};sync.outline.actions.ExpandAllAction.prototype.isEnabledFor=function(e){var t=this.treeProvider_.getTree().getSelectedItem();return t.hasChildren()};sync.outline.OutlineConfiguration=function(e){var t=JSON.parse(e),n=t.tocMode;this.tocMode_=this.getModeDescriptor_(t.tocMode),this.tocElementsNamesArray_=n&&this.getNames_(n.elements);var i=new Map;n&&goog.object.forEach(n.titleLocators,function(r,s){i.set(s,r)}),this.tocModeTitleLocators_=i;var o=t.structureMode;this.structureMode_=this.getModeDescriptor_(o),this.structurePrefAttrsArray_=o&&this.getNames_(o.preferredAttributes)};sync.outline.OutlineConfiguration.prototype.getNames_=function(e){var t=e&&e.names;return t&&t.split(" ")};sync.outline.OutlineConfiguration.prototype.getModeDescriptor_=function(e){return e&&new sync.outline.OutlineMode(e)};sync.outline.OutlineConfiguration.prototype.isStructureModeEnabled=function(){return typeof this.structureMode_!="undefined"&&this.structureMode_};sync.outline.OutlineConfiguration.prototype.isStructureModeEditable=function(){return this.structureMode_&&this.structureMode_.isEditable()};sync.outline.OutlineConfiguration.prototype.isStructureModeDefault=function(){return this.structureMode_&&this.structureMode_.isDefault()};sync.outline.OutlineConfiguration.prototype.getStructureModePrefAttributes=function(){return this.structurePrefAttrsArray_};sync.outline.OutlineConfiguration.prototype.isTOCModeEnabled=function(){return typeof this.tocMode_!="undefined"&&this.tocMode_};sync.outline.OutlineConfiguration.prototype.isTOCModeEditable=function(){return this.tocMode_&&this.tocMode_.isEditable()};sync.outline.OutlineConfiguration.prototype.getTOCModeElements=function(){return this.tocElementsNamesArray_};sync.outline.OutlineConfiguration.prototype.getTOCTitleLocators=function(){return this.tocModeTitleLocators_};sync.outline.DragDropGroup=function(){this.dragElement_=null,goog.fx.DragDropGroup.call(this)};goog.inherits(sync.outline.DragDropGroup,goog.fx.DragDropGroup);sync.outline.DragDropGroup.prototype.createDragElement=function(e){var t=sync.outline.DragDropGroup.superClass_.createDragElement.call(this,e),n=window.getComputedStyle(e);return t.style.width=n.width,t.style.height=n.height,goog.dom.classlist.add(t,"outline-dragging"),this.dragElement_=t,t};sync.outline.DragDropGroup.prototype.getDragElement=function(){return this.dragElement_};sync.outline.DragDropGroup.prototype.startDrag=function(e,t){sync.outline.DragDropGroup.superClass_.startDrag.call(this,e,t),this.escapeListener_=goog.events.listenOnce(document.body,goog.events.EventType.KEYDOWN,goog.bind(function(n){n.keyCode===goog.events.KeyCodes.ESC&&(e.dragCanceled=!0,this.endDrag(e))},this),!0)};sync.outline.DragDropGroup.prototype.endDrag=function(e){this.escapeListener_&&goog.events.unlistenByKey(this.escapeListener_),sync.outline.DragDropGroup.superClass_.endDrag.call(this,e),this.dragElement_=null};sync.outline.OutlineMode=function(e){this.editable_=e.editable&&e.editable==="yes",this.default_=e.defaultMode&&e.defaultMode==="yes"};sync.outline.OutlineMode.prototype.isEditable=function(){return this.editable_};sync.outline.OutlineMode.prototype.isDefault=function(){return this.default_};sync.view.OutlinePanel=function(){this.editor_=null,this.xmlModel_=null,this.panelElement_=null,this.treeStruct_=null,this.domHandler_=null,this.maxLen_=70,this.selectionManager_=null,this.currentMode_=null,this.configurationProviderFromLoadingOpt_=null,this.configurationFromLoadingOpt_=null,this.outlineConfiguration_=null,this.editorEventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.editorEventHandler_),this.treeEventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.treeEventHandler_),this.globalEventHandler_=new goog.events.EventHandler(this),this.registerDisposable(this.globalEventHandler_),this.toolbarManager_=new sync.outline.ToolbarManager,this.registerDisposable(this.toolbarManager_)};goog.inherits(sync.view.OutlinePanel,sync.view.ViewRenderer);sync.view.OutlinePanel.Modes={CONTENTS:"contents",STRUCTURE:"structure"};sync.view.OutlinePanel.prototype.getTitle=function(){return tr(msgs.OUTLINE_)};sync.view.OutlinePanel.prototype.install=function(e){this.actionsManager_=new sync.outline.ActionsManager,this.registerOutlineActions(this.actionsManager_),this.treeContainer_=goog.dom.createDom("div","outline-tree-container"),this.container_=goog.dom.createDom("div","outline-container",this.treeContainer_),goog.dom.append(e,this.container_),this.blockNativeContextualMenu_(e),this.globalEventHandler_.listen(e,goog.events.EventType.KEYDOWN,this.handleShortcuts_)};sync.view.OutlinePanel.prototype.blockNativeContextualMenu_=function(e){goog.events.listen(e,goog.events.EventType.CONTEXTMENU,goog.bind(function(t){var n=this.treeStruct_&&this.treeStruct_.getElement();(!n||!goog.dom.contains(this.treeStruct_.getElement(),t.target))&&(t.preventDefault(),t.stopPropagation())},this),!0)};sync.view.OutlinePanel.prototype.registerOutlineActions=function(e){var t={getTree:()=>this.treeStruct_};e.registerAction("Outline/CollapseAll",new sync.outline.actions.CollapseAllAction(t)),e.registerAction("Outline/ExpandAll",new sync.outline.actions.ExpandAllAction(t)),e.registerAction("Outline/SwitchToStructureMode",new sync.outline.actions.SwitchToStructureModeAction(this)),e.registerAction("Outline/SwitchToContentsMode",new sync.outline.actions.SwitchToContentsModeAction(this))};sync.view.OutlinePanel.prototype.getMode=function(){return this.currentMode_};sync.view.OutlinePanel.prototype.setMode=function(e){this.currentMode_!==e&&(this.currentMode_=e,this.refresh_())};sync.view.OutlinePanel.prototype.refresh_=function(){this.refreshContextMenuConfiguration_(),this.disposeTreeStructure_(),this.createTreeStructure_(),this.treeUpdater_.syncSelection()};sync.view.OutlinePanel.prototype.supportsEditor=function(e){if(!sync.view.OutlinePanel.superClass_.supportsEditor.call(this,e))return!1;if(e.options.outlineConfigurationProvider||e.options.outlineConfiguration)return!0;var t=sync.model.XmlDom.getRootElement(document);return t&&t.getAttribute("data-pseudoclass-outlineOn")==="true"};sync.view.OutlinePanel.prototype.editorChanged=function(e){this.editor_=e;var t=e.getEditingSupport();this.xmlModel_=t.getXmlModel(),this.domHandler_=new sync.outline.DomUtil(this.xmlModel_),this.actionsManager_.setWrappedActionsManager(this.editor_.getActionsManager()),this.contextMenu_=this.createContextMenu_(),this.configurationProviderFromLoadingOpt_=e.options.outlineConfigurationProvider;var n=e.options.outlineConfiguration;this.configurationFromLoadingOpt_=n?decodeURIComponent(n):null,this.selectionManager_=t.getSelectionManager(),this.editorEventHandler_.listen(this.editor_,sync.api.Editor.EventTypes.DISPOSE,this.resetEditorRelatedState_),this.editorEventHandler_.listen(this.selectionManager_,sync.api.SelectionManager.EventType.SELECTION_CHANGED,this.updateSelectionInTree_);var i=sync.api.AuthorEditingSupport.EventType;this.editorEventHandler_.listen(t,[i.MODEL_CHANGED,i.BEFORE_MODEL_CHANGED],this.updateTreeModel_),this.fetchOutlineConfig_()};sync.view.OutlinePanel.prototype.updateSelectionInTree_=function(){this.treeUpdater_&&this.treeUpdater_.updateSelection()};sync.view.OutlinePanel.prototype.updateTreeModel_=function(e){this.treeUpdater_&&this.treeUpdater_.updateLazily(e)};sync.view.OutlinePanel.prototype.attachListenersToSyncTreeSelectionToEditor_=function(e){e.listen(this.treeStruct_,sync.ui.TreeStructure.EventTypes.OPEN,function(t){t.node instanceof sync.ui.TreeNode&&(t.preventDefault(),this.selectNodeInEditor_(t.node,!0))},this),e.listen(this.treeStruct_,sync.ui.TreeStructure.EventTypes.CHANGE,function(){this.selectNodeInEditor_(this.treeStruct_.getSelectedItem())},this)};sync.view.OutlinePanel.prototype.selectNodeInEditor_=function(e,t){var n=e&&e.getModel()&&e.getModel().nodeId;if(n&&!this.treeUpdater_.isSettingSelection()){var i=this.editor_.getEditingSupport().getDocument().createApiNodeOrParent(n),o=this.computeSelectionForElement_(i);this.selectionManager_.setSelection(o,{focus:!!t}),this.xmlModel_.getXmlNodeById(n).scrollIntoView(!0)}};sync.view.OutlinePanel.prototype.computeSelectionForElement_=function(e){var t;if(sync.view.OutlinePanel.Modes.STRUCTURE===this.currentMode_)t=sync.api.Selection.createAroundNode(e);else{var n=this.domHandler_.getFirstNonIncludedLeaf(e,goog.bind(this.renderer_.isIncluded,this.renderer_));t=sync.api.Selection.createEmptySelectionInNode(n,"before")}return t};sync.view.OutlinePanel.prototype.getChildRetriever_=function(e){var t=this.editor_.getEditingSupport().getDocument().getHtmlNode();if(e){var n=this.xmlModel_.getXmlNodeById(e);t=n||t}return new sync.outline.ChildRetriever(this.xmlModel_,t,sync.view.OutlinePanel.Modes.STRUCTURE===this.currentMode_,this.outlineConfiguration_.getTOCModeElements())};sync.view.OutlinePanel.prototype.createTreeStructure_=function(){var e=this.currentMode_===sync.view.OutlinePanel.Modes.STRUCTURE;this.renderer_=new sync.outline.TreeRenderer(this.editor_.getEditingSupport(),this.outlineConfiguration_,this.maxLen_,e),goog.dom.removeChildren(this.treeContainer_),this.treeStruct_=new sync.view.OutlineTreeStructure(this.treeContainer_,this.renderer_,goog.bind(this.getChildRetriever_,this)),this.treeUpdater_=new sync.outline.TreeUpdater(this.treeStruct_,this.editor_.getEditingSupport()),workspace.getViewManager().isViewOpen("outline-panel")&&(this.treeUpdater_.resumeSync(),this.treeStruct_.expandFirstLevel()),this.treeEventHandler_=new goog.events.EventHandler(this),this.contextMenu_.attach(this.treeStruct_.getElement()),this.attachListenersToSyncTreeSelectionToEditor_(this.treeEventHandler_);var t=this.editor_.getEditingSupport().getConcurrentEditingManager();t&&this.treeEventHandler_.listen(t,sync.api.ConcurrentEditingManager.EventType.ROOM_CREATED,this.refresh_),this.createDragHandler_()};sync.view.OutlinePanel.prototype.fetchOutlineConfig_=function(){var e=goog.dom.createDom("div","outline-progress",tr(msgs.LOADING_)+"...");goog.dom.appendChild(this.treeContainer_,e);var t=!1;this.editorEventHandler_.listen(this.editor_,sync.api.Editor.EventTypes.DISPOSE,function(){t=!0}),this.configurationFromLoadingOpt_?this.outlineConfigReceived_(null,t,this.configurationFromLoadingOpt_):this.configurationProviderFromLoadingOpt_?this.configurationProviderFromLoadingOpt_(goog.bind(function(n){this.outlineConfigReceived_(null,t,n)},this)):this.editor_.getActionsManager().invokeOperation("com.oxygenxml.outline.GetOutlineConfiguration",{},goog.bind(this.outlineConfigReceived_,this,t),null,!0)};sync.view.OutlinePanel.prototype.outlineConfigReceived_=function(e,t,n){t||this.configureOutlinePanel_(new sync.outline.OutlineConfiguration(n))};sync.view.OutlinePanel.prototype.configureOutlinePanel_=function(e){this.outlineConfiguration_=e,this.outlineConfiguration_.isStructureModeDefault()||!this.outlineConfiguration_.isTOCModeEnabled()?this.currentMode_=sync.view.OutlinePanel.Modes.STRUCTURE:this.currentMode_=sync.view.OutlinePanel.Modes.CONTENTS,this.outlineConfiguration_.isTOCModeEnabled()&&this.outlineConfiguration_.isStructureModeEnabled()&&this.toolbarManager_.renderToolbar(this.actionsManager_,this.container_),this.createTreeStructure_(),this.refreshContextMenuConfiguration_(),this.treeUpdater_.syncSelection()};sync.view.OutlinePanel.prototype.disposeTreeStructure_=function(){this.treeStruct_&&(this.contextMenu_.detach(this.treeStruct_.getElement()),goog.dom.removeNode(this.treeStruct_.getElement()),this.treeUpdater_.dispose(),this.treeUpdater_=null,this.treeEventHandler_.removeAll(),this.treeStruct_.dispose(),this.treeStruct_=null,this.disposeDragHandler_())};sync.view.OutlinePanel.prototype.refreshContextMenuConfiguration_=function(){var e=this.contextMenu_;e.removeChildren(!0),e.setEntries&&e.setEntries([]),this.isEditable_()?(e.addAction("App/FocusAttributesPanel"),e.addSeparator(),e.addAction("Author/AppendChild"),e.addAction("Author/InsertBefore"),e.addAction("Author/InsertAfter"),e.addSeparator(),e.addAction("Author/CutSpecial"),e.addAction("Author/CopySpecial"),e.addSeparator(),e.addAction("Author/DeleteElement"),e.addAction("Author/RenameElement")):e.addAction("Author/CopySpecial"),e.addSeparator(),e.addAction("Outline/CollapseAll"),e.addAction("Outline/ExpandAll")};sync.view.OutlinePanel.prototype.createDragHandler_=function(){this.isEditable_()&&(this.dragHandler_=new sync.outline.DragHandler(this.editor_,this.treeStruct_,this.treeContainer_,this.xmlModel_,this.treeUpdater_))};sync.view.OutlinePanel.prototype.isEditable_=function(){let e=this.editor_.getReadOnlyStatus().isReadOnly();var t=this.currentMode_===sync.view.OutlinePanel.Modes.STRUCTURE?this.outlineConfiguration_.isStructureModeEditable():this.outlineConfiguration_.isTOCModeEditable(),n=this.editor_.getEditingSupport().getConcurrentEditingManager(),i=n&&n.isInRoom();return!e&&t&&!i};sync.view.OutlinePanel.prototype.createContext_=function(){if(this.treeStruct_){var e=this.treeStruct_.getSelectedItem();if(e){var t=e.getModel();if(t&&t.nodeId&&this.editor_)var n=this.editor_.getEditingSupport().getDocument(),i=function(){try{var r=n.createApiNodeOrParent(t.nodeId);return sync.api.Selection.createAroundNode(r)}catch(s){return console.warn(s),null}};var o=e.getLabelElement()}}return new sync.actions.ActionWithContext.Context({computeSelection:i||goog.nullFunction,anchor:o})};sync.view.OutlinePanel.prototype.refreshContext_=function(e){Object.keys(e).forEach(function(t){delete e[t]}),Object.assign(e,this.createContext_())};sync.view.OutlinePanel.prototype.createContextMenu_=function(){var e={},t={elementClass:"outline-menu",createMenuItem:function(i,o){return new sync.outline.OutlineContextMenuItem(i,o,e)}},n=new sync.view.PopupMenu(this.actionsManager_,null,t);return this.registerDisposable(n),goog.events.listen(n,goog.ui.Component.EventType.BEFORE_SHOW,goog.bind(function(){t.lastFocus=document.activeElement,this.refreshContext_(e)},this),!0),n};sync.view.OutlinePanel.prototype.handleShortcuts_=function(e){var t=this.actionsManager_&&this.actionsManager_.getActionByShortcut(e);this.isActionEnabledInOutline_(t)&&(e.preventDefault(),this.actionsManager_.executeActionInContext(t,this.createContext_(),goog.bind(function(){this.treeUpdater_.sync(),this.treeStruct_.focus()},this)))};sync.view.OutlinePanel.prototype.isActionEnabledInOutline_=function(e){return e&&(this.actionsManager_.hasId(e,sync.outline.ActionsManager.COPY_ACTION_ID)||this.isEditable_())};sync.view.OutlinePanel.prototype.opened=function(){this.treeUpdater_&&this.treeUpdater_.resumeSync()};sync.view.OutlinePanel.prototype.closed=function(){this.treeUpdater_&&this.treeUpdater_.stopSync()};sync.view.OutlinePanel.prototype.disposeInternal=function(){this.resetEditorRelatedState_(),sync.view.OutlinePanel.superClass_.disposeInternal.call(this)};sync.view.OutlinePanel.prototype.resetEditorRelatedState_=function(){this.editorEventHandler_.removeAll(),this.toolbarManager_.removeToolbar(),this.disposeTreeStructure_()};sync.view.OutlinePanel.prototype.disposeDragHandler_=function(){this.dragHandler_&&(this.dragHandler_.dispose(),this.dragHandler_=null)};sync.view.OutlinePanel.prototype.getIcon=function(e){return sync.util.computeHdpiIcon("../plugin-resources/web-author-outline-plugin/Outline24.png")};sync.view.OutlineTreeStructure=function(e,t,n){var i={showRoot:!1};this.nodeIdToOutlineNodes_=new Map,this.renderer_=t,this.childRetrieverProvider_=n,sync.ui.TreeStructure.call(this,e,i,[]),this.getHandler().listen(e,goog.events.EventType.CLICK,this.handleClick_,!0),this.getHandler().listen(e,goog.events.EventType.CONTEXTMENU,this.handleContextMenu_,!0),this.getHandler().listen(e,goog.events.EventType.DBLCLICK,this.handleDblClick_,!0),this.isSelectedAfter_=!1,this.isSelectedBefore_=!1};goog.inherits(sync.view.OutlineTreeStructure,sync.ui.TreeStructure);sync.view.OutlineTreeStructure.prototype.focus=function(){this.getElement().focus()};sync.view.OutlineTreeStructure.prototype.isSelectedBefore=function(){return this.isSelectedBefore_};sync.view.OutlineTreeStructure.prototype.isSelectedAfter=function(){return this.isSelectedAfter_};sync.view.OutlineTreeStructure.prototype.updateTree=function(){this.setSelection(null),this.removeChildren(!0),this.nodeIdToOutlineNodes_.clear();for(var e=this.childRetrieverProvider_(),t=e.getRootElementIds(),n=0;n<t.length;n++){var i=e.getSubtreeData(t[n]);this.addSubtree(this,i)}};sync.view.OutlineTreeStructure.prototype.updateSubtree=function(e){var t=this.getNodeById(e);if(t){var n=this.childRetrieverProvider_(e);this.removeFromIndex_(t),this.nodeIdToOutlineNodes_.set(e,t),t.removeChildren(!0);for(var i=n.getSubtreeData(e),o=0;o<i.children.length;o++)this.addSubtree(t,i.children[o]);this.updateLabel(e)}};sync.view.OutlineTreeStructure.prototype.addSubtree=function(e,t){var n=sync.view.OutlineTreeStructure.superClass_.addSubtree.call(this,e,t);if(n){var i=new goog.events.Event(sync.view.OutlineTreeStructure.EventType.NODE_CREATED,n);this.dispatchEvent(i)}};sync.view.OutlineTreeStructure.prototype.removeFromIndex_=function(e){this.nodeIdToOutlineNodes_.delete(e.getModel().nodeId),e.forEachChild(goog.bind(this.removeFromIndex_,this))};sync.view.OutlineTreeStructure.prototype.updateLabel=function(e){this.renderer_.getAncestorWithAffectedLabel(e).map(this.getNodeById,this).forEach(function(t){t&&t.updateLabel()})};sync.view.OutlineTreeStructure.prototype.createNodeFromData=function(e){var t=new sync.view.OutlineTreeNode(e);return this.nodeIdToOutlineNodes_.set(e.nodeId,t),t};sync.view.OutlineTreeStructure.prototype.handleClick_=function(e){var t=this.getNodeFromEvent_(e);if(t){var n=goog.dom.contains(t.getLabelElement(),e.target);n&&this.getSelectedItem()===t&&this.dispatchEvent(goog.events.EventType.CHANGE)}};sync.view.OutlineTreeStructure.prototype.handleContextMenu_=function(e){var t=this.getNodeFromEvent_(e);t&&((this.isSelectedBefore()||this.isSelectedAfter())&&!e.button?(e.stopPropagation(),e.preventDefault()):this.setSelection(t))};sync.view.OutlineTreeStructure.prototype.handleDblClick_=function(e){var t=this.getNodeFromEvent_(e);if(t){var n=goog.dom.contains(t.getLabelElement(),e.target);n&&t.toggle()}};sync.view.OutlineTreeStructure.prototype.handleKeyEvent=function(e){var t=!0;e.keyCode===goog.events.KeyCodes.ENTER&&e.preventDefault();var n=this.getSelectedItem();if(n)switch(e.keyCode){case goog.events.KeyCodes.RIGHT:this.handleRight(n,e);break;case goog.events.KeyCodes.LEFT:this.handleLeft(n,e);break;case goog.events.KeyCodes.DOWN:this.handleDown(n,e);break;case goog.events.KeyCodes.UP:this.handleUp(n,e);break;default:t=!1}t?e.preventDefault():sync.view.OutlineTreeStructure.superClass_.handleKeyEvent.call(this,e)};sync.view.OutlineTreeStructure.prototype.handleLeft=function(e,t){if(!t.altKey){var n=this.isSelectedAfter()||this.isSelectedBefore();if(!n&&e.hasChildren()&&e.getExpanded()&&e.isUserCollapsible())e.setExpanded(!1);else{var i=e.getParent(),o=e.getTree();i&&(o.getShowRootNode()||i!==o)&&this.setSelection(i)}}};sync.view.OutlineTreeStructure.prototype.handleRight=function(e,t){t.altKey||this.isSelectedAfter()||this.isSelectedBefore()||e.hasChildren()&&(e.getExpanded()?this.setSelection(e.getFirstChild()):e.setExpanded(!0))};sync.view.OutlineTreeStructure.prototype.handleUp=function(e,t){if(this.isSelectedAfter())this.setSelection(e);else{var n=e.getPreviousShownNode();n&&this.setSelection(n)}};sync.view.OutlineTreeStructure.prototype.handleDown=function(e,t){if(this.isSelectedBefore())this.setSelection(e);else{var n=e.getNextShownNode();n&&this.setSelection(n)}};sync.view.OutlineTreeStructure.prototype.expandFirstLevel=function(){var e=this.getTree(),t=e.getChildren();t.length===1&&t[0].expand()};sync.view.OutlineTreeStructure.prototype.getNodeById=function(e){var t=null;return this.nodeIdToOutlineNodes_.has(e)&&(t=this.nodeIdToOutlineNodes_.get(e)),t};sync.view.OutlineTreeStructure.prototype.removeNode=function(e){};sync.view.OutlineTreeStructure.prototype.setNode=function(e){};sync.view.OutlineTreeStructure.prototype.setSelection=function(e,t,n){t=!!t,n=!!n;var i=!1,o=this.getSelectedItem();o&&o instanceof sync.view.OutlineTreeNode&&(o===e&&(i=!0),goog.dom.classlist.remove(o.getElement(),"outline-selection-before"),goog.dom.classlist.remove(o.getElement(),"outline-selection-after")),e&&(this.expandParentsOfNode_(e),this.isSelectedBefore_=n,this.isSelectedAfter_=t,goog.dom.classlist.enable(e.getElement(),"outline-selection-before",n),goog.dom.classlist.enable(e.getElement(),"outline-selection-after",t)),this.setSelectedItem(e),i&&this.dispatchEvent(goog.events.EventType.CHANGE)};sync.view.OutlineTreeStructure.prototype.expandParentsOfNode_=function(e){for(var t=[],n=e.getParent();n;)t.push(n),n=n.getParent();for(var i=t.length-1;i>=0;i--)t[i].setExpanded(!0)};sync.view.OutlineTreeStructure.EventType={NODE_CREATED:"node_created"};sync.view.OutlineTreeNode=function(e){sync.ui.TreeNode.call(this,e,sync.view.OutlineTreeNode.defaultConfig),this.safeHtml_=null};goog.inherits(sync.view.OutlineTreeNode,sync.ui.TreeNode);sync.view.OutlineTreeNode.prototype.getSafeHtml=function(){return this.safeHtml_||(this.safeHtml_=this.getTree().renderer_.getSafeHtml(this.getModel().nodeId)),this.safeHtml_};sync.view.OutlineTreeNode.prototype.updateLabel=function(){if(this.safeHtml_){this.safeHtml_=this.getTree().renderer_.getSafeHtml(this.getModel().nodeId);var e=goog.html.SafeHtml.create("span",null,this.getSafeHtml()),t=this.getDomHelper().safeHtmlToNode(e),n=this.getLabelElement();goog.dom.removeChildren(n),goog.dom.append(n,t.childNodes)}};sync.view.OutlineTreeNode.prototype.getElement=function(){return this.safeHtml_?sync.view.OutlineTreeNode.superClass_.getElement.call(this):this.element_};sync.view.OutlineTreeNode.defaultConfig=sync.util.extend(goog.object.clone(goog.ui.tree.BaseNode.defaultConfig),{cssExpandedFolderIcon:"outline-element-icon",cssCollapsedFolderIcon:"outline-element-icon",cssFileIcon:"outline-element-icon",cssItemLabel:"goog-tree-item-label vertical-align-children"});sync.view.OutlineTreeNode.prototype.expandAll=function(){this.expand(),sync.view.OutlineTreeNode.superClass_.expandChildren.call(this)};sync.view.OutlineTreeNode.prototype.onClick_=function(e){var t=e.target;if(t===this.getExpandIconElement()&&this.hasChildren()){this.isUserCollapsible()&&this.toggle();return}this.getTree().setSelection(this),this.updateRow()};(function(){var e,t="outlinePlacement";goog.events.listen(workspace,sync.api.Workspace.EventType.BEFORE_EDITOR_LOADED,function(n){e=n.options[t]}),goog.events.listen(workspace,sync.api.Workspace.EventType.EDITOR_LOADED,function(){var n=workspace.getViewManager();n.addView("outline-panel");var i=e||sync.options.PluginsOptions.getClientOption(t)||"left";n.installView("outline-panel",new sync.view.OutlinePanel,i)})})();goog.provide("sync.outline.TreeRenderer");sync.outline.TreeRenderer=function(e,t,n,i){this.xmlModel_=e.getXmlModel(),this.outlineConfiguration_=t,this.maxLen_=n,this.structureModeIsOn_=i,this.domUtil_=new sync.outline.DomUtil(this.xmlModel_),this.editingSupport_=e};sync.outline.TreeRenderer.prototype.getObjForNode_=function(e){var t=this.xmlModel_.getXmlNodeById(e),n={text:""};if(t){var i=sync.view.NodeRenderer.getRenderedText(t);if(this.structureModeIsOn_)n.relevantAttribute=this.getRelevantAttribute(t),n.tagName=i,n.text=this.getTextContent_(t,this.maxLen_).trim();else{var o=this.evaluateTitleLocators_(t);o===null&&(o=this.getTextContent_(t,this.maxLen_).trim()),goog.string.isEmptyOrWhitespace(o)&&sync.model.XmlDom.isXmlElement(t)&&(o=i),n.text=o}}return n};sync.outline.TreeRenderer.prototype.getRelevantAttribute=function(e){var t=this.outlineConfiguration_.getStructureModePrefAttributes(),n=null,i=sync.model.XmlDom.getAttributes(e);return i&&(n=t&&goog.array.find(t,function(o){return i[o]}),n&&(n=i[n].attributeValue)),n};sync.outline.TreeRenderer.prototype.evaluateTitleLocators_=function(e){var t=null,n=this.outlineConfiguration_.getTOCTitleLocators();if(n.size!==0){var i=this.editingSupport_.getDocument().createApiNodeOrNull(e);if(i){var o=n.get(i.localName);if(o){var r=this.domUtil_.evaluateSimpleXPath(i,o);t=r?r.textContent:""}}}return t};sync.outline.TreeRenderer.prototype.getTitleLocator_=function(e){var t=this.outlineConfiguration_.getTOCTitleLocators(),n=this.editingSupport_.getDocument().createApiNodeOrNull(e),i=null;return n&&(i=t.get(n.localName)),i};sync.outline.TreeRenderer.prototype.getAncestorWithAffectedLabel=function(e){for(var t=[e],n=this.xmlModel_.getXmlNodeById(e);n&&this.domUtil_.isInline(n);)n=sync.model.XmlDom.getParentNode(n),t.push(sync.model.XmlModel.getIdOfXmlNode(n));return t};sync.outline.TreeRenderer.prototype.getTextContent_=function(e,t){var n="",i=sync.model.XmlDom.getFirstChild(e);if(i===null){var o=sync.outline.DomUtil.getOxyLabel(e);o&&(n+=o)}else for(var r=t,s=!1,l=i;l&&n.length<r;){if(sync.model.XmlDom.isTextNode(l)||sync.model.XmlDom.isEntity(l))n+=sync.model.XmlDom.getTextContent(l);else if(sync.model.XmlDom.isXmlElement(l)){if(this.domUtil_.isInline(l))n+=this.getTextContent_(l,t);else{if(this.isIncluded(l))return sync.outline.DomUtil.getOxyLabel(e);if(s||(s=!0,goog.string.isEmptyOrWhitespace(n)&&(n+=this.getTextContent_(l,t),!goog.string.isEmptyOrWhitespace(n))))return n}t-=n.length}l=sync.model.XmlDom.getNextSibling(l)}return n};sync.outline.TreeRenderer.prototype.getFirstTextNodeChild=function(e,t){var n;if(e.getType()===goog.dom.NodeType.TEXT)n=e;else if(e.getType()===goog.dom.NodeType.ELEMENT){for(var i=e.getChildNodes(),o=0;o<i.length;o++)if(i[o].getType()===goog.dom.NodeType.TEXT){n=i[o];break}else if(t&&i[o].getType()===goog.dom.NodeType.ELEMENT){n=this.getFirstTextNodeChild(i[o],!1);break}}return n};sync.outline.TreeRenderer.prototype.getSafeHtml=function(e){var t=this.getObjForNode_(e),n=[];t.text&&t.text.length>this.maxLen_&&(t.text=this.trimLabel_(t.text,this.maxLen_)),t.tagName&&n.push(goog.html.SafeHtml.create("span",{class:"outline-tagName"},t.tagName)),t.relevantAttribute&&n.push(goog.html.SafeHtml.create("span",{class:"outline-attribute"},'"'+t.relevantAttribute+'"'));var i=goog.html.SafeHtml.create("span",{class:"outline-text","data-oxy-outline-id":e},t.text);return n.push(i),n};sync.outline.TreeRenderer.prototype.trimLabel_=function(e,t){var n=e.trim().substring(0,t);if(n.length>t){var i=Math.floor(t*3/4),o=n.indexOf(".",i);if(o!==-1)n=n.substring(0,o);else{var r=n.indexOf(" ",i);r!==-1&&(n=n.substring(0,r))}}return n};sync.outline.TreeRenderer.prototype.isIncluded=function(e){var t=!1;if(this.structureModeIsOn_)t=!0;else if(sync.model.XmlDom.isXmlElement(e)){var n=this.outlineConfiguration_.getTOCModeElements();t=n.indexOf(sync.model.XmlDom.getTagName(e))!==-1}return t};goog.provide("sync.outline.TreeUpdater");sync.outline.TreeUpdater=function(e,t){this.syncDebouncer_=new goog.async.Debouncer(this.sync,250,this),this.selDebouncer_=new goog.async.Debouncer(this.syncSelection,100,this),this.treeStruct_=e,this.treeStruct_.listen(sync.ui.TreeStructure.EventTypes.CHANGE_FILTERED_CONTENT,()=>{this.update_.full=!0,this.sync()}),this.editingSupport_=t,this.stopped_=!0,this.update_={full:!0,toRefresh:new Set,labels:new Set},this.mayGenerateSelectionEvents_=!1};sync.outline.TreeUpdater.prototype.isSettingSelection=function(){return this.mayGenerateSelectionEvents_};sync.outline.TreeUpdater.prototype.resetPendingUpdates_=function(){this.update_={labels:new Set,toRefresh:new Set}};sync.outline.TreeUpdater.prototype.isInSync_=function(){return!this.update_.full&&this.update_.labels.size===0&&this.update_.toRefresh.size===0};sync.outline.TreeUpdater.prototype.stopSync=function(){this.stopped_=!0,this.syncDebouncer_.stop(),this.selDebouncer_.stop()};sync.outline.TreeUpdater.prototype.resumeSync=function(){this.stopped_=!1,this.isInSync_()?this.syncSelection():this.sync()};sync.outline.TreeUpdater.prototype.handleUpdatedNode_=function(e){var t=this.getParentInOutline_(e);t?e.getType()===goog.dom.NodeType.TEXT?this.update_.labels.add(t.id):this.update_.toRefresh.add(t.id):this.update_.full=!0};sync.outline.TreeUpdater.prototype.scheduleParentForUpdate_=function(e){var t=e.getParent(),n=t?this.getParentInOutline_(t):null;n?this.update_.toRefresh.add(n.id):this.update_.full=!0};sync.outline.TreeUpdater.prototype.updateLazily=function(e){var t=e.mutation;e.type===sync.api.AuthorEditingSupport.EventType.MODEL_CHANGED?(t.inserted.forEach(this.scheduleParentForUpdate_,this),t.updated.forEach(this.handleUpdatedNode_,this),this.stopped_||this.syncDebouncer_.fire()):t.deleted.forEach(this.scheduleParentForUpdate_,this)};sync.outline.TreeUpdater.prototype.updateSelection=function(){this.stopped_||this.selDebouncer_.fire()};sync.outline.TreeUpdater.prototype.hasAncestorInSet_=function(e,t){for(var n=!1,i=this.treeStruct_.getNodeById(e),o=i&&i.getParent();o;){var r=o.getModel();if(r&&t.has(r.nodeId)){n=!0;break}o=o.getParent()}return n};sync.outline.TreeUpdater.prototype.minimizeNodeSet_=function(e){var t=new Set;return e.forEach(function(n){this.hasAncestorInSet_(n,e)||t.add(n)},this),t};sync.outline.TreeUpdater.prototype.applyUpdates_=function(){var e=this.treeStruct_;if(this.update_.full)e.updateTree();else try{this.minimizeNodeSet_(this.update_.toRefresh).forEach(e.updateSubtree,e),this.update_.labels.forEach(e.updateLabel,e)}catch(t){console.error(t),e.updateTree()}};sync.outline.TreeUpdater.prototype.sync=function(){this.syncDebouncer_.stop(),this.mayGenerateSelectionEvents_=!0;try{this.applyUpdates_()}finally{this.mayGenerateSelectionEvents_=!1,this.resetPendingUpdates_()}this.syncSelection()};sync.outline.TreeUpdater.prototype.syncSelection=function(){if(this.isInSync_()){this.selDebouncer_.stop(),this.mayGenerateSelectionEvents_=!0;try{var e=this.computeOutlineSelection_();this.treeStruct_.setSelection(e.node,e.isAfter,e.isBefore)}finally{this.mayGenerateSelectionEvents_=!1}}};sync.outline.TreeUpdater.prototype.dispose=function(){this.syncDebouncer_.dispose(),this.selDebouncer_.dispose()};sync.outline.TreeUpdater.prototype.getParentInOutline_=function(e){for(e.nodeType===goog.dom.NodeType.TEXT&&(e=e.getParent());e&&!this.treeStruct_.getNodeById(e.id);)e=e.getParent();return e};sync.outline.TreeUpdater.prototype.computeOutlineSelection_=function(){var e=this.treeStruct_.getChildren().length!==0;if(!e)return{};var t=this.editingSupport_.getSelectionManager().getSelection(),n=t.getNodeAtSelection(),i,o;if(n){var r=this.getParentInOutline_(n);if(i=r?this.treeStruct_.getNodeById(r.id):null,!workspace.a11y.isEnabled()){var s=this.findNodeToSelectInOutline_(t),l;i?(l=i.getChildren(),o=this.getNodeBefore_(s,l)):(l=this.treeStruct_.getChildren(),s.getType()===goog.dom.NodeType.DOCUMENT?o=l[l.length-1]:o=this.getNodeBefore_(s,l))}}var a;if(o)a={node:o,isAfter:!0};else if(i)a={node:i};else{var u=this.treeStruct_.getChildren()[0];a={node:u,isBefore:!0}}return a};sync.outline.TreeUpdater.prototype.findNodeToSelectInOutline_=function(e){var t;if(e.getFullySelectedNode())t=e.getFullySelectedNode();else{var n=e.getCaretPositionInformation();n.isOnText()?t=e.getNodeAtSelection(!0):t=n.getNodeOfTag()}return t};sync.outline.TreeUpdater.prototype.getNodeBefore_=function(e,t){for(var n=null,i=0;i<t.length;i++){var o=t[i],r=o.getModel().nodeId,s=this.editingSupport_.getDocument().createApiNodeOrNull(r);if(!!s){var l=e.compareDocumentPosition(s);if(l&Node.DOCUMENT_POSITION_PRECEDING)n=o;else break}}return n};})();
