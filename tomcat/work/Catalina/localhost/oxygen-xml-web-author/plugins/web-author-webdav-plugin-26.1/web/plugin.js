(()=>{(function(){var d={NAME_:{en_US:"Name",fr_FR:"Nom",ja_JP:"\u540D\u524D",nl_NL:"Naam",zh_CN:"\u59D3\u540D"},PASSWORD_:{en_US:"Password",de_DE:"Passwort",fr_FR:"Mot de passe",ja_JP:"\u30D1\u30B9\u30EF\u30FC\u30C9",nl_NL:"Wachtwoord",zh_CN:"\u5BC6\u7801"},CONNECT_:{en_US:"Connect",de_DE:"Verbinden",fr_FR:"Connexion",ja_JP:"\u63A5\u7D9A",nl_NL:"Verbind",zh_CN:"\u8FDE\u63A5"},EDIT_SERVER_URL_:{en_US:"Change server",de_DE:"Server-URL bearbeiten",fr_FR:"\xC9diter l'URL du serveur",ja_JP:"\u30B5\u30FC\u30D0\u30FCURL\u3092\u7DE8\u96C6\u3059\u308B",nl_NL:"Server-URL bewerken",zh_CN:"\u66F4\u6539\u670D\u52A1\u5668"},INVALID_URL_:{en_US:"Invalid URL",de_DE:"Ung\xFCltige URL",fr_FR:"URL invalide",ja_JP:"\u4E0D\u6B63\u306AURL",nl_NL:"Ongeldige URL",zh_CN:"\u65E0\u6548\u7684URL"},SERVER_URL_:{en_US:"Server URL",de_DE:"Server-URL",fr_FR:"URL du serveur",ja_JP:"\u30B5\u30FC\u30D0\u30FC URL",zh_CN:"\u670D\u52A1\u5668URL"},SERVER_CANNOT_BE_REACHED_:{en_US:"Web Author server cannot be reached.",de_DE:"Web-Author-Server konnte nicht erreicht werden.",fr_FR:"Le serveur Web Author n'est pas accessible.",ja_JP:"Web Author \u30B5\u30FC\u30D0\u30FC\u306B\u5230\u9054\u3067\u304D\u307E\u305B\u3093\u3002",nl_NL:"Web Author-server is niet bereikbaar.",zh_CN:"\u65E0\u6CD5\u8BBF\u95EEWeb\u4F5C\u8005\u670D\u52A1\u5668\u3002"}};sync.Translation.addTranslations(d)})();(function(){goog.events.listen(workspace,sync.api.Workspace.EventType.BEFORE_EDITOR_LOADED,function(d){var a=sync.util.getURLParameter("autoSaveInterval");if(!a){var l=parseInt(sync.options.PluginsOptions.getClientOption("webdav_autosave_interval"));d.options.url.match(/^webdav-https?:/)&&(d.options.autoSaveInterval=l)}})})();(function(){function d(e){return e&&e.indexOf("webdav-")===0&&(e=e.substring(7)),e}function a(e,t){var o=e;if(t){var r=t==="FILE";!r&&e.lastIndexOf("/")!==e.length-1&&(o=e+"/")}return o.indexOf("webdav-")!==0&&(o="webdav-"+o),o}UsersManager={},UsersManager.STORAGE_KEY="webdav.users",UsersManager.editorURL=decodeURIComponent(sync.util.getURLParameter("url")),UsersManager.saveUser=function(e,t){if(t=t||UsersManager.editorURL,!!t){t=a(t);var o=UsersManager.computeServerID_(t),r=JSON.parse(localStorage.getItem(UsersManager.STORAGE_KEY)||"{}");r[o]=e,localStorage.setItem(UsersManager.STORAGE_KEY,JSON.stringify(r))}},UsersManager.getUser=function(e){e=e||UsersManager.editorURL;var t;if(e){e=a(e);var o=UsersManager.computeServerID_(e),r=JSON.parse(localStorage.getItem(UsersManager.STORAGE_KEY)||"{}");t=r[o]}return t},UsersManager.computeServerID_=function(e){var t=null;if(e){var o=new sync.util.Url(e);t=o.getScheme()+o.getDomain()+(o.getPort()||"")}return t},UsersManager.clearUsers=function(e){localStorage.removeItem(UsersManager.STORAGE_KEY)};var l=function(e,t,o){this.serverUrl_=e,this.loginCallback=null,this.userChangedCallback=t,this.forceDialog_=!!o};l.prototype.login=function(e){this.loginCallback=e;var t=document.querySelector(".file-list-login-container");if(t&&!this.forceDialog_)this.renderInlineLoginForm(t);else{var o=this.createLoginDialog();o.show(),this.renderLoginForm(o.getElement(),"form")}},l.prototype.renderLoginForm=function(e,t){var o=goog.dom.createDom,r=o("input",{id:"webdav-name",type:"text",class:"oxy-input",autocorrect:"off",autocapitalize:"none",autofocus:"",autocomplete:"username"});goog.dom.appendChild(e,o(t,"webdav-login-dialog",o("label","",tr(msgs.NAME_)+": ",r),o("label","",tr(msgs.PASSWORD_)+": ",o("input",{id:"webdav-passwd",type:"password",class:"oxy-input",autocomplete:"current-password"}))));try{var s=UsersManager.getUser(this.serverUrl_)}catch(g){console.warn(g)}r.value=s||"",r.select()},l.prototype.submitCredentials=function(e){var t=e.querySelector("#webdav-name"),o=t.value.trim(),r=e.querySelector("#webdav-passwd"),s=r.value,g=this.serverUrl_;goog.net.XhrIo.send("../plugins-dispatcher/login",goog.bind(function(){this.loginCallback(),this.userChangedCallback(o);try{UsersManager.saveUser(o,g)}catch(v){console.warn(v)}},this),"POST",goog.Uri.QueryData.createFromMap(new goog.structs.Map({user:o,passwd:s,server:a(this.serverUrl_)})).toString(),{"X-Requested-With":"dav"})},l.prototype.createLoginDialog=function(){var e=workspace.createDialog();return e.setTitle(tr(msgs.CONNECT_)),e.setPreferredSize(300,null),e.onSelect(goog.bind(function(t){t==="ok"&&this.submitCredentials(e.getElement()),e.dispose()},this)),e},l.prototype.renderInlineLoginForm=function(e){var t=goog.dom.createDom("form","webdav-login-form");goog.dom.removeChildren(e),goog.dom.appendChild(t,goog.dom.createDom("div","webdav-login-form-title",tr(msgs.CONNECT_))),goog.dom.appendChild(e,t),this.renderLoginForm(t,"div");var o=goog.dom.createDom("button",["oxy-button","oxy-primary-button"],tr(msgs.CONNECT_));goog.dom.appendChild(t,goog.dom.createDom("div","webdav-button-container",o)),goog.events.listen(o,goog.events.EventType.CLICK,goog.bind(function(){this.submitCredentials(t),goog.dom.removeNode(t)},this))};var n={};n.login=function(e,t){new l(e,this.userChangedCallback).login(t)},n.getUserName=function(){try{return UsersManager.getUser()}catch(e){console.warn(e)}},n.setUserChangedCallback=function(e){this.userChangedCallback=e},n.logout=function(e){goog.net.XhrIo.send("../plugins-dispatcher/login?action=logout",function(){e();try{UsersManager.clearUsers()}catch(t){console.warn(t)}},"POST",null,{"X-Requested-With":"dav"})},n.createRootUrlComponent=function(e,t,o){var r=new i(e,t,o,this.enforcedServers);return r.render()},n.getUrlInfo=function(e,t,o){var r=new c(null,o);r.requestUrlInfo_(e,t)},n.addEnforcedUrl_=function(e){e&&(this.enforcedServers.push(a(e)),n.enforcedServersProcessed&&p())};var i=function(e,t,o,r){this.rootUrl_=e,this.rootChangedCb_=t,this.enforcedServers_=r||[],this.canEdit_=this.enforcedServers_.length!==1&&!o,this.serverDiv_=null,this.inplaceNotificator_=null};i.prototype.render=function(){return this.serverDiv_=goog.dom.createDom("div","webdav-repo"),!this.rootUrl_&&this.canEdit_?this.renderRepoEditElement_():this.renderRepoPreviewElement_(),this.serverDiv_},i.prototype.hideErrorMessage=function(){this.inplaceNotificator_.hide()},i.prototype.showErrorMessage=function(e){this.inplaceNotificator_.show(e,sync.view.InplaceNotificationReporter.types.ERROR)},i.prototype.resetRendering_=function(){this.inplaceNotificator_&&this.inplaceNotificator_.dispose(),this.serverDiv_.innerHTML="",this.inplaceNotificator_=new sync.view.InplaceNotificationReporter(this.serverDiv_)},i.prototype.renderRepoPreviewElement_=function(){var e=null;this.canEdit_&&(e=goog.dom.createDom("button",{className:"webdav-domain-edit",title:tr(msgs.EDIT_SERVER_URL_)}),goog.events.listen(e,goog.events.EventType.CLICK,goog.bind(this.renderRepoEditElement_,this))),this.resetRendering_(),goog.dom.append(this.serverDiv_,goog.dom.createDom("div",{className:"domain-icon",style:"background-image: url("+sync.util.getImageUrl("/images/SharePointWeb16.png",sync.util.getHdpiFactor())+");vertical-align: middle;"}),goog.dom.createDom("div","webdav-repo-preview",new sync.util.Url(this.rootUrl_).getDomain(),e))},i.prototype.commitEditFileServerChanges_=function(){this.hideErrorMessage();var e=document.getElementById("webdav-browse-url"),t=e.value.trim();if(t)if(t.match("(webdav-)?https?://"))if(this.enforcedServers_.length>0){try{localStorage.setItem("webdav.latestEnforcedURL",t)}catch(g){console.warn(g)}var o=a(t);this.rootChangedCb_(o,o)}else{var r=new c(goog.bind(this.showSpinner_,this),goog.bind(this.showErrorMessage,this));r.requestUrlInfo_(a(t),this.rootChangedCb_)}else{var s=tr(msgs.INVALID_URL_)+": "+d(t);this.showErrorMessage(s)}else this.showErrorMessage(tr(msgs.INVALID_URL_))},i.prototype.showSpinner_=function(e){var t=document.querySelector(".webdav-domain-set");e?(t.disabled="true",goog.dom.classlist.add(t,"oxy-spinner")):t&&(t.removeAttribute("disabled"),goog.dom.classlist.remove(t,"oxy-spinner"))},i.prototype.renderRepoEditElement_=function(){var e=goog.dom.createDom,t=e("button",{class:"oxy-button oxy-small-button oxy-primary-button webdav-domain-set"},tr(msgs.CONNECT_));goog.events.listen(t,goog.events.EventType.CLICK,goog.bind(this.commitEditFileServerChanges_,this));var o=null;this.rootUrl_&&(o=e("button",{className:"oxy-button oxy-small-button webdav-domain-cancel"},tr(msgs.CANCEL_)),goog.events.listen(o,goog.events.EventType.CLICK,goog.bind(this.cancelEditMode_,this)));var r=this.createRootURLEditElement_();this.resetRendering_(),goog.dom.appendChild(this.serverDiv_,e("div","webdav-repo-editing",e("div","webdav-repo-edit-label",tr(msgs.SERVER_URL_)+":"),r,e("div","webdav-button-container",t,o))),r.focus()},i.prototype.getEnforcedServersOptions_=function(){for(var e=[],t=0;t<this.enforcedServers_.length;t++){var o=this.enforcedServers_[t];if(o){var r=goog.dom.createDom("option",{value:o},o);try{o===localStorage.getItem("webdav.latestEnforcedURL")&&r.setAttribute("selected","")}catch(s){console.warn(s)}e.push(r)}}return e},i.prototype.cancelEditMode_=function(){this.renderRepoPreviewElement_();var e=this.serverDiv_.querySelector("button");e&&setTimeout(function(){e.focus()})},i.prototype.createRootURLEditElement_=function(){var e=goog.dom.createDom,t=null,o=this.getEnforcedServersOptions_();return o.length!==0?t=e("select",{id:"webdav-browse-url"},o):(t=e("input",{id:"webdav-browse-url",type:"text",class:"oxy-input",autocorrect:"off",autocapitalize:"none",autofocus:!0,value:d(this.rootUrl_)||""}),this.rootUrl_&&(goog.events.listen(t,[goog.events.EventType.KEYDOWN,goog.events.EventType.KEYPRESS],function(r){(r.keyCode===goog.events.KeyCodes.ESC||r.keyCode===goog.events.KeyCodes.ENTER)&&r.stopPropagation()}),goog.events.listen(t,goog.events.EventType.KEYDOWN,goog.bind(function(r){r.keyCode===goog.events.KeyCodes.ESC?this.cancelEditMode_():r.keyCode===goog.events.KeyCodes.ENTER&&this.commitEditFileServerChanges_()},this)))),t};var c=function(e,t){this.showError_=t||goog.bind(console.log,console),this.reqStatusListener_=e||goog.nullFunction};c.prototype.requestUrlInfo_=function(e,t){this.reqStatusListener_(!0),goog.net.XhrIo.send("../plugins-dispatcher/webdav-url-info?url="+encodeURIComponent(e),goog.bind(this.handleUrlInfoReceived_,this,e,t))},c.prototype.handleUrlInfoReceived_=function(e,t,o){this.reqStatusListener_(!1);var r=o.target,s=r.getStatus();if(s===200){var g=r.getResponseJson();if(g.errorMessage)this.showError_(g.errorMessage);else{var v=a(e,g.type),m=a(g.rootUrl,"COLLECTION");t(m,v)}}else if(s===401)new l(e,n.userChangedCallback,!0).login(goog.bind(this.requestUrlInfo_,this,e,t));else{var u;s===0?u=tr(msgs.SERVER_CANNOT_BE_REACHED_):u=tr(msgs.INVALID_URL_)+": "+d(e),this.showError_(u)}};var _=sync.options.PluginsOptions.getClientOption("hide_connector_tab");if(_!=="true"){let e=function(t){return t.match(/^webdav-https?:/)};var E=e;n.enforcedServers=[];var h=sync.options.PluginsOptions.getClientOption("enforced_webdav_server");h&&n.addEnforcedUrl_(h),window.addEnforcedWebdavUrl=goog.bind(n.addEnforcedUrl_,n);var f={id:"webdav",name:"WebDAV",icon:sync.util.computeHdpiIcon("../plugin-resources/webdav/Webdav70.png"),matches:e,fileServer:n};workspace.getFileServersManager().registerFileServerConnector(f)}function p(){var e=n.enforcedServers;if(e&&e.length>0){var t=null;try{var o=localStorage.getItem("webdav.latestUrl")}catch(s){console.warn(s)}var r;for(r=0;r<e.length;r++)if(o&&o.indexOf(e[r])===0){t=e[r];break}if(!t&&e.length===1&&(t=e[0],o=t),t)try{localStorage.setItem("webdav.latestRootUrl",t),localStorage.setItem("webdav.latestUrl",o)}catch(s){console.warn(s)}}n.enforcedServersProcessed=!0}setTimeout(p,0),E(UsersManager.editorURL)&&goog.events.listen(workspace,sync.api.Workspace.EventType.BEFORE_EDITOR_LOADED,function(e){e.options.sharedSessionCompatible=!0})})();})();
